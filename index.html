<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Maniatis Planning — Luxe Edition</title>
<link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAHWUlEQVR4nO2aXYhdVxXHf2vte+dOk2nGyXzcuU2qFqxatFSdIkWpUV+KBVuKtChGRMXX0icL4gdtQR8KQpH2QVBQfBD7UhW0ij4MRRHLNBSktRFtUtpmJvPV6SSZj3v3+vtwzkyH6STTae4xCb1/OHDvWWfvvfb/rL3W2msf6KGHHnrooYd3LOwyGl+XWoEq4VvG2jrR2OE5yme1g/yKgwO1C8gTsA/YfwF5pajSApzyDTabzQ/XzYbbuf2ZlPxTbn41YBFhQF0gx5bMyCGdM/RYttV/TE+fmd3aTxWoigAD1Boe/qCl9G2cO5PZgUBtN6uDIQn3wuLNjFDgBQMgiIj/CD1yamb2xxSWkKtStNtwQK1W62NJ+UkzHwnFGTMbwAwUkjgDZEmvRuhYze1ZmXWQ5SC+4NgnzS0BhPS9V6dPP0RFJFRBgAE6ND72gru/X9Ia0IiI37v7y+vt9al2XvnDgQON5Xxyae1lWNnW3lvN0fvd7PtgDpqjE0demZv7NxUshws5qLcDAzQwMDAKHJAiQix2Ih89fXr+L1sfXFxc3WxzBNIZsKnif+fUzOwPW2OjH0nJ7nFPrbZ0G1AJAb77I3tHarevlsDdPWf9oJx8moA6hSnblkuT0JmCNsXlgKuTH5B0WpIMfbHsutNtXSshIPr6lgzaErjFS5STLieZKWL8xrUdGYjphYXnMM5Kws2vpSKH3W0CBLC8vLyIW7u4ZUcpzHavDiwh1oUCOy9ZF40qLMCAiMjHzYxkfks5zl4nkCWdTeYJVWOpUA0BCUCh34KQMdoaO3hHKduL0zU3Gy1+VZcIVUGAAJLXXoisTkqpYV77+EV2WNlGqQoCMmCvzMw8FfA8EkhfarVa+yi8+Ft1ZgJWMSPnOF6BnkBFUaDsty3pmCS5++HV1dXrStluBBjA4ODgkEQ/gEVMlrKub44qcy4AyvFTczeD1N9X24jlu41pAEm6HmMIwGt9x7fKuomqCBCAUvulnPMpc8eMD/HGPn9XnRr9fTe520COWF5ZX39pa7/dRFUEBFCbmVk6IfE3AMM+22wOvpfCR5zXlCfKt+zJR90chY4vLCxMUdzv+mao0iUAEIpjIeFmgxHp+t2eH9iwHlGTGW68TjHxSnStJA84UsR7B7wTa79WRFuQ6+5f3aWtTRaRIkWOCSTaOZ6pQMdNVBIGy0msAxFRn5F0ApAVOT3sspaHhoYGPPnNALL4YwU6bqJrBNxdbngOt8a+fHh87JFWc+zh8ZGR2xcWFl6X9ISZJUk3tEYGJyh8xHn9QKPR6HN4lyT6vO+1bum4E7pVD/DHIQ6Njd1o5r/EIHfiLq/VngYw9yVJllIakTeuBTac2o5YWVnZP3BVw4nI7bX29oJJV9EtCzBAa9G+QVJIcVbSn6enp2cBVtbO/kbSMqDc6dxQttlpGRQhMPFRd2uE4sVznc6pCzx/0egWAUX+n/pOFGUsu8oi7qAsety7ePY5zM6YmZmlO8s2O21wiiSo3nerezKwfy4vL89TYWW4qwQAL4byieTm9Xq6E9CRI6QHAGX9FwlLPrytzSY2coDkvt8M3P318n5l5wNdI+AI1GZmZk4je0rF1G49ePDgocnJosITxJOYQURj375942W7nf2AMEmIoqepLim5E7oWBSbLN9pRfrLYAFmrr692D29sjzfS2eGBgatu2Wn8qY0kiBgoa0CVnxd2Mw8IgJznfxcRc4hI4r6hIQYBz6CIwFPaV0/pPWWb7RYQABF4IbE6YBNdVHI7ukmA7oY0P89yYD8XOGbXNGrDDwIhdRYjYg3AyxLXxJsJcACDM2BYWQscqCgCbA7YLTxeKhqsPRrSAqZOSumb7261JqQ8XxyLIZ1n3M2NkFkNiYi4qTXQGpncWyFlT+h2KhxAmplZOpEVDxhWB/OIzhNuta8Jlg0sF6dFbH+zU+USaIeez0Uh5Ubrb2+kz1fMZiiA1N+//yeR89/NaMhsNJl9xd0HOzm/1j63+ieAyTfH9gBYa7d/pYg1MyObPlGBjpuoqiiqkydPrraV75eU3a3h7v054uWcO0fnlpePU5bPd+qg0WjMheJfZkYtpW9QYR5Q5fcBCcjN5vCnPfzzOOdidf1nM0tLL3LhzK4OtMfHxr5TS/4gipWcddup2dm/lu0qOSavCjsRvJvVOcDw8PAHrmmOLV57zbhaYyOPvsW2e0bVFSFRWELijSLJbjl9AD4/P/+CFE9IUkrpaLM5eN2GrJsKVl4SozDZTBHK3uqGxgCX6zFJ62Z2tVv9u6XsiiPg7SADNj09/3SWfiHJDL9rfHj4ZsqSWbcGulwJgGL5mKfOQyEtGhzwuj8M72vcXcgv9TeO/xckgNbo6LcOt5pxqNXU2MjIfVtlF4vL2QKgdHqnZmd/pMjPuhn1mt3ezQEudwJEeSCizNcl2oZvpM9dWQKXOwFQOsRX5+aOra+374U4UN6/JN8WX0o44OMjQ58r/78jnGAPO+BKWLY99NBDDz300EMPlz/+B52tJyuTuLY6AAAAAElFTkSuQmCC" />
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
<style>
:root {
  --bg-warm: #FAF8F5; --glass-bg: rgba(255, 255, 255, 0.65); --glass-border: 1px solid rgba(255, 255, 255, 0.5);
  --gold-primary: #B8965A; --gold-light: rgba(184, 150, 90, 0.12);
  --text-dark: #1C1917; --text-medium: #57534E; --text-light: #8A8681;
  --shadow-glass: 0 8px 32px 0 rgba(31, 38, 135, 0.07); --grid-border: rgba(0, 0, 0, 0.04);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',system-ui,sans-serif;background-color:var(--bg-warm);background-image:linear-gradient(to bottom right,#FAF8F5,#F2EFE9);color:var(--text-dark);overflow:hidden;-webkit-font-smoothing:antialiased;}
#root{width:100vw;height:100vh;}
::-webkit-scrollbar{width:6px; height:6px;} ::-webkit-scrollbar-track{background:transparent} ::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.1);border-radius:3px} ::-webkit-scrollbar-thumb:hover{background:var(--gold-primary);}
.glass-panel {background:var(--glass-bg);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border:var(--glass-border);box-shadow:var(--shadow-glass);border-radius:24px;position:relative;}
.glass-panel::before {content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,rgba(255,255,255,0.8),rgba(255,255,255,0));border-radius:24px 24px 0 0;pointer-events:none;}
.btn-dark {background:var(--text-dark);color:#FFF;border:none;border-radius:18px;padding:10px 20px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.25s ease;box-shadow:0 4px 16px rgba(0,0,0,0.1);display:inline-flex;align-items:center;gap:8px;}
.btn-dark:hover:not(:disabled) {transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.15);background:linear-gradient(45deg,var(--text-dark),#333);}
.btn-gold {background:var(--gold-primary);color:#FFF;border:none;border-radius:18px;padding:10px 20px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.25s ease;box-shadow:0 4px 16px rgba(184,150,90,0.3);display:inline-flex;align-items:center;gap:8px;}
.btn-gold:hover:not(:disabled) {background:linear-gradient(45deg,var(--gold-primary),#CAAB7A);box-shadow:0 8px 24px rgba(184,150,90,0.4);transform:translateY(-2px);}
.btn-ghost {background:rgba(255,255,255,0.5);color:var(--text-dark);border:1px solid rgba(0,0,0,0.05);border-radius:14px;padding:8px 16px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px;}
.btn-ghost:hover:not(:disabled) {border-color:var(--gold-primary);color:var(--gold-primary);background:var(--gold-light);}
.btn-dark:disabled,.btn-gold:disabled,.btn-ghost:disabled {opacity:0.5;cursor:not-allowed;transform:none;box-shadow:none;}
.input-glass {width:100%;padding:12px 16px;border-radius:16px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.5);font-size:13px;font-family:'Inter',sans-serif;outline:none;transition:all 0.2s;color:var(--text-dark);}
.input-glass:focus {border-color:var(--gold-primary);background:#FFF;box-shadow:0 0 0 3px var(--gold-light);}
.cal-cell {border-bottom:1px solid var(--grid-border);border-left:1px solid var(--grid-border);transition:background 0.2s;}
.cal-cell:hover {background:rgba(255,255,255,0.8) !important;}
.rdv-card {border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.05);border:1px solid rgba(255,255,255,0.6);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);transition:transform 0.2s,box-shadow 0.2s;}
.rdv-card:hover {transform:translateY(-2px) scale(1.02);box-shadow:0 6px 16px rgba(0,0,0,0.1);z-index:50 !important;}
@keyframes slideDown {from{opacity:0;transform:translateX(-50%) translateY(-20px);} to{opacity:1;transform:translateX(-50%) translateY(0);}}
@keyframes spin {to{transform:rotate(360deg);}}
</style>
</head>
<body>
<div id="root"></div>
<script>window.onerror=function(m,s,l,c,e){document.getElementById('root').innerHTML='<pre style="color:red;padding:20px">'+m+'\nLine: '+l+', Col: '+c+'</pre>';}</script>
<script type="text/babel">
const { useState, useMemo, useEffect, useRef, useCallback } = React;
function SvgIcon({size=24,color="currentColor",sw=2,children,...p}){return(<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth={sw} strokeLinecap="round" strokeLinejoin="round" {...p}>{children}</svg>);}
function ChevronLeft(p){return <SvgIcon {...p}><path d="M15 18l-6-6 6-6"/></SvgIcon>;}
function ChevronRight(p){return <SvgIcon {...p}><path d="M9 18l6-6-6-6"/></SvgIcon>;}
function Plus(p){return <SvgIcon {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></SvgIcon>;}
function X(p){return <SvgIcon {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></SvgIcon>;}
function Search(p){return <SvgIcon {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></SvgIcon>;}
function Scissors(p){return <SvgIcon {...p}><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M20 4L8.12 15.88"/><path d="M14.47 14.48L20 20"/><path d="M8.12 8.12L12 12"/></SvgIcon>;}
function Users(p){return <SvgIcon {...p}><path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></SvgIcon>;}
function Calendar(p){return <SvgIcon {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></SvgIcon>;}
function User(p){return <SvgIcon {...p}><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></SvgIcon>;}
function Phone(p){return <SvgIcon {...p}><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6A19.79 19.79 0 012.12 4.11 2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.362 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.338 1.85.573 2.81.7A2 2 0 0122 16.92z"/></SvgIcon>;}
function Edit(p){return <SvgIcon {...p}><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></SvgIcon>;}
function Trash2(p){return <SvgIcon {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></SvgIcon>;}
function Mail(p){return <SvgIcon {...p}><rect width="20" height="16" x="2" y="4" rx="2"/><polyline points="22 7 12 13 2 7"/></SvgIcon>;}
function Save(p){return <SvgIcon {...p}><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></SvgIcon>;}
function Check(p){return <SvgIcon {...p}><polyline points="20 6 9 17 4 12"/></SvgIcon>;}
function Eye(p){return <SvgIcon {...p}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></SvgIcon>;}
function EyeOff(p){return <SvgIcon {...p}><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></SvgIcon>;}
function BarChart3(p){return <SvgIcon {...p}><rect width="4" height="14" x="3" y="8" rx="1"/><rect width="4" height="8" x="10" y="14" rx="1"/><rect width="4" height="18" x="17" y="4" rx="1"/></SvgIcon>;}
function TrendingUp(p){return <SvgIcon {...p}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></SvgIcon>;}
function DollarSign(p){return <SvgIcon {...p}><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></SvgIcon>;}
function PieChart(p){return <SvgIcon {...p}><path d="M21.21 15.89A10 10 0 118 2.83"/><path d="M22 12A10 10 0 0012 2v10z"/></SvgIcon>;}
function Activity(p){return <SvgIcon {...p}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></SvgIcon>;}
function Store(p){return <SvgIcon {...p}><path d="M3 9l1-4h16l1 4"/><path d="M3 9v10a1 1 0 001 1h16a1 1 0 001-1V9"/><path d="M3 9h18"/><path d="M7.5 9v2a2.5 2.5 0 005 0V9"/><path d="M11.5 9v2a2.5 2.5 0 005 0V9"/></SvgIcon>;}
function Clock(p){return <SvgIcon {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></SvgIcon>;}
function Filter(p){return <SvgIcon {...p}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></SvgIcon>;}
function AlertTriangle(p){return <SvgIcon {...p}><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></SvgIcon>;}
function ArrowLeft(p){return <SvgIcon {...p}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></SvgIcon>;}

const T = { bg:"transparent",surface:"var(--glass-bg)",surface2:"rgba(255, 255, 255, 0.4)",surface3:"rgba(255, 255, 255, 0.2)",offBg:"repeating-linear-gradient(135deg,transparent,transparent 4px,rgba(0,0,0,0.03) 4px,rgba(0,0,0,0.03) 5px)",offColor:"rgba(0,0,0,0.04)",border:"var(--glass-border)",border2:"rgba(0,0,0,0.06)",text:"var(--text-dark)",text2:"var(--text-medium)",text3:"var(--text-light)",accent:"var(--gold-primary)",accentBg:"var(--gold-primary)",dangerBg:"#FEF2F2",dangerText:"#991B1B",dangerBorder:"#FECACA",congeBg:"rgba(184, 150, 90, 0.08)",congeBgCell:"rgba(184, 150, 90, 0.04)",congeText:"#B8965A",congeBorder:"rgba(184, 150, 90, 0.2)"};

const FB_URL="https://salon-maniatis-default-rtdb.europe-west1.firebasedatabase.app";
const FB_AUTH="fqvk01y60VO7iuj1MkFGkrofwXTa1BJuIa62R4If";
const fb=path=>fetch(`${FB_URL}/${path}.json?auth=${FB_AUTH}`).then(r=>r.json());
const fbPatch=(path,data)=>fetch(`${FB_URL}/${path}.json?auth=${FB_AUTH}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});
const fbPut=(path,data)=>fetch(`${FB_URL}/${path}.json?auth=${FB_AUTH}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});
const fbDel=path=>fetch(`${FB_URL}/${path}.json?auth=${FB_AUTH}`,{method:"DELETE"});
const fbMultiPatch=updates=>fetch(`${FB_URL}/.json?auth=${FB_AUTH}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(updates)});
const fbObj2Arr=(obj,idKey="id")=>obj?Object.entries(obj).map(([k,v])=>({...v,[idKey]:v[idKey]||k})):[];
const N8N_GCAL_URL="https://champain.app.n8n.cloud/webhook/planning-gcal-sync";
async function gcalSync(action,data){try{const r=await fetch(N8N_GCAL_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action,...data})});return await r.json();}catch(e){return{success:false};}}
function genRdvId(){const n=new Date();const p=s=>String(s).padStart(2,"0");return`RDV${n.getFullYear()}${p(n.getMonth()+1)}${p(n.getDate())}${p(n.getHours())}${p(n.getMinutes())}${p(n.getSeconds())}${String(Math.floor(Math.random()*1000)).padStart(3,"0")}`;}

function transformSalon(cfg,coiffeurs){
  const jf=(cfg?.jours_fermes||"lundi,dimanche").split(",").map(s=>s.trim().toLowerCase());
  const ho=cfg?.horaires_ouverture||{};const times=Object.values(ho).map(v=>{const[d,f]=v.split("-");return{d,f};});
  const ouv=times.length?times.reduce((a,b)=>a.d<b.d?a:b).d:"09:30",fer=times.length?times.reduce((a,b)=>a.f>b.f?a:b).f:"19:00";
  const specs=[...new Set((coiffeurs||[]).flatMap(c=>c.specialisations||[]))].sort();
  return{ouverture:ouv,fermeture:fer,jours_fermes:jf,pause:cfg?.pause||"12:30-13:30",specialisations:specs.length?specs:["femme","homme","enfant","coloriste","barbier"],fermetures_annuelles:cfg?.fermetures_annuelles||[],nom:cfg?.nom_salon||"Maniatis",adresse:cfg?.adresse||"",accentColor:cfg?.accentColor||"#B8965A"};
}
function transformCoiffeurs(obj){
  const arr=fbObj2Arr(obj).filter(c=>!!c.prenom).map(c=>({...c,specialisations:c.specialisations||[],conges:c.conges||[],actif:c.actif!==false,couleur:c.couleur||"#B8965A",horaires:c.horaires||{},pause_dejeuner:c.pause_dejeuner||"12:30-13:30"})).sort((a,b)=>(a.ordre_affichage||99)-(b.ordre_affichage||99));
  let maxO=Math.max(0,...arr.filter(c=>c.ordre_affichage&&c.ordre_affichage<90).map(c=>c.ordre_affichage));
  arr.forEach(c=>{if(!c.ordre_affichage||c.ordre_affichage>=90){maxO++;c.ordre_affichage=maxO;}});return arr.sort((a,b)=>a.ordre_affichage-b.ordre_affichage);
}
function transformPrestations(obj){return fbObj2Arr(obj).map(p=>({...p,specialisation:p.specialisation_requise||p.specialisation||"",actif:p.actif!==false})).sort((a,b)=>(a.ordre_affichage||99)-(b.ordre_affichage||99));}
function transformClients(obj){return fbObj2Arr(obj).map(c=>({...c,coiffeur_prefere:c.coiffeur_habituel_id||c.coiffeur_prefere||"",nombre_visites:c.nombre_visites||0}));}
function transformRdvs(obj){return fbObj2Arr(obj);}

const COLORS=["#B8965A","#A08C6C","#8C7A5E","#D4B87A","#C6A66D","#ef4444","#f97316","#f59e0b","#84cc16","#22c55e","#10b981","#14b8a6","#0ea5e9","#3b82f6","#6366f1","#8b5cf6","#a855f7","#d946ef","#ec4899","#f43f5e","#be185d","#9f1239","#1e3a5f","#3f3f46","#18181b"];
const SPECIALISATIONS_LIST=["femme","homme","enfant","coloriste","barbier"];
const JOURS=["dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"],JALL=["lundi","mardi","mercredi","jeudi","vendredi","samedi","dimanche"],JC=["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"],MOIS=["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
function wkStart(d){const r=new Date(d);r.setDate(d.getDate()-((d.getDay()+6)%7));r.setHours(0,0,0,0);return r;}
function wkDays(d){const s=wkStart(d);return Array.from({length:7},(_,i)=>{const r=new Date(s);r.setDate(s.getDate()+i);return r;});}
function same(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();}
function fd(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
function ft(h,m){return`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;}
function mGrid(d){const f=new Date(d.getFullYear(),d.getMonth(),1),l=new Date(d.getFullYear(),d.getMonth()+1,0),sd=(f.getDay()+6)%7,ds=[];for(let i=0;i<sd;i++){const x=new Date(f);x.setDate(f.getDate()-(sd-i));ds.push(x);}for(let i=1;i<=l.getDate();i++)ds.push(new Date(d.getFullYear(),d.getMonth(),i));while(ds.length%7!==0){const x=new Date(l);x.setDate(l.getDate()+(ds.length-sd-l.getDate()+1));ds.push(x);}return ds;}
function cLabel(c){return c?`${c.prenom||""} ${(c.nom||"?").charAt(0)}.`:"?";}
function openDays(currentDate,salon){const all=wkDays(currentDate);const closed=salon?.jours_fermes||[];return all.filter(d=>!closed.includes(JOURS[d.getDay()]));}
function parseH(t){const[h,m]=(t||"09:00").split(":").map(Number);return{h,m};}
function isSalonFerme(d,salon){return(salon?.fermetures_annuelles||[]).includes(fd(d));}
function mkSlots(salon){const op=parseH(salon?.ouverture),cl=parseH(salon?.fermeture),startH=Math.max(0,op.h-1),endH=Math.min(23,cl.h+1),s=[];for(let h=startH;h<=endH;h++)for(let m=0;m<60;m+=30)s.push({h,m,label:ft(h,m)});return s;}
function mkTimes(salon){const op=parseH(salon?.ouverture),cl=parseH(salon?.fermeture),startH=Math.max(0,op.h-1),endH=Math.min(23,cl.h+1),t=[];for(let h=startH;h<=endH;h++)for(let m=0;m<60;m+=15)t.push({value:ft(h,m),label:ft(h,m)});return t;}
function offStyle(d,c,h,m,sc,T){const jourFr=JOURS[d.getDay()],jourH=c.horaires?.[jourFr];if(!jourH||!jourH.debut||!jourH.fin)return T.offBg;if(typeof h==='undefined')return null;const s0=h*60+(m||0),s1=s0+(sc||15),[dH,dM]=jourH.debut.split(':').map(Number),[fH,fM]=jourH.fin.split(':').map(Number),deb=dH*60+dM,fin=fH*60+fM,dur=s1-s0;if(s1<=deb||s0>=fin)return T.offBg;if(s0>=deb&&s1<=fin)return null;if(s0<deb)return`linear-gradient(to bottom,${T.offColor} ${Math.round((deb-s0)/dur*100)}%,transparent ${Math.round((deb-s0)/dur*100)}%)`;if(s1>fin)return`linear-gradient(to bottom,transparent ${Math.round((fin-s0)/dur*100)}%,${T.offColor} ${Math.round((fin-s0)/dur*100)}%)`;return null;}
function isOffSlot(d,c,h,m,sc){return offStyle(d,c,h,m,sc,{offBg:"x",offColor:"x"})!==null;}
function allOffStyle(d,h,m,coiffeurs,cf,sc,T){if(cf.length!==1)return null;const c=coiffeurs.find(x=>x.id===cf[0]&&x.actif);return c?offStyle(d,c,h,m,sc,T):null;}

function Modal({open,onClose,title,children,width,T}){if(!open)return null;return(<div style={{position:"fixed",inset:0,zIndex:1000,display:"flex",alignItems:"center",justifyContent:"center"}} onClick={onClose}><div style={{position:"absolute",inset:0,background:"rgba(250, 248, 245, 0.4)",backdropFilter:"blur(8px)"}}/><div className="glass-panel" onClick={e=>e.stopPropagation()} style={{position:"relative",width:width||500,maxWidth:"95vw",maxHeight:"90vh",overflow:"auto"}}><div style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"24px",borderBottom:`1px solid rgba(0,0,0,0.05)`}}><h2 style={{fontSize:18,fontWeight:700,color:T.text,margin:0}}>{title}</h2><button onClick={onClose} style={{background:"rgba(0,0,0,0.05)",border:"none",cursor:"pointer",padding:8,borderRadius:12,color:T.text,display:"flex",transition:"background 0.2s"}} onMouseEnter={e=>e.currentTarget.style.background="rgba(0,0,0,0.1)"} onMouseLeave={e=>e.currentTarget.style.background="rgba(0,0,0,0.05)"}><X size={16}/></button></div><div style={{padding:24}}>{children}</div></div></div>);}
function ConfirmDialog({open,onConfirm,onCancel,title,message,confirmLabel,T}){if(!open)return null;return(<div style={{position:"fixed",inset:0,zIndex:1100,display:"flex",alignItems:"center",justifyContent:"center"}} onClick={onCancel}><div style={{position:"absolute",inset:0,background:"rgba(250, 248, 245, 0.4)",backdropFilter:"blur(8px)"}}/><div className="glass-panel" onClick={e=>e.stopPropagation()} style={{position:"relative",width:400,maxWidth:"90vw",overflow:"hidden"}}><div style={{padding:"32px 32px 0",textAlign:"center"}}><div style={{width:56,height:56,borderRadius:16,background:T.dangerBg,display:"inline-flex",alignItems:"center",justifyContent:"center",marginBottom:16}}><AlertTriangle size={26} color={T.dangerText}/></div><h3 style={{fontSize:18,fontWeight:700,color:T.text,margin:"0 0 12px"}}>{title||"Confirmer"}</h3><p style={{fontSize:14,color:T.text2,lineHeight:1.5,margin:0}}>{message}</p></div><div style={{display:"flex",gap:12,padding:"24px 32px 32px",justifyContent:"center"}}><button onClick={onCancel} className="btn-ghost" style={{flex:1,justifyContent:"center",padding:"12px",fontSize:14}}>Annuler</button><button onClick={onConfirm} style={{flex:1,padding:"12px",borderRadius:16,border:"none",background:"#dc2626",color:"#fff",fontSize:14,fontWeight:600,cursor:"pointer",boxShadow:"0 4px 16px rgba(220, 38, 38, 0.2)"}}>{confirmLabel||"Supprimer"}</button></div></div></div>);}
function SuccessToast({open,message,T}){if(!open)return null;return(<div className="glass-panel" style={{position:"fixed",top:24,left:"50%",transform:"translateX(-50%)",zIndex:1200,padding:"16px 24px",display:"flex",alignItems:"center",gap:12,animation:"slideDown .3s cubic-bezier(0.25, 0.8, 0.25, 1)"}}><div style={{width:36,height:36,borderRadius:12,background:"#dcfce7",display:"flex",alignItems:"center",justifyContent:"center"}}><Check size={18} color="#16a34a"/></div><span style={{fontSize:14,fontWeight:600,color:T.text}}>{message}</span></div>);}
function Inp({label,value,onChange,placeholder,type,icon:Ic,T}){return(<div style={{marginBottom:16}}>{label&&<label style={{display:"block",fontSize:11,fontWeight:700,color:T.text2,marginBottom:8,textTransform:"uppercase",letterSpacing:"0.05em"}}>{label}</label>}<div style={{position:"relative"}}>{Ic&&<Ic size={18} style={{position:"absolute",left:14,top:"50%",transform:"translateY(-50%)",color:T.text3}}/>}<input className="input-glass" type={type||"text"} value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder} style={{paddingLeft:Ic?42:16}}/></div></div>);}
function Sel({label,value,onChange,options,T}){return(<div style={{marginBottom:16}}>{label&&<label style={{display:"block",fontSize:11,fontWeight:700,color:T.text2,marginBottom:8,textTransform:"uppercase",letterSpacing:"0.05em"}}>{label}</label>}<select className="input-glass" value={value} onChange={e=>onChange(e.target.value)} style={{cursor:"pointer",appearance:"none"}}>{options.map(o=><option key={o.value} value={o.value}>{o.label}</option>)}</select></div>);}
function Btn({children,onClick,variant,icon:Ic,small,disabled,T}){const cls=variant==="ghost"?"btn-ghost":variant==="accent"?"btn-gold":"btn-dark";return(<button className={cls} onClick={onClick} disabled={disabled} style={small?{padding:"8px 16px",fontSize:12}:{}}>{Ic&&<Ic size={small?14:16}/>}{children}</button>);}
function Bdg({children,color,small,T}){return <span style={{display:"inline-flex",alignItems:"center",padding:small?"4px 10px":"6px 14px",borderRadius:20,fontSize:small?11:12,fontWeight:600,background:color?color+"15":"rgba(0,0,0,0.05)",color:color||T.text2,whiteSpace:"nowrap"}}>{children}</span>;}

function Indicators({rdvs,view,currentDate,cf,coiffeurs,salon,T}){const filtered=useMemo(()=>rdvs.filter(r=>{if(r.statut!=="confirme")return false;if(cf.length>0&&!cf.includes(r.coiffeur_id))return false;const rd=new Date(r.date_heure);if(view==="day")return same(rd,currentDate);if(view==="week"){const ws=wkStart(currentDate),we=new Date(ws);we.setDate(ws.getDate()+6);return rd>=ws&&rd<=we;}return rd.getMonth()===currentDate.getMonth()&&rd.getFullYear()===currentDate.getFullYear();}),[rdvs,view,currentDate,cf]);const nb=filtered.length,ca=filtered.reduce((s,r)=>s+r.prix_total,0),nj=view==="day"?1:view==="week"?7-(salon?.jours_fermes||[]).length:new Date(currentDate.getFullYear(),currentDate.getMonth()+1,0).getDate(),moyJ=nj>0?(ca/nj):0,vl=view==="day"?"aujourd'hui":view==="week"?"cette semaine":"ce mois",vc=coiffeurs.filter(c=>c.actif&&(cf.length===0||cf.includes(c.id)));return(<div style={{display:"flex",gap:16,flexWrap:"wrap",flexShrink:0}}><div className="glass-panel" style={{flex:"1 1 180px",minWidth:160,padding:"18px 20px",display:"flex",alignItems:"center",gap:16}}><div style={{width:48,height:48,borderRadius:16,background:"linear-gradient(135deg, #1C1917, #333)",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 4px 16px rgba(0,0,0,0.1)"}}><Calendar size={22} color="#FFF"/></div><div><div style={{fontSize:24,fontWeight:800,color:T.text,lineHeight:1}}>{nb}</div><div style={{fontSize:12,color:T.text2,fontWeight:500,marginTop:4}}>RDV {vl}</div></div></div><div className="glass-panel" style={{flex:"1 1 180px",minWidth:160,padding:"18px 20px",display:"flex",alignItems:"center",gap:16}}><div style={{width:48,height:48,borderRadius:16,background:"linear-gradient(135deg, #B8965A, #CAAB7A)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:20,fontWeight:800,color:"#fff",boxShadow:"0 4px 16px rgba(184, 150, 90, 0.3)"}}>€</div><div><div style={{fontSize:24,fontWeight:800,color:T.text,lineHeight:1}}>{ca.toLocaleString()}€</div><div style={{fontSize:12,color:T.text2,fontWeight:500,marginTop:4}}>Revenus {vl}</div>{nj>1&&<div style={{fontSize:10,color:T.accent,fontWeight:600,marginTop:2}}>Moy. {Math.round(moyJ)}€/j</div>}</div></div>{vc.map(c=>{const cnt=filtered.filter(r=>r.coiffeur_id===c.id).length,cca=filtered.filter(r=>r.coiffeur_id===c.id).reduce((s,r)=>s+r.prix_total,0);return(<div key={c.id} className="glass-panel" style={{flex:"1 1 140px",minWidth:120,padding:"18px 20px",borderLeft:`4px solid ${c.couleur}`}}><div style={{fontSize:13,fontWeight:700,color:c.couleur,marginBottom:6}}>{cLabel(c)}</div><div style={{display:"flex",alignItems:"baseline",gap:8}}><span style={{fontSize:22,fontWeight:800,color:T.text,lineHeight:1}}>{cnt}</span><span style={{fontSize:12,color:T.text3,fontWeight:500}}>{cca}€</span></div></div>);})}</div>);}

function WeekView({currentDate,rdvs,cf,coiffeurs,onSlot,onRdv,onDragDrop,salon,T}){
  const slots=mkSlots(salon),days=openDays(currentDate,salon),H=32,[tick,setTick]=useState(Date.now()),[dragTarget,setDragTarget]=useState(null),[dragRdvId,setDragRdvId]=useState(null);useEffect(()=>{const iv=setInterval(()=>setTick(Date.now()),60000);return()=>clearInterval(iv);},[]);const n=new Date(tick);
  const isConge=(d,coifId)=>{if(isSalonFerme(d,salon))return true;return coiffeurs.find(x=>x.id===coifId)?.conges?.includes(fd(d));},isPast=(d,h,m)=>{const s=new Date(d);s.setHours(h,m,0,0);return s<n;},allConge=d=>{if(isSalonFerme(d,salon))return true;const a=coiffeurs.filter(c=>c.actif&&(cf.length===0||cf.includes(c.id)));return a.length>0&&a.every(c=>c.conges?.includes(fd(d)));};
  return(<div className="glass-panel" style={{display:"flex",flexDirection:"column",flex:1,overflow:"hidden",borderRadius:24}}><div style={{overflow:"auto",flex:1}}><div style={{display:"grid",gridTemplateColumns:`60px repeat(${days.length},1fr)`,minWidth:800,position:"sticky",top:0,zIndex:30,background:"rgba(250, 248, 245, 0.85)",backdropFilter:"blur(12px)",borderBottom:`1px solid rgba(0,0,0,0.05)`}}><div style={{padding:8}}/>{days.map(d=>{const isToday=same(d,n),ac=allConge(d);return(<div key={fd(d)} style={{padding:"14px 8px",textAlign:"center",position:"relative",background:isToday?"rgba(184, 150, 90, 0.05)":ac?T.congeBg:"transparent"}}><div style={{fontSize:11,fontWeight:700,color:isToday?T.accent:T.text3,textTransform:"uppercase",letterSpacing:"0.1em"}}>{JC[d.getDay()]}</div><div style={{fontSize:22,fontWeight:800,color:isToday?T.accent:T.text,marginTop:4}}>{d.getDate()}</div>{ac&&<div style={{fontSize:9,color:T.congeText,fontWeight:700,marginTop:4}}>{isSalonFerme(d,salon)?"FERMÉ":"CONGÉ"}</div>}{isToday&&<div style={{position:"absolute",bottom:0,left:"20%",right:"20%",height:4,background:T.accent,borderRadius:"4px 4px 0 0"}}/>}</div>);})}</div>
  <div style={{position:"relative",paddingBottom:"24px"}}><div style={{display:"grid",gridTemplateColumns:`60px repeat(${days.length},1fr)`,minWidth:800,position:"relative"}}>{slots.map(({h,m,label})=>(<div key={`ws-${label}`} style={{display:"contents"}}><div style={{borderBottom:`1px solid rgba(0,0,0,0.04)`,padding:"0 12px",display:"flex",alignItems:"flex-start",justifyContent:"flex-end",fontSize:11,color:T.text3,fontWeight:600,height:H,paddingTop:4}}>{m===0?label:""}</div>{days.map(d=>{const rh=rdvs.filter(r=>{if(r.statut!=="confirme"||(cf.length>0&&!cf.includes(r.coiffeur_id)))return false;const rd=new Date(r.date_heure);return same(rd,d)&&rd.getHours()===h&&rd.getMinutes()===m;}),past=isPast(d,h,m),ac=allConge(d),offBg=!ac?allOffStyle(d,h,m,coiffeurs,cf,30,T):null,isDT=dragTarget&&dragTarget.d===fd(d)&&dragTarget.h===h&&dragTarget.m===m;let cellBg="transparent";if(isDT)cellBg="rgba(184, 150, 90, 0.1)";else if(ac)cellBg=T.congeBgCell;else if(offBg)cellBg=offBg;else if(same(d,n))cellBg=past?"rgba(0,0,0,0.02)":"rgba(184, 150, 90, 0.03)";return(<div key={`${fd(d)}-${label}`} className="cal-cell" onClick={()=>rh.length===0&&!ac&&onSlot(d,h,m)} onDragOver={e=>{e.preventDefault();e.dataTransfer.dropEffect="move";if(!ac)setDragTarget({d:fd(d),h,m});}} onDragLeave={()=>setDragTarget(null)} onDrop={e=>{e.preventDefault();const rid=e.dataTransfer.getData("rdvId");if(rid&&onDragDrop&&!ac)onDragDrop(rid,d,h,m);setDragTarget(null);setDragRdvId(null);}} style={{padding:1,height:H,cursor:ac?"not-allowed":"pointer",position:"relative",background:cellBg}}>{isDT&&dragRdvId&&(()=>{const dr=rdvs.find(r=>r.id===dragRdvId);if(!dr)return null;const endM=h*60+m+dr.duree_totale_minutes;return <div style={{position:"absolute",left:"50%",top:-4,transform:"translateX(-50%)",zIndex:25,pointerEvents:"none",background:T.accent,color:"#FFF",borderRadius:12,padding:"2px 10px",fontSize:10,fontWeight:700,whiteSpace:"nowrap",boxShadow:"0 4px 12px rgba(184, 150, 90, 0.4)"}}>{JC[d.getDay()]} {String(h).padStart(2,"0")}:{String(m).padStart(2,"0")} → {String(Math.floor(endM/60)).padStart(2,"0")}:{String(endM%60).padStart(2,"0")}</div>;})()}{rh.map(r=>{const co=coiffeurs.find(c=>c.id===r.coiffeur_id),pH=r.duree_totale_minutes/30*H,rdvPast=new Date(new Date(r.date_heure).getTime()+r.duree_totale_minutes*60000)<n,col=co?.couleur||T.text3;return(<div key={r.id} className="rdv-card" draggable={!rdvPast} onDragStart={e=>{e.dataTransfer.setData("rdvId",r.id);e.dataTransfer.effectAllowed="move";setDragRdvId(r.id);}} onDragEnd={()=>{setDragRdvId(null);setDragTarget(null);}} onClick={e=>{e.stopPropagation();onRdv(r);}} style={{position:"absolute",left:4,right:4,top:2,height:pH-4,padding:pH<35?"2px 8px":"6px 10px",cursor:rdvPast?"default":"grab",overflow:"hidden",zIndex:10,background:`linear-gradient(135deg, ${col}20, ${col}10)`,borderLeft:`4px solid ${col}`,opacity:rdvPast?0.5:1}}>{pH<35?<div style={{fontSize:11,fontWeight:700,color:col,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{r.client_prenom} {r.client_nom?.charAt(0)}. · {r.prix_total}€</div>:<><div style={{fontSize:13,fontWeight:700,color:col,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{r.client_prenom} {r.client_nom}</div><div style={{fontSize:11,color:T.text2,marginTop:2,fontWeight:500}}>{r.prestations_noms} · {r.prix_total}€</div></>}</div>);})}</div>);})}</div>))}</div>{days.some(d=>same(d,n))&&(()=>{const startH=Math.max(0,parseH(salon?.ouverture).h-1),mins=(n.getHours()-startH)*60+n.getMinutes();if(mins<0||mins>slots.length*30)return null;const top=mins/30*H,dayIdx=days.findIndex(d=>same(d,n));if(dayIdx<0)return null;const colW=100/days.length,left=dayIdx*colW;return(<div style={{position:"absolute",top,left:`calc(60px + ${left}% - 4px)`,width:`calc(${colW}% + 8px)`,zIndex:20,pointerEvents:"none"}}><div style={{display:"flex",alignItems:"center"}}><div style={{width:10,height:10,borderRadius:5,background:T.accent,boxShadow:`0 0 8px ${T.accent}80`,flexShrink:0}}/><div style={{flex:1,height:2,background:T.accent,boxShadow:`0 0 4px ${T.accent}80`}}/></div></div>);})()}</div></div></div>);}

function DayStackView({currentDate,rdvs,cf,coiffeurs,onSlot,onRdv,salon,T}){
  const slots=mkSlots(salon),H=32,[tick,setTick]=useState(Date.now());useEffect(()=>{const iv=setInterval(()=>setTick(Date.now()),60000);return()=>clearInterval(iv);},[]);const n=new Date(tick),isToday=same(currentDate,n),isPast=(h,m)=>{if(!isToday)return currentDate<n;const s=new Date(currentDate);s.setHours(h,m,0,0);return s<n;},allConge=()=>{if(isSalonFerme(currentDate,salon))return true;const a=coiffeurs.filter(c=>c.actif&&(cf.length===0||cf.includes(c.id)));return a.length>0&&a.every(c=>c.conges?.includes(fd(currentDate)));},ac=allConge();
  return(<div className="glass-panel" style={{display:"flex",flexDirection:"column",flex:1,overflow:"hidden",borderRadius:24}}><div style={{overflow:"auto",flex:1}}><div style={{display:"grid",gridTemplateColumns:"60px 1fr",position:"sticky",top:0,zIndex:30,background:"rgba(250, 248, 245, 0.85)",backdropFilter:"blur(12px)",borderBottom:`1px solid rgba(0,0,0,0.05)`}}><div style={{padding:8}}/><div style={{padding:"14px 20px",display:"flex",alignItems:"center",gap:16}}><div style={{textAlign:"center"}}><div style={{fontSize:11,fontWeight:700,color:isToday?T.accent:T.text3,textTransform:"uppercase",letterSpacing:"0.1em"}}>{JC[currentDate.getDay()]}</div><div style={{fontSize:26,fontWeight:800,color:isToday?T.accent:T.text}}>{currentDate.getDate()}</div></div><div style={{display:"flex",gap:8,flexWrap:"wrap"}}>{coiffeurs.filter(c=>c.actif&&(cf.length===0||cf.includes(c.id))).map(c=>{const cg=isSalonFerme(currentDate,salon)||c.conges?.includes(fd(currentDate));return(<div key={c.id} style={{display:"flex",alignItems:"center",gap:6,padding:"6px 12px",borderRadius:12,background:cg?T.congeBg:`${c.couleur}15`,border:`1px solid ${cg?T.congeBorder:c.couleur+"30"}`}}><div style={{width:8,height:8,borderRadius:4,background:cg?T.congeText:c.couleur}}/><span style={{fontSize:12,fontWeight:600,color:cg?T.congeText:c.couleur}}>{cLabel(c)}{cg?" (congé)":""}</span></div>);})}</div>{ac&&<span style={{fontSize:12,color:T.congeText,fontWeight:800,background:T.congeBg,borderRadius:8,padding:"6px 14px"}}>JOURNÉE CONGÉ</span>}</div></div><div style={{position:"relative",paddingBottom:"24px"}}><div style={{display:"grid",gridTemplateColumns:"60px 1fr"}}>{slots.map(({h,m,label})=>{const rh=rdvs.filter(r=>{if(r.statut!=="confirme"||(cf.length>0&&!cf.includes(r.coiffeur_id)))return false;const rd=new Date(r.date_heure);return same(rd,currentDate)&&rd.getHours()===h&&rd.getMinutes()===m;}),past=isPast(h,m),offBg=!ac?allOffStyle(currentDate,h,m,coiffeurs,cf,30,T):null;let cellBg="transparent";if(ac)cellBg=T.congeBgCell;else if(offBg)cellBg=offBg;else if(isToday)cellBg=past?"rgba(0,0,0,0.02)":"rgba(184, 150, 90, 0.03)";return(<div key={`dss-${label}`} style={{display:"contents"}}><div style={{borderBottom:`1px solid rgba(0,0,0,0.04)`,padding:"0 12px",display:"flex",alignItems:"flex-start",justifyContent:"flex-end",fontSize:11,color:T.text3,fontWeight:600,height:H,paddingTop:4}}>{m===0?label:""}</div><div className="cal-cell" onClick={()=>!ac&&rh.length===0&&onSlot(currentDate,h,m)} style={{padding:2,height:H,cursor:ac?"not-allowed":"pointer",position:"relative",background:cellBg}}>{rh.map(r=>{const co=coiffeurs.find(c=>c.id===r.coiffeur_id),pH=r.duree_totale_minutes/30*H,rdvPast=new Date(new Date(r.date_heure).getTime()+r.duree_totale_minutes*60000)<n,col=co?.couleur||T.text3;return(<div key={r.id} className="rdv-card" onClick={e=>{e.stopPropagation();onRdv(r);}} style={{position:"absolute",left:8,right:8,top:2,height:pH-4,padding:pH<35?"2px 12px":"8px 14px",cursor:"pointer",overflow:"hidden",zIndex:10,background:`linear-gradient(135deg, ${col}20, ${col}10)`,borderLeft:`4px solid ${col}`,opacity:rdvPast?0.5:1}}>{pH<35?<div style={{fontSize:12,fontWeight:700,color:col,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{r.client_prenom} {r.client_nom?.charAt(0)}. <span style={{color:T.text2,fontWeight:500}}>· {r.prestations_noms} · {r.prix_total}€</span></div>:<><div style={{fontSize:14,fontWeight:800,color:col}}>{r.client_prenom} {r.client_nom}</div><div style={{fontSize:12,color:T.text2,marginTop:4,fontWeight:500}}>{r.prestations_noms} · {r.prix_total}€ — <span style={{color:col}}>{cLabel(co)}</span></div></>}</div>);})}</div></div>);})}</div>{isToday&&(()=>{const startH=Math.max(0,parseH(salon?.ouverture).h-1),mins=(n.getHours()-startH)*60+n.getMinutes();if(mins<0||mins>slots.length*30)return null;const top=mins/30*H;return(<div style={{position:"absolute",top,left:60,right:0,zIndex:20,pointerEvents:"none"}}><div style={{display:"flex",alignItems:"center"}}><div style={{width:10,height:10,borderRadius:5,background:T.accent,boxShadow:`0 0 8px ${T.accent}80`,flexShrink:0}}/><div style={{flex:1,height:2,background:T.accent,boxShadow:`0 0 4px ${T.accent}80`}}/></div></div>);})()}</div></div></div>);}

function DayView({currentDate,rdvs,cf,coiffeurs,onSlot,onRdv,onDragDrop,salon,T}){
  const slots=mkSlots(salon),vc=coiffeurs.filter(c=>c.actif&&(cf.length===0||cf.includes(c.id))),H=32,[tick,setTick]=useState(Date.now()),[dragTarget,setDragTarget]=useState(null),[dragRdvId,setDragRdvId]=useState(null);useEffect(()=>{const iv=setInterval(()=>setTick(Date.now()),60000);return()=>clearInterval(iv);},[]);const n=new Date(tick),isToday=same(currentDate,n),isConge=coifId=>{if(isSalonFerme(currentDate,salon))return true;return coiffeurs.find(x=>x.id===coifId)?.conges?.includes(fd(currentDate));},isPast=(h,m)=>{if(!isToday)return currentDate<n;const s=new Date(currentDate);s.setHours(h,m,0,0);return s<n;};
  return(<div className="glass-panel" style={{display:"flex",flexDirection:"column",flex:1,overflow:"hidden",borderRadius:24}}><div style={{overflow:"auto",flex:1}}><div style={{display:"grid",gridTemplateColumns:`60px repeat(${vc.length},1fr)`,minWidth:Math.max(400,vc.length*180+60),position:"sticky",top:0,zIndex:30,background:"rgba(250, 248, 245, 0.85)",backdropFilter:"blur(12px)",borderBottom:`1px solid rgba(0,0,0,0.05)`}}><div style={{padding:8}}/>{vc.map(c=>{const cg=isConge(c.id);return(<div key={c.id} style={{padding:"14px 8px",textAlign:"center",position:"relative"}}><div style={{width:40,height:40,borderRadius:12,background:cg?T.congeBg:c.couleur+"20",color:cg?T.congeText:c.couleur,display:"inline-flex",alignItems:"center",justifyContent:"center",fontSize:16,fontWeight:800}}>{(c.prenom||"?").charAt(0)}</div><div style={{fontSize:14,fontWeight:700,color:cg?T.congeText:T.text,marginTop:6}}>{cLabel(c)}</div>{cg&&<div style={{fontSize:10,color:T.congeText,fontWeight:700,background:T.congeBg,borderRadius:6,padding:"2px 8px",display:"inline-block",marginTop:4}}>En congé</div>}</div>);})}</div><div style={{position:"relative",paddingBottom:"24px"}}><div style={{display:"grid",gridTemplateColumns:`60px repeat(${vc.length},1fr)`,minWidth:Math.max(400,vc.length*180+60)}}>{slots.map(({h,m,label})=>(<div key={`ds-${label}`} style={{display:"contents"}}><div style={{borderBottom:`1px solid rgba(0,0,0,0.04)`,padding:"0 12px",display:"flex",alignItems:"flex-start",justifyContent:"flex-end",fontSize:11,color:T.text3,fontWeight:600,height:H,paddingTop:4}}>{m===0?label:""}</div>{vc.map(c=>{const cg=isConge(c.id),past=isPast(h,m),offBg=!cg?offStyle(currentDate,c,h,m,30,T):null,rh=rdvs.filter(r=>{if(r.statut!=="confirme"||r.coiffeur_id!==c.id)return false;const rd=new Date(r.date_heure);return same(rd,currentDate)&&rd.getHours()===h&&rd.getMinutes()===m;}),bg=cg?T.congeBgCell:offBg||(past?"rgba(0,0,0,0.02)":"transparent"),isDT=dragTarget&&dragTarget.c===c.id&&dragTarget.h===h&&dragTarget.m===m;return(<div key={`${c.id}-${label}`} className="cal-cell" onClick={()=>!cg&&rh.length===0&&onSlot(currentDate,h,m,c.id)} onDragOver={e=>{e.preventDefault();e.dataTransfer.dropEffect="move";if(!cg)setDragTarget({c:c.id,h,m});}} onDragLeave={()=>setDragTarget(null)} onDrop={e=>{e.preventDefault();const rid=e.dataTransfer.getData("rdvId");if(rid&&onDragDrop&&!cg)onDragDrop(rid,currentDate,h,m,c.id);setDragTarget(null);setDragRdvId(null);}} style={{padding:1,height:H,cursor:cg?"not-allowed":"pointer",position:"relative",background:isDT?"rgba(184, 150, 90, 0.1)":bg}}>{isDT&&dragRdvId&&(()=>{const dr=rdvs.find(r=>r.id===dragRdvId);if(!dr)return null;const endM=h*60+m+dr.duree_totale_minutes;return <div style={{position:"absolute",left:"50%",top:-4,transform:"translateX(-50%)",zIndex:25,pointerEvents:"none",background:T.accent,color:"#fff",borderRadius:12,padding:"2px 10px",fontSize:10,fontWeight:700,whiteSpace:"nowrap",boxShadow:"0 4px 12px rgba(184, 150, 90, 0.4)"}}>{c.prenom} · {String(h).padStart(2,"0")}h{String(m).padStart(2,"0")} → {String(Math.floor(endM/60)).padStart(2,"0")}:{String(endM%60).padStart(2,"0")}</div>;})()}{rh.map(r=>{const pH=r.duree_totale_minutes/30*H,rdvPast=new Date(new Date(r.date_heure).getTime()+r.duree_totale_minutes*60000)<n;return(<div key={r.id} className="rdv-card" draggable={!rdvPast} onDragStart={e=>{e.dataTransfer.setData("rdvId",r.id);e.dataTransfer.effectAllowed="move";setDragRdvId(r.id);}} onDragEnd={()=>{setDragRdvId(null);setDragTarget(null);}} onClick={e=>{e.stopPropagation();onRdv(r);}} style={{position:"absolute",left:4,right:4,top:2,height:pH-4,padding:pH<35?"2px 8px":"6px 12px",cursor:rdvPast?"default":"grab",overflow:"hidden",zIndex:10,background:`linear-gradient(135deg, ${c.couleur}20, ${c.couleur}10)`,borderLeft:`4px solid ${c.couleur}`,opacity:rdvPast?0.5:1}}>{pH<35?<div style={{fontSize:11,fontWeight:700,color:c.couleur,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{r.client_prenom} {r.client_nom?.charAt(0)}. · {r.prestations_noms} · {r.prix_total}€</div>:<><div style={{fontSize:13,fontWeight:700,color:c.couleur}}>{r.client_prenom} {r.client_nom}</div><div style={{fontSize:11,color:T.text2,marginTop:2}}>{r.prestations_noms} · {r.prix_total}€</div></>}</div>);})}</div>);})}</div>))}</div>{isToday&&(()=>{const startH=Math.max(0,parseH(salon?.ouverture).h-1),mins=(n.getHours()-startH)*60+n.getMinutes();if(mins<0||mins>slots.length*30)return null;const top=mins/30*H;return(<div style={{position:"absolute",top,left:60,right:0,zIndex:20,pointerEvents:"none"}}><div style={{display:"flex",alignItems:"center"}}><div style={{width:10,height:10,borderRadius:5,background:T.accent,boxShadow:`0 0 8px ${T.accent}80`,flexShrink:0}}/><div style={{flex:1,height:2,background:T.accent,boxShadow:`0 0 4px ${T.accent}80`}}/></div></div>);})()}</div></div></div>);}

function WeekSbsView({currentDate,rdvs,cf,coiffeurs,onSlot,onRdv,salon,T}){
  const slots=mkSlots(salon),days=openDays(currentDate,salon),H=32,vc=coiffeurs.filter(c=>c.actif&&(cf.length===0||cf.includes(c.id))),[tick,setTick]=useState(Date.now());useEffect(()=>{const iv=setInterval(()=>setTick(Date.now()),60000);return()=>clearInterval(iv);},[]);const n=new Date(tick),totalCols=days.length*vc.length,isConge=(d,coifId)=>{if(isSalonFerme(d,salon))return true;return coiffeurs.find(x=>x.id===coifId)?.conges?.includes(fd(d));},minW=Math.max(800,totalCols*60+60);
  return(<div className="glass-panel" style={{display:"flex",flexDirection:"column",flex:1,overflow:"hidden",borderRadius:24}}><div style={{overflow:"auto",flex:1}}><div style={{position:"sticky",top:0,zIndex:30,background:"rgba(250, 248, 245, 0.85)",backdropFilter:"blur(12px)",borderBottom:`1px solid rgba(0,0,0,0.05)`,minWidth:minW}}><div style={{display:"grid",gridTemplateColumns:`60px repeat(${days.length},${vc.length}fr)`}}><div/>{days.map(d=>{const isToday=same(d,n);return(<div key={`dl-${fd(d)}`} style={{textAlign:"center",padding:"8px 4px 4px",borderLeft:`3px solid rgba(0,0,0,0.08)`,background:isToday?"rgba(184, 150, 90, 0.05)":"transparent"}}><span style={{fontSize:12,fontWeight:800,color:isToday?T.accent:T.text,textTransform:"uppercase",letterSpacing:"0.06em"}}>{JC[d.getDay()]}</span><span style={{fontSize:16,fontWeight:800,color:isToday?T.accent:T.text,marginLeft:6}}>{d.getDate()}</span></div>);})}</div><div style={{display:"grid",gridTemplateColumns:`60px repeat(${totalCols},1fr)`}}><div/>{days.map((d,di)=>vc.map((c,ci)=>{const isToday=same(d,n),cg=isConge(d,c.id);return(<div key={`ci-${fd(d)}-${c.id}`} style={{padding:"4px 2px 6px",textAlign:"center",borderLeft:ci===0?`3px solid rgba(0,0,0,0.08)`:`1px solid rgba(0,0,0,0.04)`,background:isToday?"rgba(184, 150, 90, 0.05)":"transparent",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:2}}><div style={{width:24,height:24,borderRadius:8,background:cg?T.congeBg:c.couleur+"20",color:cg?T.congeText:c.couleur,display:"inline-flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:800}}>{(c.prenom||"?").charAt(0)}</div>{cg&&<div style={{fontSize:8,color:T.congeText,fontWeight:700,lineHeight:1}}>congé</div>}</div>);}))}</div></div><div style={{position:"relative",paddingBottom:"24px"}}><div style={{display:"grid",gridTemplateColumns:`60px repeat(${totalCols},1fr)`,minWidth:minW,position:"relative"}}>{slots.map(({h,m,label})=>(<div key={`sbs-${label}`} style={{display:"contents"}}><div style={{borderBottom:`1px solid rgba(0,0,0,0.04)`,padding:"0 12px",display:"flex",alignItems:"flex-start",justifyContent:"flex-end",fontSize:11,color:T.text3,fontWeight:600,height:H,paddingTop:4}}>{m===0?label:""}</div>{days.map((d,di)=>vc.map((c,ci)=>{const cg=isConge(d,c.id),offBg=!cg?offStyle(d,c,h,m,30,T):null,rh=rdvs.filter(r=>{if(r.statut!=="confirme"||r.coiffeur_id!==c.id)return false;const rd=new Date(r.date_heure);return same(rd,d)&&rd.getHours()===h&&rd.getMinutes()===m;}),past=new Date(d).setHours(h,m)<n,bg=cg?T.congeBgCell:offBg||(same(d,n)&&past?"rgba(0,0,0,0.02)":same(d,n)?"rgba(184, 150, 90, 0.03)":"transparent");return(<div key={`${fd(d)}-${c.id}-${label}`} onClick={()=>!cg&&rh.length===0&&onSlot(d,h,m,c.id)} style={{borderBottom:`1px solid rgba(0,0,0,0.04)`,borderLeft:ci===0?`3px solid rgba(0,0,0,0.08)`:`1px solid rgba(0,0,0,0.04)`,padding:1,height:H,cursor:cg||offBg?"not-allowed":"pointer",position:"relative",background:bg}}>{rh.map(r=>{const pH=r.duree_totale_minutes/30*H,rdvPast=new Date(new Date(r.date_heure).getTime()+r.duree_totale_minutes*60000)<n;return(<div key={r.id} className="rdv-card" onClick={e=>{e.stopPropagation();onRdv(r);}} style={{position:"absolute",left:2,right:2,top:2,height:pH-4,padding:pH<25?"1px 4px":"4px 6px",cursor:"pointer",overflow:"hidden",zIndex:10,background:`linear-gradient(135deg, ${c.couleur}20, ${c.couleur}10)`,borderLeft:`3px solid ${c.couleur}`,opacity:rdvPast?0.5:1}}>{pH<25?<div style={{fontSize:9,fontWeight:700,color:c.couleur,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{r.client_prenom} {r.client_nom?.charAt(0)}.</div>:<><div style={{fontSize:11,fontWeight:700,color:c.couleur,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{r.client_prenom} {r.client_nom?.charAt(0)}.</div><div style={{fontSize:9,color:T.text2,marginTop:2,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{r.prix_total}€</div></>}</div>);})}</div>);}))}</div>))}</div>{days.some(d=>same(d,n))&&(()=>{const startH=Math.max(0,parseH(salon?.ouverture).h-1),mins=(n.getHours()-startH)*60+n.getMinutes();if(mins<0||mins>slots.length*30)return null;const top=mins/30*H,tdi=days.findIndex(d=>same(d,n));if(tdi<0)return null;const colStart=tdi*vc.length,colSpan=vc.length,leftPct=(colStart/totalCols)*100,widthPct=(colSpan/totalCols)*100;return(<div style={{position:"absolute",top,left:`calc(60px + ${leftPct}% - 4px)`,width:`calc(${widthPct}% + 8px)`,zIndex:20,pointerEvents:"none"}}><div style={{display:"flex",alignItems:"center"}}><div style={{width:10,height:10,borderRadius:5,background:T.accent,boxShadow:`0 0 8px ${T.accent}80`,flexShrink:0}}/><div style={{flex:1,height:2,background:T.accent,boxShadow:`0 0 4px ${T.accent}80`}}/></div></div>);})()}</div></div></div>);}

function MonthView({currentDate,rdvs,cf,coiffeurs,onDay,salon,T}){
  const grid=mGrid(currentDate),n=new Date(),allConge=d=>{if(isSalonFerme(d,salon))return true;const a=coiffeurs.filter(c=>c.actif&&(cf.length===0||cf.includes(c.id)));return a.length>0&&a.every(c=>c.conges?.includes(fd(d)));};
  return(<div className="glass-panel" style={{flex:1,padding:"16px",overflow:"auto",borderRadius:24}}><div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:8}}>{["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"].map(d=><div key={d} style={{padding:8,textAlign:"center",fontSize:12,fontWeight:700,color:T.text3,textTransform:"uppercase"}}>{d}</div>)}{grid.map((d,i)=>{const dr=rdvs.filter(r=>{if(r.statut!=="confirme"||(cf.length>0&&!cf.includes(r.coiffeur_id)))return false;return same(new Date(r.date_heure),d);}),cnt=dr.length,ca=dr.reduce((s,r)=>s+r.prix_total,0),isT=same(d,n),isCl=d.getDay()===0||d.getDay()===1,ac=allConge(d),past=d<n&&!isT;return(<div key={i} className="cal-cell" onClick={()=>!isCl&&onDay(d)} style={{padding:12,minHeight:90,background:ac?T.congeBgCell:isT?"rgba(184, 150, 90, 0.08)":d.getMonth()===currentDate.getMonth()?"rgba(255,255,255,0.4)":"transparent",border:`1px solid ${isT?T.accent+"50":"rgba(0,0,0,0.05)"}`,borderRadius:16,cursor:isCl?"default":"pointer",opacity:isCl?0.3:past?0.6:d.getMonth()===currentDate.getMonth()?1:0.4}}><div style={{display:"flex",alignItems:"center",gap:6}}><span style={{fontSize:16,fontWeight:isT?800:600,color:isT?T.accent:T.text}}>{d.getDate()}</span>{ac&&<span style={{fontSize:9,color:T.congeText,fontWeight:700,background:T.congeBg,borderRadius:6,padding:"2px 6px"}}>CONGÉ</span>}</div>{cnt>0&&<div style={{marginTop:8}}><div style={{display:"flex",gap:4,flexWrap:"wrap",marginBottom:6}}>{coiffeurs.filter(co=>co.actif&&(cf.length===0||cf.includes(co.id))).map(co=>dr.filter(r=>r.coiffeur_id===co.id).length>0?<div key={co.id} style={{width:8,height:8,borderRadius:4,background:co.couleur}}/>:null)}</div><div style={{fontSize:11,color:T.text2,fontWeight:600}}>{cnt} · {ca}€</div></div>}</div>);})}</div></div>);}

function MonthSbsView({currentDate,rdvs,cf,coiffeurs,onDay,salon,T}){
  const grid=mGrid(currentDate),n=new Date(),vc=coiffeurs.filter(c=>c.actif&&(cf.length===0||cf.includes(c.id)));
  return(<div style={{flex:1,padding:"8px 4px",overflow:"auto"}}><div style={{display:"grid",gridTemplateColumns:`repeat(${Math.min(vc.length,3)},1fr)`,gap:16}}>{vc.map(c=>{const cRdvs=rdvs.filter(r=>r.statut==="confirme"&&r.coiffeur_id===c.id);return(<div key={c.id} className="glass-panel" style={{padding:0,overflow:"hidden"}}><div style={{padding:"16px",borderBottom:`1px solid rgba(0,0,0,0.05)`,display:"flex",alignItems:"center",gap:12,background:"rgba(255,255,255,0.3)"}}><div style={{width:32,height:32,borderRadius:10,background:c.couleur+"20",color:c.couleur,display:"flex",alignItems:"center",justifyContent:"center",fontSize:14,fontWeight:800}}>{(c.prenom||"?").charAt(0)}</div><span style={{fontSize:15,fontWeight:700,color:c.couleur}}>{cLabel(c)}</span><span style={{fontSize:12,color:T.text3,marginLeft:"auto"}}>{cRdvs.length} RDV</span></div><div style={{padding:12}}><div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:4}}>{["L","M","M","J","V","S","D"].map((d,i)=><div key={i} style={{padding:4,textAlign:"center",fontSize:10,fontWeight:700,color:T.text3}}>{d}</div>)}{grid.map((d,i)=>{const dr=cRdvs.filter(r=>same(new Date(r.date_heure),d)),cnt=dr.length,isT=same(d,n),isCl=d.getDay()===0||d.getDay()===1,cg=isSalonFerme(d,salon)||c.conges?.includes(fd(d)),past=d<n&&!isT;return(<div key={i} className="cal-cell" onClick={()=>!isCl&&onDay(d)} style={{padding:"6px 2px",textAlign:"center",minHeight:40,borderRadius:8,cursor:isCl?"default":"pointer",background:cg?T.congeBgCell:isT?"rgba(184, 150, 90, 0.08)":d.getMonth()===currentDate.getMonth()?"rgba(255,255,255,0.4)":"transparent",border:isT?`1px solid ${T.accent+"50"}`:`1px solid transparent`,opacity:isCl?0.2:past?0.5:d.getMonth()===currentDate.getMonth()?1:0.3}}><div style={{fontSize:12,fontWeight:isT?800:500,color:cg?T.congeText:isT?T.accent:T.text}}>{d.getDate()}</div>{cnt>0&&<div style={{display:"flex",justifyContent:"center",gap:3,marginTop:4}}>{cnt<=3?Array.from({length:cnt}).map((_,j)=><div key={j} style={{width:6,height:6,borderRadius:3,background:c.couleur}}/>):<span style={{fontSize:10,fontWeight:700,color:c.couleur}}>{cnt}</span>}</div>}{cg&&cnt===0&&<div style={{fontSize:8,color:T.congeText,fontWeight:700,marginTop:2}}>C</div>}</div>);})}</div></div></div>);})}</div></div>);}

/* CLIENTS PAGE */
function ClientsP({clients,setClients,rdvs,coiffeurs,prestations,T}){
  const [s,setS]=useState(""),[em,setEm]=useState(null),[f,setF]=useState({nom:"",prenom:"",telephone:"",email:""}),[confirmDel,setConfirmDel]=useState(null),[expanded,setExpanded]=useState(null);
  const visitCounts=useMemo(()=>{const counts={};rdvs.filter(r=>r.statut==="confirme").forEach(r=>{const phone=(r.client_telephone||"").replace(/\+/g,"").replace(/\s/g,"");if(phone)counts[phone]=(counts[phone]||0)+1;});return counts;},[rdvs]);
  const getClientRdvs=(client,limit=5)=>{const phone=(client.telephone||"").replace(/\+/g,"").replace(/\s/g,"");if(!phone)return[];return rdvs.filter(r=>r.statut==="confirme"&&(r.client_telephone||"").replace(/\+/g,"").replace(/\s/g,"")===phone).sort((a,b)=>new Date(b.date_heure)-new Date(a.date_heure)).slice(0,limit);};
  const fl=clients.filter(c=>!s||`${c.nom} ${c.prenom} ${c.telephone}`.toUpperCase().includes(s.toUpperCase())).sort((a,b)=>(visitCounts[(b.telephone||"").replace(/\+/g,"").replace(/\s/g,"")]||0)-(visitCounts[(a.telephone||"").replace(/\+/g,"").replace(/\s/g,"")]||0));
  const fmtDate=dh=>{const d=new Date(dh);return`${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()} ${String(d.getHours()).padStart(2,"0")}h${String(d.getMinutes()).padStart(2,"0")}`;},isPast=dh=>new Date(dh)<new Date();
  return(<div style={{overflow:"auto",flex:1,padding:"24px max(24px, calc((100% - 900px) / 2))"}}><div style={{display:"flex",alignItems:"center",gap:16,marginBottom:24}}><div style={{flex:1}}><Inp value={s} onChange={setS} placeholder="Rechercher un client..." icon={Search} T={T}/></div><Btn variant="gold" icon={Plus} onClick={()=>{setF({nom:"",prenom:"",telephone:"",email:""});setEm("new");}} T={T}>Nouveau client</Btn></div><div className="glass-panel" style={{padding:0,overflow:"hidden"}}><div style={{display:"grid",gridTemplateColumns:"2fr 2fr 1fr 100px",padding:"16px 24px",background:"rgba(255,255,255,0.4)",fontSize:11,fontWeight:700,color:T.text2,textTransform:"uppercase",borderBottom:`1px solid rgba(0,0,0,0.05)`}}><span>Client</span><span>Contact</span><span>Visites</span><span/></div>{fl.map(c=>{const vc=visitCounts[(c.telephone||"").replace(/\+/g,"").replace(/\s/g,"")]||0,isExp=expanded===c.id,cRdvs=isExp?getClientRdvs(c,5):[];return(<div key={c.id}><div style={{display:"grid",gridTemplateColumns:"2fr 2fr 1fr 100px",padding:"16px 24px",borderBottom:`1px solid rgba(0,0,0,0.05)`,alignItems:"center",cursor:"pointer",background:isExp?"rgba(255,255,255,0.6)":"transparent",transition:"background 0.2s"}} onClick={()=>setExpanded(isExp?null:c.id)} onMouseEnter={e=>!isExp&&(e.currentTarget.style.background="rgba(255,255,255,0.3)")} onMouseLeave={e=>!isExp&&(e.currentTarget.style.background="transparent")}><div style={{display:"flex",alignItems:"center",gap:12}}><div style={{width:36,height:36,borderRadius:12,background:"rgba(0,0,0,0.05)",display:"flex",alignItems:"center",justifyContent:"center"}}><User size={16} color={T.text2}/></div><span style={{fontSize:14,fontWeight:700,color:T.text}}>{c.prenom} {c.nom}</span>{vc>0&&<ChevronRight size={16} color={T.text3} style={{transform:isExp?"rotate(90deg)":"rotate(0)",transition:"transform 0.25s ease"}}/>}</div><span style={{fontSize:14,color:T.text2}}>{c.telephone}</span><Bdg small color={vc>=5?T.accent:undefined} T={T}>{vc}</Bdg><div style={{display:"flex",gap:8}}><button onClick={e=>{e.stopPropagation();setF({...c});setEm(c.id);}} style={{background:"none",border:"none",cursor:"pointer",padding:6,color:T.text2}}><Edit size={16}/></button><button onClick={e=>{e.stopPropagation();setConfirmDel(c);}} style={{background:"none",border:"none",cursor:"pointer",padding:6,color:T.dangerText}}><Trash2 size={16}/></button></div></div>{isExp&&<div style={{padding:"0 24px 24px",background:"rgba(255,255,255,0.6)"}}>{cRdvs.length===0?<div style={{padding:"16px 0",fontSize:13,color:T.text3,textAlign:"center"}}>Aucun rendez-vous</div>:<div style={{display:"flex",flexDirection:"column",gap:8,paddingTop:16}}><div style={{fontSize:11,fontWeight:700,color:T.text3,textTransform:"uppercase",letterSpacing:"0.05em",marginBottom:4}}>Historique récent</div>{cRdvs.map(r=>{const co=coiffeurs.find(x=>x.id===r.coiffeur_id),past=isPast(r.date_heure);return(<div key={r.id} style={{display:"flex",alignItems:"center",gap:16,padding:"12px 16px",background:"#FFF",borderRadius:12,border:`1px solid rgba(0,0,0,0.05)`,opacity:past?0.7:1,boxShadow:"0 2px 8px rgba(0,0,0,0.02)"}}><div style={{width:4,height:36,borderRadius:2,background:co?.couleur||T.text3,flexShrink:0}}/><div style={{flex:1,minWidth:0}}><div style={{fontSize:13,fontWeight:700,color:T.text}}>{r.prestations_noms}</div><div style={{fontSize:12,color:T.text2,marginTop:2}}>{fmtDate(r.date_heure)} · {co?cLabel(co):"?"}</div></div><div style={{fontSize:14,fontWeight:800,color:T.text}}>{r.prix_total}€</div><Bdg small color={past?"#8A8681":"#10b981"} T={T}>{past?"Passé":"À venir"}</Bdg></div>);})}</div>}</div>}</div>);})}</div><Modal open={!!em} onClose={()=>setEm(null)} title={em==="new"?"Nouveau client":"Modifier client"} width={500} T={T}><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}><Inp label="Nom" value={f.nom} onChange={v=>setF({...f,nom:v})} T={T}/><Inp label="Prénom" value={f.prenom} onChange={v=>setF({...f,prenom:v})} T={T}/></div><Inp label="Téléphone" value={f.telephone} onChange={v=>setF({...f,telephone:v})} icon={Phone} T={T}/><Inp label="Email" value={f.email} onChange={v=>setF({...f,email:v})} icon={Mail} T={T}/><div style={{display:"flex",gap:12,marginTop:16}}><Btn variant="ghost" onClick={()=>setEm(null)} T={T}>Annuler</Btn><div style={{flex:1}}/><Btn variant="gold" icon={Save} T={T} onClick={async()=>{const phone=(f.telephone||"").replace("+","").replace(/\s/g,"");if(em==="new"){const nc={...f,id:phone||("C"+Date.now()),nombre_visites:0,created_at:new Date().toISOString()};setClients([...clients,nc]);if(phone)await fbPut(`clients/${phone}`,nc);}else{setClients(clients.map(c=>c.id===em?{...c,...f}:c));const oldPhone=(clients.find(c=>c.id===em)?.telephone||"").replace("+","").replace(/\s/g,"");if(oldPhone)await fbPatch(`clients/${oldPhone}`,f);}setEm(null);}}>Enregistrer</Btn></div></Modal><ConfirmDialog open={!!confirmDel} T={T} title="Supprimer ce client ?" message={confirmDel?`${confirmDel.prenom} ${confirmDel.nom} sera définitivement supprimé.`:""} confirmLabel="Supprimer" onCancel={()=>setConfirmDel(null)} onConfirm={async()=>{const c=confirmDel;setConfirmDel(null);const phone=(c.telephone||"").replace("+","").replace(/\s/g,"");setClients(prev=>prev.filter(x=>x.id!==c.id));if(phone)await fbDel(`clients/${phone}`);}}/></div>);}

/* PRESTATIONS PAGE */
function PrestationsP({prestations,setPrestations,salon,T}){
  const [em,setEm]=useState(null),[f,setF]=useState({id:"",nom:"",nom_court:"",categorie:"femme",specialisation:"femme",duree_minutes:60,prix:0}),[confirmDel,setConfirmDel]=useState(null),[fc,setFc]=useState("all"),[sort,setSort]=useState({key:"id",dir:1});
  const fl=prestations.filter(p=>fc==="all"||p.categorie===fc),sorted=useMemo(()=>[...fl].sort((a,b)=>{if(sort.key==="id")return a.id.localeCompare(b.id)*sort.dir;if(sort.key==="duree")return(a.duree_minutes-b.duree_minutes)*sort.dir;if(sort.key==="prix")return(a.prix-b.prix)*sort.dir;if(sort.key==="spec")return(a.specialisation||"").localeCompare(b.specialisation||"")*sort.dir;return 0;}),[fl,sort]),toggleSort=k=>setSort(s=>s.key===k?{key:k,dir:s.dir*-1}:{key:k,dir:1});
  const catC={homme:"#6366f1",femme:"#ec4899",enfant:"#f59e0b"},specC={femme:"#ec4899",homme:"#6366f1",enfant:"#f59e0b",coloriste:"#10b981",barbier:"#f97316"};
  const SortBtn=({k,label})=>(<button onClick={()=>toggleSort(k)} style={{background:"none",border:"none",cursor:"pointer",fontSize:11,fontWeight:700,color:sort.key===k?T.accent:T.text2,display:"flex",alignItems:"center",gap:4,textTransform:"uppercase",padding:0}}>{label}{sort.key===k&&<span style={{fontSize:10}}>{sort.dir===1?"▲":"▼"}</span>}</button>);
  return(<div style={{overflow:"auto",flex:1,padding:"24px max(24px, calc((100% - 1100px) / 2))"}}><div style={{display:"flex",alignItems:"center",gap:16,marginBottom:24}}><div className="glass-panel" style={{display:"flex",gap:4,padding:6,borderRadius:16}}>{["all","femme","homme","enfant"].map(c=>(<button key={c} onClick={()=>setFc(c)} style={{padding:"8px 16px",borderRadius:12,border:"none",fontSize:13,fontWeight:700,cursor:"pointer",background:fc===c?"#FFF":"transparent",color:fc===c?T.text:T.text2,boxShadow:fc===c?"0 2px 8px rgba(0,0,0,0.05)":"none"}}>{c==="all"?"Toutes ("+prestations.length+")":c.charAt(0).toUpperCase()+c.slice(1)+"s"}</button>))}</div><div style={{flex:1}}/><Btn variant="gold" icon={Plus} onClick={()=>{setF({id:"",nom:"",nom_court:"",categorie:"femme",specialisation:"femme",duree_minutes:60,prix:0});setEm("new");}} T={T}>Nouvelle</Btn></div><div className="glass-panel" style={{padding:0,overflow:"hidden"}}><div style={{display:"grid",gridTemplateColumns:"60px 3fr 100px 100px 90px 80px 80px",padding:"16px 24px",background:"rgba(255,255,255,0.4)",gap:12,alignItems:"center",borderBottom:`1px solid rgba(0,0,0,0.05)`}}><SortBtn k="id" label="ID"/><span style={{fontSize:11,fontWeight:700,color:T.text2,textTransform:"uppercase"}}>Prestation</span><span style={{fontSize:11,fontWeight:700,color:T.text2,textTransform:"uppercase"}}>Catégorie</span><SortBtn k="spec" label="Spéc."/><SortBtn k="duree" label="Durée"/><SortBtn k="prix" label="Prix"/><span/></div>{sorted.map(p=>(<div key={p.id} style={{display:"grid",gridTemplateColumns:"60px 3fr 100px 100px 90px 80px 80px",padding:"16px 24px",borderBottom:`1px solid rgba(0,0,0,0.05)`,alignItems:"center",gap:12,transition:"background 0.2s"}} onMouseEnter={e=>e.currentTarget.style.background="rgba(255,255,255,0.6)"} onMouseLeave={e=>e.currentTarget.style.background="transparent"}><span style={{fontSize:12,fontWeight:700,color:T.accent,fontFamily:"monospace"}}>{p.id}</span><div><div style={{fontSize:14,fontWeight:700,color:T.text}}>{p.nom_court}</div><div style={{fontSize:12,color:T.text2,marginTop:2}}>{p.nom}</div></div><Bdg small color={catC[p.categorie]} T={T}>{p.categorie}</Bdg><Bdg small color={specC[p.specialisation]||T.text3} T={T}>{p.specialisation||"—"}</Bdg><span style={{fontSize:14,color:T.text2,fontWeight:500}}>{p.duree_minutes} min</span><span style={{fontSize:16,fontWeight:800,color:T.text}}>{p.prix}€</span><div style={{display:"flex",gap:8}}><button onClick={()=>{setF({...p});setEm(p.id);}} style={{background:"none",border:"none",cursor:"pointer",padding:6,color:T.text2}}><Edit size={16}/></button><button onClick={()=>setConfirmDel(p)} style={{background:"none",border:"none",cursor:"pointer",padding:6,color:T.dangerText}}><Trash2 size={16}/></button></div></div>))}</div><Modal open={!!em} onClose={()=>setEm(null)} title={em==="new"?"Nouvelle prestation":"Modifier"} width={600} T={T}><Inp label="ID (ex: F26, H10)" value={f.id} onChange={v=>setF({...f,id:v})} T={T}/><Inp label="Nom complet" value={f.nom} onChange={v=>setF({...f,nom:v})} T={T}/><Inp label="Nom court" value={f.nom_court} onChange={v=>setF({...f,nom_court:v})} T={T}/><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16}}><Sel label="Catégorie" value={f.categorie} onChange={v=>setF({...f,categorie:v})} T={T} options={[{value:"femme",label:"Femme"},{value:"homme",label:"Homme"},{value:"enfant",label:"Enfant"}]}/><Sel label="Spécialisation requise" value={f.specialisation||""} onChange={v=>setF({...f,specialisation:v})} T={T} options={(salon?.specialisations||SPECIALISATIONS_LIST).map(s=>({value:s,label:s.charAt(0).toUpperCase()+s.slice(1)}))}/></div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16}}><Inp label="Durée (min)" value={f.duree_minutes} onChange={v=>setF({...f,duree_minutes:Number(v)})} type="number" T={T}/><Inp label="Prix (€)" value={f.prix} onChange={v=>setF({...f,prix:Number(v)})} type="number" T={T}/></div><div style={{display:"flex",gap:12,marginTop:20}}><Btn variant="ghost" onClick={()=>setEm(null)} T={T}>Annuler</Btn><div style={{flex:1}}/><Btn variant="gold" icon={Save} T={T} onClick={async()=>{if(em==="new"){const newId="PREST"+String(Date.now()).slice(-6);const np={...f,id:newId,actif:true};setPrestations([...prestations,np]);await fbPut(`prestations/${newId}`,np);}else{setPrestations(prestations.map(p=>p.id===em?{...p,...f}:p));await fbPatch(`prestations/${em}`,f);}setEm(null);}}>Enregistrer</Btn></div></Modal><ConfirmDialog open={!!confirmDel} T={T} title="Supprimer cette prestation ?" message={confirmDel?`${confirmDel.nom_court||confirmDel.nom} sera définitivement supprimée.`:""} confirmLabel="Supprimer" onCancel={()=>setConfirmDel(null)} onConfirm={async()=>{const p=confirmDel;setConfirmDel(null);setPrestations(prev=>prev.filter(x=>x.id!==p.id));await fbDel(`prestations/${p.id}`);}}/></div>);}

/* QR Component */
function QrReveal({T,calendarId,coiffeurName}){
  const [show,setShow]=useState(false);const timer=useRef(null);const reveal=(e)=>{e.stopPropagation();setShow(true);clearTimeout(timer.current);timer.current=setTimeout(()=>setShow(false),15000);};useEffect(()=>()=>clearTimeout(timer.current),[]);
  const box={width:120,height:120,flexShrink:0,alignSelf:"center",borderRadius:16,border:`2px dashed rgba(0,0,0,0.1)`,background:"rgba(255,255,255,0.4)",display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden",position:"relative"};
  if(!calendarId)return(<div style={{...box,opacity:0.6}}><div style={{textAlign:"center"}}><Calendar size={32} color={T.text3}/><div style={{fontSize:10,fontWeight:600,color:T.text3,marginTop:6}}>Pas de GCal</div></div></div>);
  const webcalUrl=`webcal://calendar.google.com/calendar/ical/${encodeURIComponent(calendarId)}/public/basic.ics`,qrImg=`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(webcalUrl)}`;
  return(<div style={{...box,cursor:show?"default":"pointer", transition:"all 0.2s"}} onClick={!show?reveal:undefined} onMouseEnter={e=>!show&&(e.currentTarget.style.background="#FFF")} onMouseLeave={e=>!show&&(e.currentTarget.style.background="rgba(255,255,255,0.4)")}>{!show?<div style={{textAlign:"center"}}><Calendar size={32} color={T.accent}/><div style={{fontSize:10,fontWeight:700,color:T.accent,marginTop:6}}>QR Sync</div><div style={{fontSize:9,color:T.text2,marginTop:2,padding:"0 8px"}}>Cliquez pour voir</div></div>:<div style={{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",width:"100%",height:"100%",padding:8}}><img src={qrImg} alt={`QR ${coiffeurName}`} style={{width:104,height:104,borderRadius:8}} onError={e=>{e.target.style.display="none";}}/><div style={{position:"absolute",bottom:0,left:0,right:0,height:4,background:"rgba(0,0,0,0.05)",overflow:"hidden"}}><div style={{height:"100%",background:T.accent,animation:"qrTimer 15s linear forwards"}}/></div></div>}</div>);
}

/* MACRO PLANNING */
function MacroPlanning({coiffeurs,salon,T}){
  const [macroView,setMacroView]=useState("trim"),[startMonth,setStartMonth]=useState(()=>{const n=new Date();return new Date(n.getFullYear(),Math.floor(n.getMonth()/3)*3,1);}),[year,setYear]=useState(()=>new Date().getFullYear()),n=new Date(),activeCoifs=coiffeurs.filter(c=>c.actif);
  const trimMonths=[0,1,2].map(i=>{const d=new Date(startMonth);d.setMonth(d.getMonth()+i);return d;}),yearMonths=Array.from({length:12},(_,i)=>new Date(year,i,1)),months=macroView==="trim"?trimMonths:yearMonths,navQ=dir=>{if(macroView==="trim"){const d=new Date(startMonth);d.setMonth(d.getMonth()+3*dir);setStartMonth(d);}else setYear(y=>y+dir);};
  const periodStart=macroView==="trim"?trimMonths[0]:new Date(year,0,1),periodEnd=macroView==="trim"?new Date(trimMonths[2].getFullYear(),trimMonths[2].getMonth()+1,1):new Date(year+1,0,1),periodLabel=macroView==="trim"?`${MOIS[trimMonths[0].getMonth()].substring(0,3)} — ${MOIS[trimMonths[2].getMonth()].substring(0,3)} ${trimMonths[2].getFullYear()}`:`${year}`;
  const renderMonth=(mo,compact)=>{const grid=mGrid(mo),cellH=compact?24:32,dotSz=compact?4:6,fontSize=compact?9:11,headerSz=compact?11:14;return(<div key={mo.getTime()}><div style={{fontSize:headerSz,fontWeight:800,color:T.text,textAlign:"center",marginBottom:compact?8:12,textTransform:"capitalize"}}>{MOIS[mo.getMonth()]} {macroView==="year"?"":mo.getFullYear()}</div><div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:compact?2:4}}>{["L","M","M","J","V","S","D"].map((d,i)=><div key={i} style={{padding:0,textAlign:"center",fontSize:compact?8:10,fontWeight:700,color:T.text2}}>{d}</div>)}{grid.map((d,i)=>{const inMonth=d.getMonth()===mo.getMonth(),isT=same(d,n),sf=isSalonFerme(d,salon),isClosed=salon?.jours_fermes?.includes(JOURS[d.getDay()]),coifConges=inMonth&&!isClosed?activeCoifs.filter(c=>c.conges?.includes(fd(d))):[],hasConge=coifConges.length>0;return(<div key={i} style={{padding:compact?"2px 0":"4px 0",textAlign:"center",minHeight:cellH,borderRadius:compact?4:8,position:"relative",background:sf?T.congeBg:isT?"rgba(184, 150, 90, 0.1)":"rgba(255,255,255,0.4)",border:isT?`1px solid ${T.accent}`:`1px solid rgba(0,0,0,0.05)`,opacity:!inMonth?0.2:isClosed?0.3:1}}><div style={{fontSize,fontWeight:isT?800:600,color:sf?T.congeText:isT?T.accent:T.text,lineHeight:1}}>{d.getDate()}</div>{inMonth&&!isClosed&&(hasConge||sf)&&(sf?<div style={{width:compact?12:16,height:compact?3:4,borderRadius:2,background:T.congeText,margin:"4px auto 0"}}/>:<div style={{display:"flex",justifyContent:"center",gap:2,marginTop:4,flexWrap:"wrap",maxWidth:compact?30:40,margin:"4px auto 0"}}>{coifConges.map(c=><div key={c.id} style={{width:dotSz,height:dotSz,borderRadius:dotSz/2,background:c.couleur,flexShrink:0}}/>)}</div>)}</div>);})}</div></div>);};
  return(<div className="glass-panel" style={{padding:24,marginBottom:24}}><div style={{display:"flex",alignItems:"center",gap:16,marginBottom:24,flexWrap:"wrap"}}><Calendar size={20} color={T.accent}/><span style={{fontSize:16,fontWeight:800,color:T.text}}>Planning congés équipe</span><div style={{display:"flex",gap:4,background:"rgba(0,0,0,0.03)",borderRadius:12,padding:4,border:`1px solid rgba(0,0,0,0.04)`,marginLeft:12}}>{[{id:"trim",l:"Trimestre"},{id:"year",l:"Année"}].map(v=><button key={v.id} onClick={()=>setMacroView(v.id)} style={{padding:"6px 14px",borderRadius:8,border:"none",fontSize:12,fontWeight:700,cursor:"pointer",background:macroView===v.id?"#FFF":"transparent",color:macroView===v.id?T.accent:T.text2,boxShadow:macroView===v.id?"0 2px 8px rgba(0,0,0,0.05)":"none"}}>{v.l}</button>)}</div><div style={{flex:1}}/><div style={{display:"flex",alignItems:"center",gap:8,background:"rgba(255,255,255,0.4)",borderRadius:12,padding:"4px 8px",border:"1px solid rgba(0,0,0,0.05)"}}><button onClick={()=>navQ(-1)} style={{background:"transparent",border:"none",padding:4,cursor:"pointer",display:"flex",color:T.text2}}><ChevronLeft size={16}/></button><span style={{fontSize:13,fontWeight:800,color:T.text,minWidth:120,textAlign:"center"}}>{periodLabel}</span><button onClick={()=>navQ(1)} style={{background:"transparent",border:"none",padding:4,cursor:"pointer",display:"flex",color:T.text2}}><ChevronRight size={16}/></button></div></div><div style={{display:"flex",gap:12,flexWrap:"wrap",marginBottom:24}}>{activeCoifs.map(c=>{const total=(c.conges||[]).filter(d=>{const dt=new Date(d+"T12:00:00");return dt>=periodStart&&dt<periodEnd;}).length;return(<div key={c.id} style={{display:"flex",alignItems:"center",gap:8,padding:"8px 16px",borderRadius:12,background:c.couleur+"15",border:`1px solid ${c.couleur+"30"}`}}><div style={{width:10,height:10,borderRadius:5,background:c.couleur}}/><span style={{fontSize:13,fontWeight:700,color:c.couleur}}>{c.prenom}</span><span style={{fontSize:14,fontWeight:800,color:T.text,marginLeft:4}}>{total}j</span></div>);})}{(salon?.fermetures_annuelles||[]).length>0&&<div style={{display:"flex",alignItems:"center",gap:8,padding:"8px 16px",borderRadius:12,background:T.congeBg,border:`1px solid ${T.congeBorder}`}}><Store size={14} color={T.congeText}/><span style={{fontSize:13,fontWeight:700,color:T.congeText}}>Salon fermé</span><span style={{fontSize:14,fontWeight:800,color:T.congeText,marginLeft:4}}>{(salon.fermetures_annuelles||[]).filter(d=>{const dt=new Date(d+"T12:00:00");return dt>=periodStart&&dt<periodEnd;}).length}j</span></div>}</div><div style={{display:"grid",gridTemplateColumns:macroView==="trim"?"repeat(3,1fr)":"repeat(4,1fr)",gap:macroView==="trim"?24:16}}>{months.map(mo=>renderMonth(mo,macroView==="year"))}</div><div style={{display:"flex",gap:16,marginTop:24,paddingTop:16,borderTop:`1px solid rgba(0,0,0,0.05)`,flexWrap:"wrap",alignItems:"center"}}><span style={{fontSize:11,color:T.text2,fontWeight:700,textTransform:"uppercase",letterSpacing:"0.05em"}}>Légende :</span>{activeCoifs.map(c=><div key={c.id} style={{display:"flex",alignItems:"center",gap:6}}><div style={{width:8,height:8,borderRadius:4,background:c.couleur}}/><span style={{fontSize:12,fontWeight:600,color:T.text}}>{c.prenom}</span></div>)}<div style={{display:"flex",alignItems:"center",gap:6}}><div style={{width:16,height:4,borderRadius:2,background:T.congeText}}/><span style={{fontSize:12,fontWeight:600,color:T.text}}>Salon fermé</span></div></div></div>);
}

/* COIFFEURS PAGE */
function CoiffeursP({coiffeurs,setCoiffeurs,salon,T}){
  const [em,setEm]=useState(null),[tab,setTab]=useState("info"),[saving,setSaving]=useState(false),[savingMsg,setSavingMsg]=useState(""),[confirmDel,setConfirmDel]=useState(null),salonClosed=salon?.jours_fermes||["lundi","dimanche"];
  const [f,setF]=useState({prenom:"",nom:"",email:"",telephone:"",couleur:"#B8965A",specialisations:[],horaires:{mardi:{debut:"09:30",fin:"19:00"},mercredi:{debut:"09:30",fin:"19:00"},jeudi:{debut:"09:30",fin:"19:00"},vendredi:{debut:"09:30",fin:"19:00"},samedi:{debut:"09:00",fin:"18:00"}},pause_dejeuner:"12:30-13:30",conges:[]}),[newConge,setNewConge]=useState("");
  const toggleSpec=s=>setF(prev=>({...prev,specialisations:prev.specialisations.includes(s)?prev.specialisations.filter(x=>x!==s):[...prev.specialisations,s]})),setHoraire=(jour,field,val)=>setF(prev=>({...prev,horaires:{...prev.horaires,[jour]:{...prev.horaires[jour],[field]:val}}})),toggleJour=jour=>{if(salonClosed.includes(jour))return;setF(prev=>{const h={...prev.horaires};if(h[jour])delete h[jour];else h[jour]={debut:salon?.ouverture||"09:30",fin:salon?.fermeture||"19:00"};return{...prev,horaires:h};});},rmConge=d=>setF(prev=>({...prev,conges:prev.conges.filter(x=>x!==d)})),openEdit=c=>{setF({...c,horaires:c.horaires||{mardi:{debut:"09:30",fin:"19:00"},mercredi:{debut:"09:30",fin:"19:00"},jeudi:{debut:"09:30",fin:"19:00"},vendredi:{debut:"09:30",fin:"19:00"},samedi:{debut:"09:00",fin:"18:00"}},pause_dejeuner:c.pause_dejeuner||"12:30-13:30",conges:c.conges||[]});setTab("info");setEm(c.id);},openNew=()=>{const defH={};JALL.forEach(j=>{if(!salonClosed.includes(j))defH[j]={debut:salon?.ouverture||"09:30",fin:salon?.fermeture||"19:00"};});setF({prenom:"",nom:"",email:"",telephone:"",couleur:"#B8965A",specialisations:[],horaires:defH,pause_dejeuner:"12:30-13:30",conges:[]});setTab("info");setEm("new");},jtxt=c=>{const ord=JALL.filter(j=>c.horaires&&c.horaires[j]);return ord.length?ord.map(j=>j.charAt(0).toUpperCase()+j.slice(1,3)).join(", "):"Non défini";};
  return(<div style={{overflow:"auto",flex:1,padding:"24px max(24px, calc((100% - 1000px) / 2))"}}><div style={{display:"flex",justifyContent:"flex-end",marginBottom:24}}><Btn variant="gold" icon={Plus} onClick={openNew} T={T}>Nouveau coiffeur</Btn></div><MacroPlanning coiffeurs={coiffeurs} salon={salon} T={T}/><div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(360px,1fr))",gap:20}}>{coiffeurs.map(c=>(<div key={c.id} className="glass-panel" style={{padding:24,borderTop:`6px solid ${c.couleur}`}}><div style={{display:"flex",gap:20}}><div style={{flex:1,minWidth:0}}><div style={{display:"flex",alignItems:"center",gap:16,marginBottom:16}}><div style={{width:56,height:56,borderRadius:16,background:c.couleur,color:"#FFF",display:"flex",alignItems:"center",justifyContent:"center",fontSize:24,fontWeight:800,flexShrink:0,boxShadow:`0 4px 16px ${c.couleur}40`}}>{(c.prenom||"?").charAt(0)}</div><div style={{minWidth:0}}><div style={{fontSize:20,fontWeight:800,color:T.text,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{cLabel(c)}</div><div style={{fontSize:13,color:T.text2,marginTop:2}}>{c.email}</div></div></div><div style={{display:"flex",gap:6,flexWrap:"wrap",marginBottom:12}}>{c.specialisations?.map(s=><Bdg key={s} small color={c.couleur} T={T}>{s}</Bdg>)}</div><div style={{fontSize:12,color:T.text2,marginBottom:4,fontWeight:500}}>{jtxt(c)}</div>{c.pause_dejeuner&&<div style={{fontSize:12,color:T.text2,fontWeight:500}}>Pause : {c.pause_dejeuner}</div>}{c.conges?.length>0&&<div style={{fontSize:12,color:T.accent,marginTop:6,fontWeight:700}}>{c.conges.length} congé(s) planifiés</div></div><QrReveal T={T} calendarId={c.google_calendar_id} coiffeurName={c.prenom}/></div><div style={{display:"flex",gap:12,marginTop:20,borderTop:`1px solid rgba(0,0,0,0.05)`,paddingTop:20}}><Btn variant="ghost" icon={Edit} onClick={()=>openEdit(c)} T={T}>Modifier</Btn><Btn variant="ghost" icon={Trash2} onClick={()=>setConfirmDel(c)} T={T} style={{color:T.dangerText, borderColor:T.dangerBorder}}>Suppr.</Btn></div></div>))}</div>
  <Modal open={!!em} onClose={()=>{if(!saving)setEm(null);}} title={em==="new"?"Nouveau coiffeur":"Modifier coiffeur"} width={700} T={T}>{saving&&<div style={{position:"absolute",inset:0,background:"rgba(250, 248, 245, 0.8)",backdropFilter:"blur(8px)",zIndex:50,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",borderRadius:24}}><div className="spinner" style={{marginBottom:16}}></div><div style={{fontSize:16,fontWeight:700,color:T.text}}>{savingMsg}</div></div>}<div style={{display:"flex",gap:4,marginBottom:24,background:"rgba(0,0,0,0.03)",borderRadius:14,padding:4,border:`1px solid rgba(0,0,0,0.04)`}}>{[{id:"info",l:"Infos"},{id:"horaires",l:"Horaires"},{id:"conges",l:"Congés"}].map(t=>(<button key={t.id} onClick={()=>setTab(t.id)} style={{flex:1,padding:"10px 0",borderRadius:10,border:"none",fontSize:13,fontWeight:700,cursor:"pointer",background:tab===t.id?"#FFF":"transparent",color:tab===t.id?T.text:T.text2,boxShadow:tab===t.id?"0 2px 8px rgba(0,0,0,0.05)":"none"}}>{t.l}</button>))}</div>
  {tab==="info"&&<div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16}}><Inp label="Prénom" value={f.prenom} onChange={v=>setF({...f,prenom:v})} T={T}/><Inp label="Nom" value={f.nom} onChange={v=>setF({...f,nom:v})} T={T}/></div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16}}><Inp label="Email" value={f.email} onChange={v=>setF({...f,email:v})} icon={Mail} T={T}/><Inp label="Téléphone" value={f.telephone} onChange={v=>setF({...f,telephone:v})} icon={Phone} T={T}/></div><div style={{marginBottom:24}}><label style={{display:"block",fontSize:12,fontWeight:700,color:T.text2,marginBottom:12,textTransform:"uppercase",letterSpacing:"0.05em"}}>Spécialisations</label><div style={{display:"flex",gap:8,flexWrap:"wrap"}}>{(salon?.specialisations||SPECIALISATIONS_LIST).map(s=>(<button key={s} onClick={()=>toggleSpec(s)} style={{padding:"8px 16px",borderRadius:20,border:`2px solid ${f.specialisations.includes(s)?T.accent:"rgba(0,0,0,0.05)"}`,background:f.specialisations.includes(s)?T.accent+"15":"rgba(255,255,255,0.5)",color:f.specialisations.includes(s)?T.accent:T.text2,fontSize:13,fontWeight:700,cursor:"pointer",textTransform:"capitalize",transition:"all 0.2s"}}>{s}</button>))}</div></div><div style={{marginBottom:16}}><label style={{display:"block",fontSize:12,fontWeight:700,color:T.text2,marginBottom:12,textTransform:"uppercase",letterSpacing:"0.05em"}}>Couleur de l'agenda</label><div style={{display:"grid",gridTemplateColumns:"repeat(19,1fr)",gap:4}}>{COLORS.map(col=>(<div key={col} onClick={()=>setF({...f,couleur:col})} style={{width:"100%",aspectRatio:"1",borderRadius:6,background:col,cursor:"pointer",border:f.couleur===col?`3px solid ${T.text}`:"2px solid transparent",boxShadow:f.couleur===col?`0 0 12px ${col}60`:"none",transform:f.couleur===col?"scale(1.1)":"scale(1)",transition:"all 0.2s"}}/>))}</div></div></div>}
  {tab==="horaires"&&<div><label style={{display:"block",fontSize:12,fontWeight:700,color:T.text2,marginBottom:16,textTransform:"uppercase",letterSpacing:"0.05em"}}>Jours travaillés & horaires</label>{JALL.map(j=>{const closed=salonClosed.includes(j),active=!closed&&!!f.horaires[j];return(<div key={j} style={{display:"flex",alignItems:"center",gap:16,marginBottom:12,padding:"12px 16px",background:closed?"rgba(0,0,0,0.02)":active?"rgba(255,255,255,0.6)":"rgba(255,255,255,0.3)",borderRadius:16,border:`1px solid rgba(0,0,0,0.05)`,opacity:closed?0.5:1}}><button onClick={()=>toggleJour(j)} disabled={closed} style={{width:24,height:24,borderRadius:8,border:`2px solid ${closed?"rgba(0,0,0,0.1)":active?T.accent:"rgba(0,0,0,0.1)"}`,background:active?T.accent:"transparent",cursor:closed?"not-allowed":"pointer",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,transition:"all 0.2s"}}>{active&&<Check size={14} color="#fff"/>}</button><span style={{fontSize:14,fontWeight:700,color:closed?T.text3:active?T.text:T.text2,width:90,textTransform:"capitalize"}}>{j}</span>{closed&&<span style={{fontSize:12,color:T.text3,fontStyle:"italic"}}>Salon fermé</span>}{!closed&&active&&<><input className="input-glass" type="time" step="900" value={f.horaires[j].debut} onChange={e=>setHoraire(j,"debut",e.target.value)} style={{width:"auto",padding:"8px 12px"}}/><span style={{fontSize:14,color:T.text3,fontWeight:700}}>→</span><input className="input-glass" type="time" step="900" value={f.horaires[j].fin} onChange={e=>setHoraire(j,"fin",e.target.value)} style={{width:"auto",padding:"8px 12px"}}/></>}{!closed&&!active&&<span style={{fontSize:12,color:T.text3,fontStyle:"italic"}}>Repos</span>}</div>);})}<div style={{marginTop:24}}/><Inp label="Pause déjeuner (ex: 12:30-13:30)" value={f.pause_dejeuner} onChange={v=>setF({...f,pause_dejeuner:v})} icon={Clock} T={T}/></div>}
  {tab==="conges"&&<div><label style={{display:"block",fontSize:12,fontWeight:700,color:T.text2,marginBottom:16,textTransform:"uppercase",letterSpacing:"0.05em"}}>Ajouter une période de congé</label><div style={{display:"flex",gap:12,marginBottom:24,alignItems:"flex-end"}}><div style={{flex:1}}><label style={{display:"block",fontSize:11,fontWeight:600,color:T.text2,marginBottom:6}}>Du</label><input className="input-glass" type="date" value={newConge.split("|")[0]||""} onChange={e=>setNewConge(e.target.value+"|"+(newConge.split("|")[1]||""))}/></div><div style={{flex:1}}><label style={{display:"block",fontSize:11,fontWeight:600,color:T.text2,marginBottom:6}}>Au</label><input className="input-glass" type="date" value={newConge.split("|")[1]||""} onChange={e=>setNewConge((newConge.split("|")[0]||"")+"|"+e.target.value)}/></div><Btn variant="gold" icon={Plus} onClick={()=>{const[from,to]=newConge.split("|");if(!from)return;const end=to||from,ds=[];let cur=new Date(from+"T12:00:00");const last=new Date(end+"T12:00:00");while(cur<=last){ds.push(fd(cur));cur=new Date(cur);cur.setDate(cur.getDate()+1);}setF(prev=>({...prev,conges:[...new Set([...prev.conges,...ds])].sort()}));setNewConge("");}} disabled={!newConge.split("|")[0]} T={T}>Ajouter</Btn></div>{f.conges.length===0&&<div style={{padding:32,textAlign:"center",color:T.text3,fontSize:14,fontWeight:500}}>Aucun congé planifié</div>}<div style={{display:"flex",flexDirection:"column",gap:8,maxHeight:240,overflow:"auto"}}>{f.conges.map(d=>{const dt=new Date(d+"T12:00:00"),lbl=`${JC[dt.getDay()]} ${dt.getDate()} ${MOIS[dt.getMonth()]} ${dt.getFullYear()}`;return(<div key={d} style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px 16px",background:"rgba(255,255,255,0.5)",borderRadius:12,border:`1px solid rgba(0,0,0,0.05)`}}><span style={{fontSize:14,fontWeight:600,color:T.text}}>{lbl}</span><button onClick={()=>rmConge(d)} style={{background:"none",border:"none",cursor:"pointer",color:T.text3,padding:4,display:"flex"}}><X size={18}/></button></div>);})}</div>{f.conges.length>0&&<button onClick={()=>setF(prev=>({...prev,conges:[]}))} style={{marginTop:12,background:"none",border:"none",cursor:"pointer",fontSize:12,fontWeight:600,color:T.text3,textDecoration:"underline"}}>Tout supprimer</button>}</div>}
  <div style={{display:"flex",gap:12,marginTop:24,borderTop:`1px solid rgba(0,0,0,0.05)`,paddingTop:24}}><Btn variant="ghost" onClick={()=>setEm(null)} T={T}>Annuler</Btn><div style={{flex:1}}/><Btn variant="gold" icon={Save} T={T} disabled={saving} onClick={async()=>{if(saving)return;setSaving(true);try{if(em==="new"){setSavingMsg("Création du coiffeur...");const newId="COIF"+String(Date.now()).slice(-6),maxOrdre=Math.max(0,...coiffeurs.map(c=>c.ordre_affichage||0)),nc={...f,id:newId,actif:true,ordre_affichage:maxOrdre+1};await fbPut(`coiffeurs/${newId}`,nc);setSavingMsg("Création du planning GCal...");let calId="";try{const gcr=await gcalSync("create_calendar",{coiffeur_prenom:f.prenom||"Coiffeur",coiffeur_id:newId});if(gcr?.google_calendar_id)calId=gcr.google_calendar_id;}catch(e){}const final={...nc,google_calendar_id:calId||""};setCoiffeurs(prev=>[...prev,final]);}else{setSavingMsg("Mise à jour...");setCoiffeurs(coiffeurs.map(c=>c.id===em?{...c,...f}:c));await fbPatch(`coiffeurs/${em}`,f);}setEm(null);}finally{setSaving(false);setSavingMsg("");}}}>{saving?"En cours...":"Enregistrer"}</Btn></div></Modal>
  <ConfirmDialog open={!!confirmDel} T={T} title="Supprimer ce coiffeur ?" message={confirmDel?`${confirmDel.prenom} ${confirmDel.nom} sera définitivement supprimé.`:""} confirmLabel="Supprimer" onCancel={()=>setConfirmDel(null)} onConfirm={async()=>{const c=confirmDel;setConfirmDel(null);setCoiffeurs(prev=>prev.filter(x=>x.id!==c.id));if(c.google_calendar_id){try{await gcalSync("delete_calendar",{calendar_id:c.google_calendar_id});}catch(e){}}await fbDel(`coiffeurs/${c.id}`);}}/></div>);
}

/* SALON PAGE */
function SalonP({salon,setSalon,T}){
  const [showSaved,setShowSaved]=useState(false),[newFerm,setNewFerm]=useState(""),[newSpec,setNewSpec]=useState("");
  const addSpec=()=>{const s=newSpec.toLowerCase().trim();if(!s||(salon.specialisations||[]).includes(s))return;setSalon({...salon,specialisations:[...(salon.specialisations||[]),s].sort()});setNewSpec("");},addFermeture=()=>{const[from,to]=newFerm.split("|");if(!from)return;const end=to||from,ds=[];let cur=new Date(from+"T12:00:00");const last=new Date(end+"T12:00:00");while(cur<=last){ds.push(fd(cur));cur=new Date(cur);cur.setDate(cur.getDate()+1);}setSalon({...salon,fermetures_annuelles:[...new Set([...(salon.fermetures_annuelles||[]),...ds])].sort()});setNewFerm("");},rmFerm=d=>setSalon({...salon,fermetures_annuelles:(salon.fermetures_annuelles||[]).filter(x=>x!==d)});
  const ranges=useMemo(()=>{const dates=(salon.fermetures_annuelles||[]).sort();if(!dates.length)return[];const r=[];let start=dates[0],prev=dates[0];for(let i=1;i<dates.length;i++){const d=new Date(dates[i]+"T12:00:00"),p=new Date(prev+"T12:00:00");if((d-p)/86400000<=1)prev=dates[i];else{r.push({from:start,to:prev,count:Math.round((new Date(prev+"T12:00:00")-new Date(start+"T12:00:00"))/86400000)+1});start=dates[i];prev=dates[i];}}r.push({from:start,to:prev,count:Math.round((new Date(prev+"T12:00:00")-new Date(start+"T12:00:00"))/86400000)+1});return r;},[salon.fermetures_annuelles]),fmtD=s=>{const d=new Date(s+"T12:00:00");return`${d.getDate()} ${MOIS[d.getMonth()].substring(0,4)} ${d.getFullYear()}`;},totalFerm=(salon.fermetures_annuelles||[]).length;
  return(<div style={{overflow:"auto",flex:1,padding:"24px max(24px, calc((100% - 800px) / 2))"}}><div style={{display:"flex",alignItems:"center",gap:16,marginBottom:32}}><div style={{width:56,height:56,borderRadius:16,background:T.accent,display:"flex",alignItems:"center",justifyContent:"center",boxShadow:`0 4px 16px ${T.accent}40`}}><Store size={26} color="#FFF"/></div><div><div style={{fontSize:24,fontWeight:800,color:T.text,letterSpacing:"-0.03em"}}>{salon.nom||"Maniatis"}</div><div style={{fontSize:14,color:T.text2,marginTop:4}}>{salon.adresse||"Paramètres du salon"}</div></div></div>
  <div className="glass-panel" style={{padding:32,marginBottom:24}}><div style={{display:"flex",alignItems:"center",gap:12,marginBottom:24}}><Clock size={22} color={T.accent}/><span style={{fontSize:18,fontWeight:800,color:T.text}}>Horaires d'ouverture</span></div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:20}}><Inp label="Ouverture" value={salon.ouverture} onChange={v=>setSalon({...salon,ouverture:v})} type="time" T={T}/><Inp label="Fermeture" value={salon.fermeture} onChange={v=>setSalon({...salon,fermeture:v})} type="time" T={T}/></div><Inp label="Pause déjeuner (ex: 12:30-13:30)" value={salon.pause} onChange={v=>setSalon({...salon,pause:v})} T={T}/><div style={{marginBottom:16}}><label style={{display:"block",fontSize:12,fontWeight:700,color:T.text2,marginBottom:12,textTransform:"uppercase",letterSpacing:"0.05em"}}>Jours de fermeture hebdomadaire</label><div style={{display:"flex",gap:8,flexWrap:"wrap"}}>{JALL.map(j=>(<button key={j} onClick={()=>setSalon({...salon,jours_fermes:salon.jours_fermes.includes(j)?salon.jours_fermes.filter(x=>x!==j):[...salon.jours_fermes,j]})} style={{padding:"10px 20px",borderRadius:24,border:`2px solid ${salon.jours_fermes.includes(j)?T.dangerBorder:"rgba(0,0,0,0.05)"}`,background:salon.jours_fermes.includes(j)?T.dangerBg:"rgba(255,255,255,0.5)",color:salon.jours_fermes.includes(j)?T.dangerText:T.text2,fontSize:13,fontWeight:700,cursor:"pointer",textTransform:"capitalize",transition:"all 0.2s"}}>{j}</button>))}</div></div></div>
  <div className="glass-panel" style={{padding:32,marginBottom:24}}><div style={{display:"flex",alignItems:"center",gap:12,marginBottom:8}}><Scissors size={22} color={T.accent}/><span style={{fontSize:18,fontWeight:800,color:T.text}}>Spécialisations</span><span style={{fontSize:12,fontWeight:800,color:T.accent,background:T.accent+"15",borderRadius:12,padding:"4px 10px",marginLeft:"auto"}}>{(salon.specialisations||[]).length}</span></div><p style={{fontSize:14,color:T.text2,marginBottom:24,lineHeight:1.5,fontWeight:500}}>Liste globale des compétences disponibles pour associer vos coiffeurs aux bonnes prestations.</p><div style={{display:"flex",gap:8,flexWrap:"wrap",marginBottom:24}}>{(salon.specialisations||[]).map(s=>(<div key={s} style={{display:"flex",alignItems:"center",gap:8,padding:"8px 16px",borderRadius:24,border:`2px solid ${T.accent}40`,background:T.accent+"10",fontSize:13,fontWeight:700,color:T.accent,textTransform:"capitalize"}}>{s}<button onClick={()=>setSalon({...salon,specialisations:(salon.specialisations||[]).filter(x=>x!==s)})} style={{background:"none",border:"none",cursor:"pointer",color:T.accent,padding:0,display:"flex"}}><X size={14}/></button></div>))}</div><div style={{display:"flex",gap:12,alignItems:"flex-end"}}><div style={{flex:1}}><Inp label="Nouvelle spécialisation" value={newSpec} onChange={setNewSpec} placeholder="Ex: balayage, extensions..." T={T}/></div><Btn variant="gold" icon={Plus} onClick={addSpec} disabled={!newSpec.trim()} T={T}>Ajouter</Btn></div></div>
  <div className="glass-panel" style={{padding:32,marginBottom:24}}><div style={{display:"flex",alignItems:"center",gap:12,marginBottom:8}}><Calendar size={22} color={T.congeText}/><span style={{fontSize:18,fontWeight:800,color:T.text}}>Fermetures exceptionnelles</span>{totalFerm>0&&<span style={{fontSize:12,fontWeight:800,color:T.congeText,background:T.congeBg,borderRadius:12,padding:"4px 10px",marginLeft:"auto"}}>{totalFerm} jour(s)</span>}</div><p style={{fontSize:14,color:T.text2,marginBottom:24,lineHeight:1.5,fontWeight:500}}>Vacances, jours fériés. Bloque tous les agendas et l'IA.</p><div style={{display:"flex",gap:12,marginBottom:24,alignItems:"flex-end"}}><div style={{flex:1}}><label style={{display:"block",fontSize:11,fontWeight:700,color:T.text2,marginBottom:6}}>Du</label><input className="input-glass" type="date" value={newFerm.split("|")[0]||""} onChange={e=>setNewFerm(e.target.value+"|"+(newFerm.split("|")[1]||""))}/></div><div style={{flex:1}}><label style={{display:"block",fontSize:11,fontWeight:700,color:T.text2,marginBottom:6}}>Au</label><input className="input-glass" type="date" value={newFerm.split("|")[1]||""} onChange={e=>setNewFerm((newFerm.split("|")[0]||"")+"|"+e.target.value)}/></div><Btn variant="gold" icon={Plus} onClick={addFermeture} disabled={!newFerm.split("|")[0]} T={T}>Ajouter</Btn></div>{ranges.length===0&&<div style={{padding:24,textAlign:"center",color:T.text3,fontSize:14,fontWeight:500}}>Aucune fermeture planifiée</div>}<div style={{display:"flex",flexDirection:"column",gap:8,maxHeight:300,overflow:"auto"}}>{ranges.map((r,i)=>(<div key={i} style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"16px 20px",background:T.congeBg,borderRadius:16,border:`1px solid ${T.congeBorder}`}}><div><div style={{fontSize:15,fontWeight:800,color:T.congeText}}>{r.from===r.to?fmtD(r.from):`${fmtD(r.from)} → ${fmtD(r.to)}`}</div><div style={{fontSize:12,color:T.congeText,opacity:0.8,marginTop:4,fontWeight:600}}>{r.count} jour(s) de fermeture</div></div><button onClick={()=>{const ds=[];let cur=new Date(r.from+"T12:00:00");const last=new Date(r.to+"T12:00:00");while(cur<=last){ds.push(fd(cur));cur=new Date(cur);cur.setDate(cur.getDate()+1);}setSalon({...salon,fermetures_annuelles:(salon.fermetures_annuelles||[]).filter(x=>!ds.includes(x))});}} style={{background:"none",border:"none",cursor:"pointer",color:T.congeText,padding:8,display:"flex"}}><X size={18}/></button></div>))}</div>{totalFerm>0&&<button onClick={()=>setSalon({...salon,fermetures_annuelles:[]})} style={{marginTop:16,background:"none",border:"none",cursor:"pointer",fontSize:13,fontWeight:600,color:T.text3,textDecoration:"underline"}}>Tout supprimer</button>}</div>
  <div className="glass-panel" style={{padding:32,marginBottom:24}}><div style={{display:"flex",alignItems:"center",gap:12,marginBottom:8}}><div style={{width:22,height:22,borderRadius:6,background:T.accent}}/><span style={{fontSize:18,fontWeight:800,color:T.text}}>Couleur principale</span><span style={{fontSize:12,fontWeight:800,color:T.accent,background:T.accent+"15",borderRadius:12,padding:"4px 10px",marginLeft:"auto",fontFamily:"monospace"}}>{salon.accentColor||"#B8965A"}</span></div><p style={{fontSize:14,color:T.text2,marginBottom:24,lineHeight:1.5,fontWeight:500}}>Choisissez la teinte de l'interface (boutons, bordures, icônes).</p><div style={{display:"grid",gridTemplateColumns:"repeat(19,1fr)",gap:4}}>{COLORS.map(col=>{const sel=(salon.accentColor||"#B8965A")===col;return(<div key={col} onClick={async()=>{setSalon({...salon,accentColor:col});await fbPatch("config_salon",{accentColor:col});}} style={{width:"100%",aspectRatio:"1",borderRadius:sel?8:6,background:col,cursor:"pointer",border:sel?`3px solid ${T.text}`:"2px solid transparent",boxShadow:sel?`0 0 12px ${col}60`:"none",transform:sel?"scale(1.15)":"scale(1)",transition:"all 0.2s ease",position:"relative",zIndex:sel?2:1}}></div>);})}</div></div>
  <div style={{marginTop:32,display:"flex",justifyContent:"flex-end"}}><Btn variant="dark" icon={Save} T={T} onClick={async()=>{const cfg={nom_salon:salon.nom||"Maniatis",adresse:salon.adresse||"",jours_fermes:(salon.jours_fermes||[]).join(","),horaires_ouverture:Object.fromEntries(JALL.filter(j=>!salon.jours_fermes?.includes(j)).map(j=>[j,`${salon.ouverture||"09:30"}-${salon.fermeture||"19:00"}`])),fermetures_annuelles:salon.fermetures_annuelles||[],pause:salon.pause||"12:30-13:30"};await fbPatch("config_salon",cfg);setShowSaved(true);setTimeout(()=>setShowSaved(false),3000);}}>Sauvegarder les paramètres</Btn></div><SuccessToast open={showSaved} message="Configuration sauvegardée ✓" T={T}/></div>);
}

/* DASHBOARD PAGE */
function Dashboard({rdvs,coiffeurs,prestations,clients,T}){
  const conf=rdvs.filter(r=>r.statut==="confirme"),totalCA=conf.reduce((s,r)=>s+r.prix_total,0),avgT=conf.length?Math.round(totalCA/conf.length):0,bySrc={},srcL={telephone_ia:"Agent IA",widget_web:"Widget Web",sur_place:"Sur place"},srcC={telephone_ia:"#B8965A",widget_web:"#1C1917",sur_place:"#8C7A5E"};conf.forEach(r=>{bySrc[r.source]=(bySrc[r.source]||0)+1;});const byCo=coiffeurs.map(c=>{const cr=conf.filter(r=>r.coiffeur_id===c.id);return{...c,count:cr.length,ca:cr.reduce((s,r)=>s+r.prix_total,0)};}).sort((a,b)=>b.ca-a.ca);const byP={};conf.forEach(r=>{byP[r.prestations_noms]=(byP[r.prestations_noms]||0)+1;});const topP=Object.entries(byP).sort((a,b)=>b[1]-a[1]).slice(0,8),maxP=topP.length?topP[0][1]:1,byCat={femme:0,homme:0,enfant:0};conf.forEach(r=>{try{JSON.parse(r.prestations_ids).forEach(id=>{const p=prestations.find(x=>x.id===id);if(p)byCat[p.categorie]++;});}catch(e){}});const totCat=byCat.femme+byCat.homme+byCat.enfant||1,catC={femme:"#B8965A",homme:"#1C1917",enfant:"#D4B87A"};const byDay={};conf.forEach(r=>{const d=r.date_heure.split('T')[0];byDay[d]=(byDay[d]||0)+1;});const days=Object.keys(byDay).sort(),maxD=Math.max(...Object.values(byDay),1);
  const Card=({title,icon:Ic,children})=>(<div className="glass-panel" style={{overflow:"hidden"}}><div style={{padding:"20px 24px",borderBottom:`1px solid rgba(0,0,0,0.05)`,display:"flex",alignItems:"center",gap:12}}><Ic size={20} color={T.accent}/><span style={{fontSize:16,fontWeight:800,color:T.text}}>{title}</span></div><div style={{padding:24}}>{children}</div></div>);
  return(<div style={{overflow:"auto",flex:1,padding:"24px max(24px, calc((100% - 1100px) / 2))"}}><div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(220px,1fr))",gap:20,marginBottom:32}}>{[{l:"CA Total",v:`${totalCA.toLocaleString()}€`,i:DollarSign,g:"linear-gradient(135deg, #B8965A, #CAAB7A)"},{l:"Total RDV",v:conf.length,i:Calendar,g:"linear-gradient(135deg, #1C1917, #333)"},{l:"Panier moyen",v:`${avgT}€`,i:TrendingUp,g:"linear-gradient(135deg, #A08C6C, #8C7A5E)"},{l:"Clients actifs",v:clients.length,i:Users,g:"linear-gradient(135deg, #8A8681, #57534E)"}].map(k=>(<div key={k.l} className="glass-panel" style={{padding:"24px",display:"flex",alignItems:"center",gap:20}}><div style={{width:56,height:56,borderRadius:16,background:k.g,display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 4px 16px rgba(0,0,0,0.1)"}}><k.i size={24} color="#fff"/></div><div><div style={{fontSize:28,fontWeight:800,color:T.text,lineHeight:1}}>{k.v}</div><div style={{fontSize:13,color:T.text2,fontWeight:600,marginTop:6}}>{k.l}</div></div></div>))}</div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:24}}><Card title="CA par coiffeur" icon={BarChart3}>{byCo.map(c=>(<div key={c.id} style={{marginBottom:16}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:8}}><span style={{fontSize:14,fontWeight:700,color:T.text}}>{cLabel(c)}</span><span style={{fontSize:14,fontWeight:800,color:c.couleur}}>{c.ca}€</span></div><div style={{height:10,background:"rgba(0,0,0,0.05)",borderRadius:5,overflow:"hidden"}}><div style={{height:"100%",width:`${totalCA>0?c.ca/totalCA*100:0}%`,background:c.couleur,borderRadius:5}}/></div></div>))}</Card><Card title="Source des RDV" icon={PieChart}>{Object.entries(bySrc).sort((a,b)=>b[1]-a[1]).map(([k,v])=>(<div key={k} style={{display:"flex",alignItems:"center",gap:16,marginBottom:20}}><div style={{width:12,height:12,borderRadius:6,background:srcC[k]||T.text3}}/><span style={{fontSize:15,fontWeight:700,color:T.text,flex:1}}>{srcL[k]||k}</span><span style={{fontSize:24,fontWeight:800,color:T.text}}>{v}</span><span style={{fontSize:13,color:T.text2,fontWeight:600}}>{conf.length?Math.round(v/conf.length*100):0}%</span></div>))}</Card><Card title="Top prestations" icon={Scissors}>{topP.map(([n,c])=>(<div key={n} style={{marginBottom:16}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:8}}><span style={{fontSize:14,fontWeight:600,color:T.text}}>{n}</span><span style={{fontSize:14,fontWeight:800,color:T.accent}}>{c}</span></div><div style={{height:8,background:"rgba(0,0,0,0.05)",borderRadius:4,overflow:"hidden"}}><div style={{height:"100%",width:`${c/maxP*100}%`,background:T.accent,borderRadius:4}}/></div></div>))}</Card><Card title="Répartition H/F/Enfant" icon={Users}><div style={{display:"flex",gap:8,marginBottom:24}}>{Object.entries(byCat).map(([k,v])=><div key={k} style={{flex:v/totCat,height:16,background:catC[k],borderRadius:8,minWidth:v>0?12:0}}/>)}</div><div style={{display:"flex",gap:24}}>{Object.entries(byCat).map(([k,v])=>(<div key={k} style={{display:"flex",alignItems:"center",gap:8}}><div style={{width:10,height:10,borderRadius:5,background:catC[k]}}/><span style={{fontSize:14,fontWeight:700,color:T.text,textTransform:"capitalize"}}>{k}</span><span style={{fontSize:14,fontWeight:800,color:T.text2}}>{Math.round(v/totCat*100)}%</span></div>))}</div></Card><div style={{gridColumn:"1/-1"}}><Card title="RDV par jour (30 derniers jours)" icon={Activity}><div style={{display:"flex",alignItems:"flex-end",gap:6,height:160}}>{days.slice(-30).map(d=>{const v=byDay[d];return(<div key={d} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",gap:6}}><span style={{fontSize:11,fontWeight:800,color:T.accent}}>{v}</span><div style={{width:"100%",maxWidth:40,height:`${v/maxD*100}%`,minHeight:6,background:T.accentBg,borderRadius:6}}/><span style={{fontSize:10,color:T.text2,fontWeight:700}}>{JC[new Date(d).getDay()]}</span></div>);})}</div></Card></div></div></div>);
}

/* MAIN APP */
function App(){
  const [curDate,setCurDate]=useState(new Date());const [view,setViewRaw]=useState(()=>localStorage.getItem("mp_view")||"week");
  const [page,setPageRaw]=useState(()=>{const h=window.location.hash.slice(1);return["planning","clients","prestations","coiffeurs","salon","dashboard"].includes(h)?h:"planning";});
  const setPage=(p)=>{setPageRaw(p);window.location.hash=p;};
  const [cfState,setCfState]=useState([]);const [layout,setLayoutRaw]=useState(()=>localStorage.getItem("mp_layout")||"stack");
  const setLayout=(l)=>{setLayoutRaw(l);localStorage.setItem("mp_layout",l);};
  const setView=(v)=>{setViewRaw(v);localStorage.setItem("mp_view",v);};
  const [rdvs,setRdvs]=useState([]),[clients,setClients]=useState([]),[prestations,setPrestas]=useState([]),[coiffeurs,setCoiffeurs]=useState([]),[salon,setSalon]=useState({ouverture:"09:30",fermeture:"19:00",jours_fermes:["lundi","dimanche"],specialisations:[],fermetures_annuelles:[],accentColor:"#B8965A"});
  const [loading,setLoading]=useState(true),[fbErr,setFbErr]=useState(null),[selRdv,setSelRdv]=useState(null),[showCr,setShowCr]=useState(false),[crDef,setCrDef]=useState({}),[specFilter,setSpecFilter]=useState(null);

  const loadData=useCallback(async(initial)=>{try{const[cfData,prData,clData,rdvData,cfgData]=await Promise.all([fb("coiffeurs"),fb("prestations"),fb("clients"),fb("rdv"),fb("config_salon")]);const co=transformCoiffeurs(cfData),pr=transformPrestations(prData),cl=transformClients(clData),rv=transformRdvs(rdvData),sa=transformSalon(cfgData,co);setCoiffeurs(co);setPrestas(pr);setClients(cl);setRdvs(rv);setSalon(sa);if(initial)setLoading(false);setFbErr(null);}catch(e){setFbErr(e.message);if(initial)setLoading(false);}},[]);
  useEffect(()=>{loadData(true);},[loadData]);useEffect(()=>{const iv=setInterval(()=>loadData(false),15000);return()=>clearInterval(iv);},[loadData]);
  const specList=useMemo(()=>[...new Set(prestations.filter(p=>p.actif&&p.specialisation).map(p=>p.specialisation))].sort(),[prestations]);
  useEffect(()=>{if(specFilter&&!specList.includes(specFilter))setSpecFilter(null);},[specList,specFilter]);

  const nav=dir=>{const d=new Date(curDate);if(view==="day")d.setDate(d.getDate()+dir);else if(view==="week")d.setDate(d.getDate()+7*dir);else d.setMonth(d.getMonth()+dir);setCurDate(d);};
  const titleStr=()=>{if(view==="day")return`${JOURS[curDate.getDay()]} ${curDate.getDate()} ${MOIS[curDate.getMonth()]}`;if(view==="week"){const ws=wkStart(curDate),we=new Date(ws);we.setDate(ws.getDate()+6);return`${ws.getDate()} ${ws.getMonth()===we.getMonth()?'':MOIS[ws.getMonth()].substring(0,3)} — ${we.getDate()} ${MOIS[we.getMonth()]}`;}return`${MOIS[curDate.getMonth()]} ${curDate.getFullYear()}`;};
  const allSel=cfState.length===0;
  const toggleAll=()=>{if(allSel)setCfState(["__none__"]);else setCfState([]);},toggleCF=id=>{if(cfState.length===0)setCfState(coiffeurs.filter(c=>c.actif&&c.id!==id).map(c=>c.id));else if(cfState.includes("__none__"))setCfState([id]);else{const nf=cfState.includes(id)?cfState.filter(c=>c!==id):[...cfState,id];if(nf.length===0)setCfState(["__none__"]);else if(nf.length===coiffeurs.filter(c=>c.actif).length)setCfState([]);else setCfState(nf);}};
  const ef=(()=>{let base=cfState.includes("__none__")?["__none__"]:cfState;if(!specFilter)return base;const specIds=coiffeurs.filter(c=>c.actif&&c.specialisations?.includes(specFilter)).map(c=>c.id);if(specIds.length===0)return["__none__"];if(base.length===0)return specIds;if(base.includes("__none__"))return["__none__"];const inter=base.filter(id=>specIds.includes(id));return inter.length===0?["__none__"]:inter;})();
  const clickSlot=(day,h,m,coifId)=>{setCrDef({date:day,hour:h,min:m,coif:coifId||""});setShowCr(true);};
  const [toast,setToast]=useState(null);const showToast=(msg,type="success")=>{setToast({msg,type});setTimeout(()=>setToast(null),3000);};
  
  const handleDragDrop=async(rdvId,newDay,newH,newM,newCoifId)=>{const rdv=rdvs.find(r=>r.id===rdvId);if(!rdv)return;const newDateHeure=`${fd(newDay)}T${String(newH).padStart(2,"0")}:${String(newM).padStart(2,"0")}:00`,data={date_heure:newDateHeure};if(newCoifId&&newCoifId!==rdv.coiffeur_id){const newCo=coiffeurs.find(c=>c.id===newCoifId);data.coiffeur_id=newCoifId;data.coiffeur_prenom=newCo?.prenom||"";}setRdvs(rdvs.map(r=>r.id===rdvId?{...r,...data}:r));showToast(`RDV déplacé → ${String(newH).padStart(2,"0")}h${String(newM).padStart(2,"0")}`);try{await fbPatch(`rdv/${rdvId}`,data);await fbPatch(`rdv_confirmes/${rdvId}`,{coiffeur_id:data.coiffeur_id||rdv.coiffeur_id,date_heure:newDateHeure,duree_totale_minutes:rdv.duree_totale_minutes});}catch(err){}};
  const createRdv=async({client,coiffeur_id,prestation,date,time})=>{const co=coiffeurs.find(c=>c.id===coiffeur_id),rdvId=genRdvId(),phone=(client.telephone||"").replace("+",""),endMin=(parseInt(time.split(":")[0])*60+parseInt(time.split(":")[1]))+(prestation?.duree_minutes||60),dateHeure=`${date}T${time}:00`,dateHeureFin=`${date}T${String(Math.floor(endMin/60)).padStart(2,"0")}:${String(endMin%60).padStart(2,"0")}:00`,rdvData={client_id:client.id||phone,client_nom:client.nom,client_prenom:client.prenom,client_telephone:phone,coiffeur_id,coiffeur_prenom:co?.prenom||"",prestations_noms:prestation?.nom_court||"",prestations_ids:JSON.stringify([prestation?.id||""]),date_heure:dateHeure,duree_totale_minutes:prestation?.duree_minutes||60,prix_total:prestation?.prix||0,statut:"confirme",source:"sur_place",created_at:new Date().toISOString()};setRdvs(prev=>[...prev,{...rdvData,id:rdvId}]);const updates={};updates[`rdv/${rdvId}`]=rdvData;updates[`rdv_confirmes/${rdvId}`]={coiffeur_id,date_heure:dateHeure,duree_totale_minutes:prestation?.duree_minutes||60};await fbMultiPatch(updates);showToast("Rendez-vous créé !");};
  const navItems=[{id:"planning",l:"Agenda",i:Calendar},{id:"clients",l:"Clients",i:Users},{id:"prestations",l:"Prestations",i:Scissors},{id:"coiffeurs",l:"Équipe",i:User},{id:"salon",l:"Salon",i:Store},{id:"dashboard",l:"Dashboard",i:BarChart3}];

  if(loading)return(<div style={{height:"100vh",display:"flex",alignItems:"center",justifyContent:"center",color:T.accent}}><div className="spinner" style={{width:40,height:40,border:`4px solid ${T.accent}40`,borderTopColor:T.accent,borderRadius:"50%",animation:"spin 0.8s linear infinite"}}></div></div>);

  return(
    <div style={{height:"100vh",display:"flex",flexDirection:"column",position:"relative",zIndex:10}}>
      {fbErr&&<div style={{background:"#FEF2F2",padding:"12px",fontSize:14,fontWeight:600,color:"#991B1B",textAlign:"center",borderBottom:"1px solid #FECACA"}}>Erreur Firebase: {fbErr} <button onClick={()=>loadData(false)} style={{marginLeft:12,padding:"4px 12px",borderRadius:8,background:"#991B1B",color:"#FFF",border:"none",cursor:"pointer"}}>Réessayer</button></div>}

      <header className="glass-panel" style={{margin:"20px", marginBottom:"0", padding:"16px 24px", display:"flex", alignItems:"center", gap:24, flexShrink:0, borderRadius:24}}>
        <div style={{display:"flex",alignItems:"center",gap:16}}>
          <div style={{width:48,height:48,borderRadius:16,background:T.accent,boxShadow:`0 4px 16px ${T.accent}40`,display:"flex",alignItems:"center",justifyContent:"center"}}><Scissors size={24} color="#FFF"/></div>
          <div style={{fontSize:24,fontWeight:800,letterSpacing:"-0.03em",color:T.text}}>{(salon.nom||"Maniatis").split(" - ")[0]}</div></div>
        <div style={{width:1,height:32,background:"rgba(0,0,0,0.08)"}}/>
        <nav style={{display:"flex",gap:8}}>{navItems.map(n=>(
          <button key={n.id} onClick={()=>setPage(n.id)} style={{display:"flex",alignItems:"center",gap:8,padding:"10px 18px",borderRadius:16,border:"none",fontSize:14,fontWeight:700,cursor:"pointer",
            background:page===n.id?"rgba(0,0,0,0.05)":"transparent",color:page===n.id?T.text:T.text2, transition:"all 0.2s"}}
            onMouseEnter={e=>!page===n.id&&(e.currentTarget.style.background="rgba(0,0,0,0.03)")} onMouseLeave={e=>!page===n.id&&(e.currentTarget.style.background="transparent")}>
            <n.i size={18}/>{n.l}</button>))}</nav>
        <div style={{flex:1}}/>
        {page==="planning"&&(<div style={{display:"flex",alignItems:"center",gap:16}}>
          <div style={{display:"flex",gap:4,borderRadius:14,padding:4,background:"rgba(0,0,0,0.03)",border:"1px solid rgba(0,0,0,0.04)"}}>
            {[{id:"day",l:"Jour"},{id:"week",l:"Sem."}, {id:"month",l:"Mois"}].map(v=><button key={v.id} onClick={()=>setView(v.id)}
              style={{padding:"8px 16px",borderRadius:10,border:"none",fontSize:13,fontWeight:700,cursor:"pointer",
                background:view===v.id?"#FFF":"transparent",color:view===v.id?T.text:T.text2,boxShadow:view===v.id?"0 2px 8px rgba(0,0,0,0.05)":"none"}}>{v.l}</button>)}</div>
          <div style={{display:"flex",gap:4,borderRadius:14,padding:4,background:"rgba(0,0,0,0.03)",border:"1px solid rgba(0,0,0,0.04)"}}>
            {[{id:"stack",l:"Fusionné"},{id:"sbs",l:"Séparé"}].map(v=><button key={v.id} onClick={()=>setLayout(v.id)}
              style={{padding:"8px 16px",borderRadius:10,border:"none",fontSize:13,fontWeight:700,cursor:"pointer",
                background:layout===v.id?"#FFF":"transparent",color:layout===v.id?T.text:T.text2,boxShadow:layout===v.id?"0 2px 8px rgba(0,0,0,0.05)":"none"}}>{v.l}</button>)}</div>
          <Btn variant="dark" icon={Plus} onClick={()=>{setCrDef({});setShowCr(true);}} T={T}>Nouveau RDV</Btn></div>)}
      </header>

      {page==="planning"&&(
        <div style={{flex:1,display:"flex",flexDirection:"column",padding:"24px 20px",gap:24,overflow:"hidden"}}>
          <div style={{display:"flex",alignItems:"center",gap:20,flexWrap:"wrap",flexShrink:0}}>
            <div style={{display:"flex",alignItems:"center",gap:4, padding:"6px", borderRadius:"16px", background:"rgba(0,0,0,0.03)", border:"1px solid rgba(0,0,0,0.04)"}}>
              <button onClick={()=>nav(-1)} style={{background:"transparent",border:"none",borderRadius:10,padding:8,cursor:"pointer",display:"flex",color:T.text2}}><ChevronLeft size={20}/></button>
              <button onClick={()=>setCurDate(new Date())} style={{background:"transparent",border:"none",borderRadius:10,padding:"8px 16px",cursor:"pointer",fontSize:14,fontWeight:800,color:T.text}}>Aujourd'hui</button>
              <button onClick={()=>nav(1)} style={{background:"transparent",border:"none",borderRadius:10,padding:8,cursor:"pointer",display:"flex",color:T.text2}}><ChevronRight size={20}/></button></div>
            <h1 style={{fontSize:28,fontWeight:800,margin:0,letterSpacing:"-0.03em"}}>{titleStr()}</h1>
            <div style={{flex:1}}/>
            
            <div style={{display:"flex",alignItems:"center",gap:6, padding:"6px", borderRadius:"16px", background:"rgba(0,0,0,0.03)", border:"1px solid rgba(0,0,0,0.04)"}}>
              <Filter size={16} color={specFilter?T.accent:T.text3} style={{marginLeft:8}}/>
              {specList.map(s=>{const active=specFilter===s,matchCount=coiffeurs.filter(c=>c.actif&&c.specialisations?.includes(s)).length;
                return(<button key={s} onClick={()=>setSpecFilter(active?null:s)}
                  style={{padding:"6px 14px",borderRadius:12,border:"none",background:active?"#FFF":"transparent",color:active?T.accent:T.text2,boxShadow:active?"0 2px 8px rgba(0,0,0,0.05)":"none",fontSize:12,fontWeight:700,cursor:"pointer",textTransform:"capitalize",display:"flex",alignItems:"center",gap:6}}>
                  {s}<span style={{fontSize:10,background:"rgba(0,0,0,0.05)",padding:"2px 6px",borderRadius:"6px"}}>{matchCount}</span></button>);})}
            </div>
            
            <button className="btn-ghost" onClick={toggleAll}>{allSel?<Eye size={16}/>:<EyeOff size={16}/>}{allSel?"Tout masquer":"Tout afficher"}</button>
            <div className="glass-panel" style={{display:"flex",gap:6, padding:"6px", borderRadius:"18px"}}>{coiffeurs.filter(c=>c.actif).map(c=>{const isA=ef.length===0||ef.includes(c.id),matchesSpec=!specFilter||c.specialisations?.includes(specFilter);
              return(<button key={c.id} onClick={()=>toggleCF(c.id)} style={{display:"flex",alignItems:"center",gap:8,padding:"8px 14px",borderRadius:12,cursor:"pointer",border:"none",background:isA?"rgba(0,0,0,0.04)":"transparent",opacity:isA?1:matchesSpec?0.4:0.2,color:isA?c.couleur:T.text2,fontWeight:700,transition:"all 0.2s"}}>
                <div style={{width:10,height:10,borderRadius:5,background:c.couleur}}/><span style={{fontSize:13}}>{cLabel(c)}</span></button>);})}</div>
          </div>
          <Indicators rdvs={rdvs} view={view} currentDate={curDate} cf={ef} coiffeurs={coiffeurs} salon={salon} T={T}/>
          
          <div style={{flex:1,overflow:"hidden",display:"flex",flexDirection:"column"}}>
            {view==="week"&&layout==="stack"&&<WeekView currentDate={curDate} rdvs={rdvs} cf={ef} coiffeurs={coiffeurs} onSlot={clickSlot} onRdv={setSelRdv} onDragDrop={handleDragDrop} salon={salon} T={T}/>}
            {view==="week"&&layout==="sbs"&&<WeekSbsView currentDate={curDate} rdvs={rdvs} cf={ef} coiffeurs={coiffeurs} onSlot={clickSlot} onRdv={setSelRdv} salon={salon} T={T}/>}
            {view==="day"&&layout==="stack"&&<DayStackView currentDate={curDate} rdvs={rdvs} cf={ef} coiffeurs={coiffeurs} onSlot={clickSlot} onRdv={setSelRdv} salon={salon} T={T}/>}
            {view==="day"&&layout==="sbs"&&<DayView currentDate={curDate} rdvs={rdvs} cf={ef} coiffeurs={coiffeurs} onSlot={clickSlot} onRdv={setSelRdv} onDragDrop={handleDragDrop} salon={salon} T={T}/>}
            {view==="month"&&layout==="stack"&&<MonthView currentDate={curDate} rdvs={rdvs} cf={ef} coiffeurs={coiffeurs} onDay={d=>{setCurDate(d);setView("day");}} salon={salon} T={T}/>}
            {view==="month"&&layout==="sbs"&&<MonthSbsView currentDate={curDate} rdvs={rdvs} cf={ef} coiffeurs={coiffeurs} onDay={d=>{setCurDate(d);setView("day");}} salon={salon} T={T}/>}
          </div>
        </div>
      )}
      
      {page==="clients"&&<ClientsP clients={clients} setClients={setClients} rdvs={rdvs} coiffeurs={coiffeurs} prestations={prestations} T={T}/>}
      {page==="prestations"&&<PrestationsP prestations={prestations} setPrestations={setPrestas} salon={salon} T={T}/>}
      {page==="coiffeurs"&&<CoiffeursP coiffeurs={coiffeurs} setCoiffeurs={setCoiffeurs} salon={salon} T={T}/>}
      {page==="salon"&&<SalonP salon={salon} setSalon={setSalon} T={T}/>}
      {page==="dashboard"&&<Dashboard rdvs={rdvs} coiffeurs={coiffeurs} prestations={prestations} clients={clients} T={T}/>}

      <RdvDetail rdv={selRdv} open={!!selRdv} onClose={()=>setSelRdv(null)} onCancel={async id=>{setRdvs(rdvs.map(r=>r.id===id?{...r,statut:"annule"}:r));await fbMultiPatch({[`rdv/${id}/statut`]:"annule",[`rdv_confirmes/${id}`]:null});showToast("Rendez-vous annulé");}} onUpdate={async(id,data)=>{setRdvs(rdvs.map(r=>r.id===id?{...r,...data}:r));const oldRdv=rdvs.find(r=>r.id===id);await fbPatch(`rdv/${id}`,data);await fbPatch(`rdv_confirmes/${id}`,{coiffeur_id:data.coiffeur_id||oldRdv?.coiffeur_id,date_heure:data.date_heure||oldRdv?.date_heure,duree_totale_minutes:data.duree_totale_minutes||oldRdv?.duree_totale_minutes});showToast("Rendez-vous mis à jour");}} coiffeurs={coiffeurs} prestations={prestations} clients={clients} salon={salon} T={T}/>
      <CreateRdv open={showCr} onClose={()=>setShowCr(false)} onCreate={createRdv} iDate={crDef.date} iHour={crDef.hour} iMin={crDef.min} iCoif={crDef.coif||""} coiffeurs={coiffeurs} prestations={prestations} clients={clients} rdvs={rdvs} salon={salon} T={T}/>
      <SuccessToast open={!!toast} message={toast?.msg} T={T}/>
    </div>
  );
}

try { ReactDOM.createRoot(document.getElementById('root')).render(<App/>); } catch(e) { document.getElementById('root').innerHTML = '<pre style="color:red;padding:20px">'+e.message+'\n'+e.stack+'</pre>'; }
</script>
</body>
</html>
