<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Réserver — Salon Maniatis Paris</title>
  <link rel="icon" type="image/png" href="data:image/png;base64,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" />
  <meta name="description" content="Prenez rendez-vous en ligne au salon de coiffure Maniatis, rue de Sèvres, Paris 6e" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  
  <style>
    :root {
      /* Palette Premium Gold & Glass */
      --bg-warm: #FAF8F5; /* Fond sable chaud très pâle */
      --glass-bg: rgba(255, 255, 255, 0.65); /* Transparence pour l'effet verre */
      --glass-border: 1px solid rgba(255, 255, 255, 0.4);
      --gold-primary: #B8965A;
      --gold-light: rgba(184, 150, 90, 0.12);
      --text-dark: #1C1917;
      --text-medium: #57534E;
      --shadow-glass: 0 8px 32px 0 rgba(31, 38, 135, 0.07); /* Ombre douce et colorée */
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    ::selection { background: var(--gold-light); color: var(--gold-primary); }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(16px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
    
    body { 
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background-color: var(--bg-warm);
      /* Optionnel : un dégradé subtil pour plus de richesse */
      background-image: linear-gradient(to bottom right, #FAF8F5, #F2EFE9);
      color: var(--text-dark); 
      min-height: 100vh; 
      display: flex; 
      justify-content: center;
      -webkit-font-smoothing: antialiased;
    }
    
    #root { width: 100%; max-width: 500px; padding: 32px 20px; }
    
    /* Typographie */
    .heading { font-weight: 700; font-size: 30px; letter-spacing: -0.03em; line-height: 1.15; margin: 0 0 8px; color: var(--text-dark); }
    .heading-sm { font-size: 24px; letter-spacing: -0.02em; }
    .sub { color: var(--text-medium); font-size: 15px; margin: 0 0 32px; line-height: 1.5; font-weight: 500; }
    
    /* LE CŒUR DU DESIGN : GLASSMORPHISM CARDS */
    .card { 
      background: var(--glass-bg);
      backdrop-filter: blur(16px); /* L'effet verre dépoli */
      -webkit-backdrop-filter: blur(16px); /* Pour Safari */
      border-radius: 24px; /* Arrondis généreux */
      border: var(--glass-border);
      padding: 20px; 
      cursor: pointer; 
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      box-shadow: var(--shadow-glass);
      overflow: hidden;
      position: relative;
    }
    .card::before { /* Reflet subtil en haut à gauche */
        content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
        background: linear-gradient(90deg, rgba(255,255,255,0.8), rgba(255,255,255,0));
    }
    .card:hover { 
      transform: translateY(-3px) scale(1.01);
      box-shadow: 0 12px 40px rgba(31, 38, 135, 0.12);
      border-color: rgba(184, 150, 90, 0.3); /* Légère teinte dorée au survol */
    }
    .card.selected { 
      border: 1.5px solid var(--gold-primary);
      background: rgba(184, 150, 90, 0.05); /* Fond légèrement doré */
    }
    
    /* Boutons */
    .btn { 
      background: var(--text-dark); /* Noir profond pour le contraste */
      color: #FFF; 
      border: none; 
      border-radius: 18px; 
      padding: 18px 32px; 
      font-size: 16px; 
      font-weight: 600; 
      cursor: pointer; 
      width: 100%; 
      transition: all 0.25s ease;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    .btn:hover:not(:disabled) { 
        transform: translateY(-2px); 
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        background: linear-gradient(45deg, var(--text-dark), #333);
    }
    .btn-gold { 
        background: var(--gold-primary);
        box-shadow: 0 4px 16px rgba(184, 150, 90, 0.3);
    }
    .btn-gold:hover:not(:disabled) {
        background: linear-gradient(45deg, var(--gold-primary), #CAAB7A);
        box-shadow: 0 8px 24px rgba(184, 150, 90, 0.4);
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

    .btn-outline { 
      background: var(--glass-bg);
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      color: var(--text-dark); 
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 14px; 
      padding: 12px 16px; 
      font-size: 14px; 
      font-weight: 600; 
      cursor: pointer; 
      transition: all 0.2s; 
    }
    .btn-outline:hover { 
      border-color: var(--gold-primary); 
      color: var(--gold-primary); 
      background: var(--gold-light);
    }
    
    .btn-back { 
      background: none; border: none; color: var(--text-medium); cursor: pointer; font-size: 14px; font-weight: 600; padding: 8px 0; margin-bottom: 24px; display: inline-flex; align-items: center; gap: 8px; transition: color 0.2s;
    }
    .btn-back:hover { color: var(--gold-primary); }
    
    /* Inputs façon verre */
    .input-field { 
      width: 100%; 
      padding: 16px 18px; 
      border-radius: 16px; 
      border: 1px solid rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.5); /* Semi-transparent */
      font-size: 16px; 
      font-family: 'Inter', sans-serif; 
      outline: none; 
      transition: all 0.2s;
      color: var(--text-dark);
    }
    .input-field:focus { 
        border-color: var(--gold-primary); 
        background: #FFF;
        box-shadow: 0 0 0 4px var(--gold-light); 
    }
    
    .label { font-size: 13px; font-weight: 700; color: var(--text-dark); display: block; margin-bottom: 10px; letter-spacing: 0.02em; }
    .label-up { font-size: 11px; font-weight: 700; color: var(--text-medium); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 6px; }
    
    /* Navigation Dots Dorés */
    .dots { display: flex; gap: 8px; justify-content: center; margin-bottom: 40px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(0,0,0,0.1); transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    .dot.active { background: var(--gold-primary); width: 32px; border-radius: 100px; }
    .dot.done { background: #D4B87A; }
    
    .spinner { width: 32px; height: 32px; border: 3px solid rgba(184, 150, 90, 0.2); border-top: 3px solid var(--gold-primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 48px auto; }
    
    .error-bar { background: #FEF2F2; border: 1px solid #FECACA; border-radius: 16px; padding: 16px; margin-bottom: 24px; font-size: 14px; color: #991B1B; display: flex; justify-content: space-between; align-items: center; animation: fadeInUp 0.3s; font-weight: 500; }
    
    .step { animation: fadeInUp 0.5s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; }
    .flex-col { display: flex; flex-direction: column; }
    
    .icon-circle { width: 52px; height: 52px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 22px; background: linear-gradient(135deg, #FFF, #F8F5F1); box-shadow: 0 4px 12px rgba(0,0,0,0.06); color: var(--gold-primary); border: 1px solid rgba(255,255,255,0.8); }
    .icon-sm { width: 46px; height: 46px; font-size: 18px; }
    
    .check-box { width: 24px; height: 24px; border-radius: 8px; border: 2px solid rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
    .check-box.checked { border-color: var(--gold-primary); background: var(--gold-primary); box-shadow: 0 2px 8px rgba(184, 150, 90, 0.4); }
    
    /* Calendrier Glass */
    .cal-container { background: var(--glass-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-radius: 24px; border: var(--glass-border); padding: 24px; margin-bottom: 20px; box-shadow: var(--shadow-glass); }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; margin-top: 16px; }
    .cal-day { width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; user-select: none; position: relative; }
    .cal-day:hover:not(.disabled):not(.sel) { background: var(--gold-light); color: var(--gold-primary); }
    .cal-day.disabled { color: #D1D5DB; cursor: default; font-weight: 400; }
    .cal-day.sel { background: var(--gold-primary); color: #FFF; font-weight: 700; box-shadow: 0 4px 12px rgba(184, 150, 90, 0.4); }
    .cal-header { font-size: 12px; font-weight: 700; color: var(--text-medium); padding-bottom: 8px; text-transform: uppercase; letter-spacing: 0.1em; }
    .nav-month-btn { padding: 8px 12px; background: rgba(255,255,255,0.5); border-radius: 10px; transition: all 0.2s; }
    .nav-month-btn:hover { background: var(--gold-light); color: var(--gold-primary); }

    .slots-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; } /* 3 colonnes pour plus d'air */
    .slots-grid .btn-outline { width: 100%; text-align: center; padding: 14px 0; font-size: 15px; }
    
    .period-label { font-size: 12px; color: var(--text-dark); font-weight: 800; margin: 24px 0 12px; letter-spacing: 0.05em; text-transform: uppercase; display: flex; align-items: center; gap: 8px; }
    .period-label::after { content:''; height: 1px; flex: 1; background: rgba(0,0,0,0.08); }

    .footer { text-align: center; margin-top: 56px; padding-top: 24px; opacity: 0.6; transition: opacity 0.3s; }
    .footer:hover { opacity: 1; }
    .footer-brand { font-size: 13px; font-weight: 800; letter-spacing: 0.15em; color: var(--text-dark); text-transform: uppercase; }
    .footer-addr { font-size: 12px; color: var(--text-medium); margin-top: 6px; }
    
    .success-icon { width: 88px; height: 88px; border-radius: 50%; background: linear-gradient(135deg, var(--gold-primary), #D4B87A); display: flex; align-items: center; justify-content: center; margin: 0 auto 32px; font-size: 36px; color: #FFF; box-shadow: 0 12px 24px rgba(184, 150, 90, 0.3); }
    
    .scroll-list { max-height: calc(100vh - 280px); overflow-y: auto; padding: 4px; margin: -4px; }
    .scroll-list::-webkit-scrollbar { width: 4px; }
    .scroll-list::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 4px; }

    .spec-count { display: inline-flex; align-items: center; justify-content: center; background: var(--gold-light); color: var(--gold-primary); font-size: 12px; font-weight: 700; height: 20px; min-width: 20px; padding: 0 6px; border-radius: 10px; margin-left: 8px; }
    .pop-badge { display: inline-block; background: linear-gradient(135deg, var(--gold-primary), #D4B87A); color: #FFF; font-size: 10px; font-weight: 700; padding: 4px 8px; border-radius: 6px; margin-left: 8px; text-transform: uppercase; letter-spacing: 0.05em; box-shadow: 0 2px 6px rgba(184, 150, 90, 0.3); }
    .price-tag { font-weight: 700; fontSize: 16px; color: var(--gold-primary); }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.3.1/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.3.1/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.24.4/babel.min.js"></script>
  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    const FIREBASE_BASE = "https://salon-maniatis-default-rtdb.europe-west1.firebasedatabase.app";
    const FIREBASE_AUTH = "fqvk01y60VO7iuj1MkFGkrofwXTa1BJuIa62R4If";
    const N8N_WEBHOOK = "https://champain.app.n8n.cloud/webhook/agent-salon-coiffure-v4";

    const JOURS_H = ["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"];
    const MOIS = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
    const CLOSED = [0,1]; 
    const pad = n => String(n).padStart(2,"0");
    const toDS = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

    const STEPS = ["categorie","specialisation","prestation","coiffeur","date","info","confirmation","success"];

    const SPEC_CONFIG = {
      femme: [
        { id: "femme", label: "Coupe & Coiffage", desc: "Coupe, brushing, chignon, lissage…", icon: "✂" },
        { id: "coloriste", label: "Couleur & Technique", desc: "Coloration, balayage, mèches, diacolor…", icon: "✦" },
        { id: "_all", label: "Toutes les prestations", desc: "", icon: "☰" },
      ],
      homme: [
        { id: "homme", label: "Coupe & Coiffage", desc: "Coupe classique, coupe couture, défrisage…", icon: "✂" },
        { id: "barbier", label: "Barbe", desc: "Taille et entretien de barbe", icon: "◆" },
        { id: "coloriste", label: "Couleur", desc: "Coloration, cover…", icon: "✦" },
        { id: "_all", label: "Toutes les prestations", desc: "", icon: "☰" },
      ],
      enfant: []
    };

    function Dots({ current }) {
      const idx = STEPS.indexOf(current);
      return <div className="dots">{STEPS.slice(0,7).map((s,i) => <div key={s} className={`dot ${i===idx?'active':i<idx?'done':''}`}/>)}</div>;
    }

    function App() {
      const [step, setStep] = useState("categorie");
      const [prests, setPrests] = useState([]);
      const [coifs, setCoifs] = useState([]);
      const [popCount, setPopCount] = useState({});
      const [initLoading, setInitLoading] = useState(true);
      const [slotsLoading, setSlotsLoading] = useState(false);
      const [bookLoading, setBookLoading] = useState(false);
      const [error, setError] = useState(null);
      const [cat, setCat] = useState("");
      const [spec, setSpec] = useState("");
      const [selPrests, setSelPrests] = useState([]);
      const [selCoif, setSelCoif] = useState(null);
      const [selDate, setSelDate] = useState("");
      const [selSlot, setSelSlot] = useState(null);
      const [slots, setSlots] = useState([]);
      const [form, setForm] = useState({prenom:"",nom:"",telephone:""});
      const [booking, setBooking] = useState(null);
      const [mo, setMo] = useState(0);

      useEffect(() => {
        (async () => {
          try {
            const [pR, cR, rR] = await Promise.all([
              fetch(`${FIREBASE_BASE}/prestations.json?auth=${FIREBASE_AUTH}`),
              fetch(`${FIREBASE_BASE}/coiffeurs.json?auth=${FIREBASE_AUTH}`),
              fetch(`${FIREBASE_BASE}/rdv.json?auth=${FIREBASE_AUTH}`)
            ]);
            const pD = await pR.json(), cD = await cR.json(), rD = await rR.json();
            if (pD) setPrests(Object.entries(pD).map(([id,p])=>({id,...p})));
            if (cD) setCoifs(Object.entries(cD).map(([id,c])=>({id,...c})));

            if (rD && typeof rD === 'object') {
              const counts = {};
              Object.values(rD).forEach(rdv => {
                try {
                  const ids = JSON.parse(rdv.prestations_ids || '[]');
                  ids.forEach(id => { counts[id] = (counts[id] || 0) + 1; });
                } catch(e) {}
              });
              setPopCount(counts);
            }
          } catch(e) { setError("Impossible de charger les données du salon."); }
          setInitLoading(false);
        })();
      }, []);

      const loadSlots = useCallback(async (date) => {
        setSlotsLoading(true); setSlots([]);
        try {
          const r = await fetch(N8N_WEBHOOK, {method:"POST",headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
              args:{action:"get_available_slots",prestation_ids:selPrests,date_souhaitee:date,coiffeur_id:selCoif||""},
              call:{call_id:`web-${Date.now()}`}
            })});
          const d = await r.json();
          if (d.success) setSlots(d.all_creneaux || d.top_creneaux || []);
        } catch(e) { setError("Erreur lors du chargement des créneaux."); }
        setSlotsLoading(false);
      }, [selPrests, selCoif]);

      const confirmBooking = useCallback(async () => {
        setBookLoading(true);
        try {
          let phone = form.telephone.replace(/\s/g,"");
          if (phone.startsWith("0")) phone = "+33"+phone.substring(1);
          else if (!phone.startsWith("+")) phone = "+33"+phone;
          const r = await fetch(N8N_WEBHOOK, {method:"POST",headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
              args:{action:"create_booking",coiffeur_id:selSlot.coiffeur_id,prestation_ids:selPrests,date_heure:selSlot.date_heure_iso,nom:form.nom.toUpperCase(),prenom:form.prenom},
              call:{call_id:`web-${Date.now()}`,from_number:phone}
            })});
          const d = await r.json();
          if (d.success) { setBooking(d); setStep("success"); }
          else setError(d.message || "Erreur lors de la réservation.");
        } catch(e) { setError("Erreur réseau lors de la réservation."); }
        setBookLoading(false);
      }, [selSlot, selPrests, form]);

      const reset = () => { setStep("categorie"); setCat(""); setSpec(""); setSelPrests([]); setSelCoif(null); setSelDate(""); setSelSlot(null); setSlots([]); setForm({prenom:"",nom:"",telephone:""}); setBooking(null); setError(null); setMo(0); };

      const countPrestsForSpec = (specId) => {
        return prests.filter(p => p.categorie === cat && p.actif !== false && (specId === "_all" || p.specialisation_requise === specId)).length;
      };

      const getFilteredPrests = () => {
        return prests
          .filter(p => p.categorie === cat && p.actif !== false && (spec === "_all" || p.specialisation_requise === spec))
          .sort((a, b) => {
            const popA = popCount[a.id] || 0;
            const popB = popCount[b.id] || 0;
            if (popB !== popA) return popB - popA;
            return (a.ordre_affichage || 99) - (b.ordre_affichage || 99);
          });
      };

      if (initLoading) return <div className="spinner"/>;

      // ═══ CATÉGORIE ═══
      const renderCategorie = () => {
        const cats = [
          {id:"femme",label:"Femme",desc:"Coupe, couleur, brushing…",icon:"✦"},
          {id:"homme",label:"Homme",desc:"Coupe, barbe, couleur…",icon:"◆"},
          {id:"enfant",label:"Enfant",desc:"Coupe enfant",icon:"○"}
        ];
        return <div className="step">
          <h1 className="heading">Réserver</h1>
          <p className="sub">Salon Maniatis — Paris 6e</p>
          <div className="flex-col" style={{gap:16}}>
            {cats.map(c => <div key={c.id} className="card" onClick={()=>{
              setCat(c.id); setSpec(""); setSelPrests([]);
              if (SPEC_CONFIG[c.id].length === 0) { setSpec("_all"); setStep("prestation"); }
              else setStep("specialisation");
            }} style={{display:"flex",alignItems:"center",gap:20}}>
              <div className="icon-circle">{c.icon}</div>
              <div><div style={{fontWeight:700,fontSize:18}}>{c.label}</div><div style={{fontSize:15,color:"var(--text-medium)",marginTop:4}}>{c.desc}</div></div>
            </div>)}
          </div>
          <div className="footer"><div className="footer-brand">MANIATIS PARIS</div><div className="footer-addr">18 rue de Sèvres, 75007 Paris</div></div>
        </div>;
      };

      // ═══ SPÉCIALISATION ═══
      const renderSpecialisation = () => {
        const specs = SPEC_CONFIG[cat] || [];
        const catLabel = cat === "femme" ? "Femme" : cat === "homme" ? "Homme" : "Enfant";
        return <div className="step">
          <button className="btn-back" onClick={()=>{setStep("categorie");setCat("");setSpec("")}}>← Retour</button>
          <h1 className="heading heading-sm">Quel soin ?</h1>
          <p className="sub">Choisissez le type de prestation {catLabel.toLowerCase()}</p>
          <div className="flex-col" style={{gap:12}}>
            {specs.map(s => {
              const count = countPrestsForSpec(s.id);
              if (s.id !== "_all" && count === 0) return null;
              const totalCount = s.id === "_all" ? prests.filter(p=>p.categorie===cat&&p.actif!==false).length : count;
              return <div key={s.id} className="card" onClick={()=>{setSpec(s.id);setSelPrests([]);setStep("prestation")}} style={{display:"flex",alignItems:"center",gap:16}}>
                <div className="icon-circle icon-sm">{s.icon}</div>
                <div style={{flex:1}}>
                  <div style={{fontWeight:700,fontSize:16}}>
                    {s.label}
                    <span className="spec-count">{totalCount}</span>
                  </div>
                  {s.desc && <div style={{fontSize:14,color:"var(--text-medium)",marginTop:4}}>{s.desc}</div>}
                </div>
              </div>;
            })}
          </div>
        </div>;
      };

      // ═══ PRESTATION ═══
      const renderPrestation = () => {
        const filtered = getFilteredPrests();
        const total = prests.filter(p=>selPrests.includes(p.id)).reduce((s,p)=>s+p.prix,0);
        const maxPop = Math.max(...filtered.map(p => popCount[p.id] || 0), 0);
        return <div className="step">
          <button className="btn-back" onClick={()=>{
            if (SPEC_CONFIG[cat].length === 0) { setStep("categorie"); setCat(""); }
            else { setStep("specialisation"); setSpec(""); }
            setSelPrests([]);
          }}>← Retour</button>
          <h1 className="heading heading-sm">Les détails</h1>
          <p className="sub">Sélectionnez vos prestations</p>
          <div className="flex-col scroll-list" style={{gap:12}}>
            {filtered.map(p => {
              const sel = selPrests.includes(p.id);
              const pop = popCount[p.id] || 0;
              const isPopular = pop > 0 && pop >= maxPop * 0.6;
              return <div key={p.id} className={`card ${sel?'selected':''}`} onClick={()=>setSelPrests(prev=>prev.includes(p.id)?prev.filter(x=>x!==p.id):[...prev,p.id])} style={{padding:"18px 20px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                <div style={{flex:1}}>
                  <div style={{fontWeight:700,fontSize:16, display:"flex", alignItems:"center"}}>
                    {p.nom_court}
                    {isPopular && <span className="pop-badge">Top</span>}
                  </div>
                  <div style={{fontSize:14,color:"var(--text-medium)",marginTop:4}}>{p.duree_minutes} min</div>
                </div>
                <div style={{display:"flex",alignItems:"center",gap:16}}>
                  {p.prix>0 && <div className="price-tag">{p.prix}€</div>}
                  <div className={`check-box ${sel?'checked':''}`}>{sel && <span style={{color:"#FFF",fontSize:14,fontWeight:800}}>✓</span>}</div>
                </div>
              </div>;
            })}
          </div>
          {selPrests.length>0 && <div style={{position:"fixed",bottom:0,left:0,right:0,padding:"20px",background:"linear-gradient(transparent, var(--bg-warm) 30%)",paddingTop:40,display:"flex",justifyContent:"center", zIndex:10}}><div style={{width:"100%",maxWidth:500}}><button className="btn" onClick={()=>setStep("coiffeur")}>Continuer — {total}€</button></div></div>}
          {selPrests.length>0 && <div style={{height:90}}/>}
        </div>;
      };

      // ═══ COIFFEUR ═══
      const renderCoiffeur = () => {
        const specs = new Set();
        selPrests.forEach(id=>{const p=prests.find(x=>x.id===id);if(p?.specialisation_requise)specs.add(p.specialisation_requise)});
        const filtered = coifs.filter(c=>c.prenom&&c.actif!==false&&(specs.size===0||[...specs].every(s=>(c.specialisations||[]).includes(s))));
        // Palette dorée/chaude pour les avatars
        const colors = ["#B8965A", "#A08C6C", "#8C7A5E", "#D4B87A", "#C6A66D"];
        return <div className="step">
          <button className="btn-back" onClick={()=>setStep("prestation")}>← Retour</button>
          <h1 className="heading heading-sm">Avec qui ?</h1>
          <p className="sub">Choisissez votre expert</p>
          <div className="flex-col" style={{gap:12}}>
            <div className="card" onClick={()=>{setSelCoif("");setSelDate("");setSlots([]);setStep("date");setMo(0)}} style={{display:"flex",alignItems:"center",gap:16}}>
              <div className="icon-circle icon-sm" style={{background:"var(--text-dark)", color:"#FFF"}}>★</div>
              <div><div style={{fontWeight:700,fontSize:16}}>Sans préférence</div><div style={{fontSize:14,color:"var(--text-medium)",marginTop:2}}>Premier créneau disponible</div></div>
            </div>
            {filtered.map((c,i) => <div key={c.id} className="card" onClick={()=>{setSelCoif(c.id);setSelDate("");setSlots([]);setStep("date");setMo(0)}} style={{display:"flex",alignItems:"center",gap:16}}>
              <div className="icon-circle icon-sm" style={{background:colors[i%colors.length],color:"#FFF",fontWeight:700,border:"none", boxShadow:"0 4px 12px rgba(184, 150, 90, 0.3)"}}>{(c.prenom||"?")[0]}</div>
              <div><div style={{fontWeight:700,fontSize:16}}>{c.prenom}</div><div style={{fontSize:14,color:"var(--text-medium)",marginTop:2}}>{(c.specialisations||[]).join(", ")}</div></div>
            </div>)}
          </div>
        </div>;
      };

      // ═══ DATE & CRÉNEAUX ═══
      const renderDate = () => {
        const today = new Date();
        const vd = new Date(today.getFullYear(), today.getMonth()+mo, 1);
        const yr=vd.getFullYear(), mn=vd.getMonth();
        const firstDayJS = new Date(yr,mn,1).getDay();
        const fd = (firstDayJS + 6) % 7; 
        const dim = new Date(yr,mn+1,0).getDate();
        const todayStr = toDS(today);
        const cells = []; for(let i=0;i<fd;i++) cells.push(null); for(let d=1;d<=dim;d++) cells.push(d);

        const slotsForDate = slots.filter(s=>s.date===selDate);
        const grouped = {};
        slotsForDate.forEach(s => { if(!grouped[s.coiffeur_prenom]) grouped[s.coiffeur_prenom]=[]; grouped[s.coiffeur_prenom].push(s); });

        return <div className="step">
          <button className="btn-back" style={{marginBottom:16}} onClick={()=>{setStep("coiffeur");setSlots([]);setSelDate("")}}>← Retour</button>
          <h1 className="heading heading-sm">Quand ?</h1>
          <p className="sub" style={{marginBottom:24}}>Sélectionnez une date et une heure</p>
          
          <div className="cal-container">
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
              <button className="btn-back nav-month-btn" style={{margin:0}} onClick={()=>setMo(p=>Math.max(p-1,0))} disabled={mo===0}>←</button>
              <div style={{fontWeight:800,fontSize:17,letterSpacing:"-0.01em"}}>{MOIS[mn]} {yr}</div>
              <button className="btn-back nav-month-btn" style={{margin:0}} onClick={()=>setMo(p=>Math.min(p+1,2))}>→</button>
            </div>
            <div className="cal-grid">
              {JOURS_H.map(j=><div key={j} className="cal-header">{j}</div>)}
              {cells.map((day,i)=>{
                if(!day) return <div key={`e${i}`}/>;
                const ds=`${yr}-${pad(mn+1)}-${pad(day)}`;
                const dayOfWeek = new Date(yr,mn,day).getDay();
                const dis = ds<todayStr || CLOSED.includes(dayOfWeek);
                const isSel = ds===selDate;
                return <div key={i} className={`cal-day ${dis?'disabled':''} ${isSel?'sel':''}`} onClick={()=>{if(!dis){setSelDate(ds);loadSlots(ds)}}}>{day}</div>;
              })}
            </div>
          </div>

          {selDate && slotsLoading && <div className="spinner"/>}
          {selDate && !slotsLoading && slotsForDate.length===0 && <div style={{textAlign:"center",padding:"32px 16px",color:"var(--text-medium)",fontSize:15, fontWeight:500}}>Aucun créneau disponible ce jour.</div>}
          {selDate && !slotsLoading && Object.keys(grouped).length>0 && <div className="flex-col" style={{gap:24, animation:"fadeInUp 0.3s ease"}}>
            {Object.entries(grouped).map(([coif,crs])=>{
              const matin = crs.filter(s => s.heure_debut < "13:00");
              const aprem = crs.filter(s => s.heure_debut >= "13:00");
              return <div key={coif}>
                <div style={{fontSize:14,fontWeight:800,color:"var(--text-dark)",marginBottom:12,letterSpacing:"0.03em", textTransform:"uppercase"}}>{coif}</div>
                {matin.length > 0 && <>
                  <div className="period-label">Matinée</div>
                  <div className="slots-grid">{matin.map(s=><button key={`${s.coiffeur_id}-${s.heure_debut}`} className="btn-outline" onClick={()=>{setSelSlot(s);setStep("info")}}>{s.heure_debut}</button>)}</div>
                </>}
                {aprem.length > 0 && <>
                  <div className="period-label" style={{marginTop:24}}>Après-midi</div>
                  <div className="slots-grid">{aprem.map(s=><button key={`${s.coiffeur_id}-${s.heure_debut}`} className="btn-outline" onClick={()=>{setSelSlot(s);setStep("info")}}>{s.heure_debut}</button>)}</div>
                </>}
              </div>;
            })}
          </div>}
        </div>;
      };

      // ═══ INFO ═══
      const renderInfo = () => {
        const valid = form.prenom.trim() && form.nom.trim() && /^(\+?33|0)[67]\d{8}$/.test(form.telephone.replace(/\s/g,""));
        return <div className="step">
          <button className="btn-back" onClick={()=>setStep("date")}>← Retour</button>
          <h1 className="heading heading-sm">Vos coordonnées</h1>
          <p className="sub">Dernière étape avant validation</p>
          <div className="flex-col" style={{gap:24}}>
            <div><label className="label">Prénom</label><input className="input-field" value={form.prenom} onChange={e=>setForm(p=>({...p,prenom:e.target.value}))} placeholder="Jean"/></div>
            <div><label className="label">Nom</label><input className="input-field" value={form.nom} onChange={e=>setForm(p=>({...p,nom:e.target.value}))} placeholder="Dupont"/></div>
            <div><label className="label">Téléphone</label><input className="input-field" type="tel" value={form.telephone} onChange={e=>setForm(p=>({...p,telephone:e.target.value}))} placeholder="06 12 34 56 78"/></div>
          </div>
          <div style={{marginTop:40}}><button className="btn" disabled={!valid} onClick={()=>setStep("confirmation")}>Voir le récapitulatif</button></div>
        </div>;
      };

      // ═══ CONFIRMATION ═══
      const renderConfirmation = () => {
        const ps = prests.filter(p=>selPrests.includes(p.id));
        const total = ps.reduce((s,p)=>s+p.prix,0);
        const duree = ps.reduce((s,p)=>s+p.duree_minutes,0);
        return <div className="step">
          <button className="btn-back" onClick={()=>setStep("info")}>← Retour</button>
          <h1 className="heading heading-sm">Récapitulatif</h1>
          <p className="sub">Vérifiez vos informations</p>
          <div className="card" style={{padding:0}}>
            <div style={{padding:"24px", borderBottom:"var(--glass-border)"}}>
              <div className="label-up">Prestations</div>
              <div style={{marginTop:16,display:"flex",flexDirection:"column",gap:12}}>
                {ps.map(p=><div key={p.id} style={{display:"flex",justifyContent:"space-between",fontSize:16, fontWeight:500}}><span>{p.nom_court}</span><span className="price-tag">{p.prix}€</span></div>)}
              </div>
            </div>
            <div style={{padding:"24px", display:"grid", gridTemplateColumns:"1fr 1fr", gap:"24px"}}>
              <div><div className="label-up">Date</div><div style={{fontSize:16,fontWeight:700}}>{selSlot?.date ? (()=>{const d=new Date(selSlot.date+'T12:00:00');const jj=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];return jj[d.getDay()]+'. '+selSlot.date.split('-').slice(1).reverse().join('/')})() : ''}</div></div>
              <div><div className="label-up">Heure</div><div style={{fontSize:16,fontWeight:700}}>{selSlot?.heure_debut}</div></div>
              <div><div className="label-up">Coiffeur</div><div style={{fontSize:16,fontWeight:700}}>{selSlot?.coiffeur_prenom}</div></div>
              <div><div className="label-up">Durée</div><div style={{fontSize:16,fontWeight:700}}>{duree} min</div></div>
            </div>
            <div style={{padding:"24px",display:"flex",justifyContent:"space-between",alignItems:"center",background:"rgba(184, 150, 90, 0.08)"}}>
              <div style={{fontSize:16,color:"var(--text-dark)",fontWeight:600}}>{form.prenom} {form.nom}</div>
              <div style={{fontSize:32,fontWeight:800,letterSpacing:"-0.03em",color:"var(--gold-primary)"}}>{total}€</div>
            </div>
          </div>
          <div style={{marginTop:32}}><button className="btn btn-gold" disabled={bookLoading} onClick={confirmBooking}>{bookLoading?"Confirmation en cours…":"Confirmer le rendez-vous"}</button></div>
          <div style={{textAlign:"center",marginTop:16,fontSize:13,color:"var(--text-medium)", fontWeight:500}}>Paiement sur place au salon</div>
        </div>;
      };

      // ═══ SUCCESS ═══
      const renderSuccess = () => {
        const JOURS_FULL = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
        const MOIS_FULL = ['janvier','février','mars','avril','mai','juin','juillet','août','septembre','octobre','novembre','décembre'];
        let dateAffichee = booking?.rdv?.date || '';
        let heureAffichee = booking?.rdv?.heure || '';
        if (selSlot?.date) {
          const d = new Date(selSlot.date + 'T12:00:00');
          dateAffichee = JOURS_FULL[d.getDay()] + ' ' + d.getDate() + ' ' + MOIS_FULL[d.getMonth()];
        }
        if (selSlot?.heure_debut) { heureAffichee = selSlot.heure_debut.replace(':', 'h'); }
        
        return <div className="step" style={{textAlign:"center",padding:"48px 0"}}>
          <div className="success-icon">✓</div>
          <h1 className="heading" style={{fontSize:32,marginBottom:16}}>Confirmé !</h1>
          <p className="sub" style={{marginBottom:40,maxWidth:320,marginLeft:"auto",marginRight:"auto"}}>{booking?.message || "Votre rendez-vous a bien été enregistré. À bientôt au salon Maniatis !"}</p>
          <div className="card" style={{padding:"32px 24px",textAlign:"left",marginBottom:32, display:"grid", gridTemplateColumns:"1fr 1fr", gap:"24px"}}>
              <div><span className="label-up">Date</span><br/><strong style={{fontSize:16}}>{dateAffichee}</strong></div>
              <div><span className="label-up">Heure</span><br/><strong style={{fontSize:16}}>{heureAffichee}</strong></div>
              <div style={{gridColumn:"1 / -1"}}><span className="label-up">Coiffeur</span><br/><strong style={{fontSize:16}}>{selSlot?.coiffeur_prenom || booking?.rdv?.coiffeur || ''}</strong></div>
              <div style={{gridColumn:"1 / -1"}}><span className="label-up">Prestations</span><br/><strong style={{fontSize:16}}>{prests.filter(p=>selPrests.includes(p.id)).map(p=>p.nom_court).join(', ') || booking?.rdv?.prestations || ''}</strong></div>
          </div>
          <button className="btn-outline" onClick={reset} style={{display:"inline-block",width:"auto", padding:"16px 32px", fontSize:15}}>Prendre un autre rendez-vous</button>
        </div>;
      };

      return <>
        {error && <div className="error-bar"><span>{error}</span><button onClick={()=>setError(null)} style={{background:"none",border:"none",fontSize:20,cursor:"pointer",color:"inherit"}}>✕</button></div>}
        {step!=="categorie"&&step!=="success"&&<Dots current={step}/>}
        {step==="categorie"&&renderCategorie()}
        {step==="specialisation"&&renderSpecialisation()}
        {step==="prestation"&&renderPrestation()}
        {step==="coiffeur"&&renderCoiffeur()}
        {step==="date"&&renderDate()}
        {step==="info"&&renderInfo()}
        {step==="confirmation"&&renderConfirmation()}
        {step==="success"&&renderSuccess()}
      </>;
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>
