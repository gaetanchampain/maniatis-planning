<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Réserver — Salon Maniatis Paris</title>
  <link rel="icon" type="image/png" href="../Favicon_Maniatis.png" />
  <meta name="description" content="Prenez rendez-vous en ligne au salon de coiffure Maniatis, rue de Sèvres, Paris 6e" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    ::selection { background: rgba(184,150,90,0.15); color: #B8965A; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    body { font-family: 'DM Sans', sans-serif; background: #FAF8F5; color: #1C1917; min-height: 100vh; display: flex; justify-content: center; }
    #root { width: 100%; max-width: 480px; padding: 24px 20px; }
    .serif { font-family: 'Cormorant Garamond', serif; }
    .heading { font-family: 'Cormorant Garamond', serif; font-weight: 600; font-size: 28px; letter-spacing: -0.02em; line-height: 1.2; margin: 0 0 4px; }
    .heading-sm { font-size: 24px; }
    .sub { color: #78716C; font-size: 14px; margin: 0 0 24px; line-height: 1.5; }
    .card { background: #FFF; border-radius: 12px; border: 1px solid #E7E5E4; padding: 16px; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
    .card:hover { border-color: #B8965A; transform: translateY(-1px); }
    .card.selected { border-color: #B8965A; background: rgba(184,150,90,0.08); box-shadow: 0 0 0 1px #B8965A; }
    .btn { background: #1C1917; color: #FFF; border: none; border-radius: 8px; padding: 14px 28px; font-size: 15px; font-weight: 600; cursor: pointer; width: 100%; font-family: 'DM Sans', sans-serif; transition: opacity 0.2s; letter-spacing: 0.01em; }
    .btn:disabled { opacity: 0.5; cursor: default; }
    .btn-gold { background: #B8965A; }
    .btn-outline { background: transparent; color: #1C1917; border: 1px solid #E7E5E4; border-radius: 8px; padding: 10px 16px; font-size: 14px; font-weight: 500; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: all 0.15s; }
    .btn-outline:hover { background: #B8965A; color: #FFF; border-color: #B8965A; }
    .btn-back { background: none; border: none; color: #78716C; cursor: pointer; font-size: 13px; font-family: 'DM Sans', sans-serif; padding: 8px 0; margin-bottom: 20px; display: inline-flex; align-items: center; gap: 6px; }
    .input-field { width: 100%; padding: 12px 16px; border-radius: 8px; border: 1px solid #E7E5E4; font-size: 15px; font-family: 'DM Sans', sans-serif; outline: none; transition: border-color 0.2s; }
    .input-field:focus { border-color: #B8965A; }
    .label { font-size: 13px; font-weight: 600; color: #78716C; display: block; margin-bottom: 6px; }
    .label-up { font-size: 12px; font-weight: 600; color: #78716C; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 4px; }
    .dots { display: flex; gap: 6px; justify-content: center; margin-bottom: 28px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #E7E5E4; transition: all 0.3s; }
    .dot.active { background: #B8965A; width: 24px; border-radius: 4px; }
    .dot.done { background: #D4B87A; }
    .spinner { width: 32px; height: 32px; border: 3px solid #E7E5E4; border-top: 3px solid #B8965A; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 48px auto; }
    .error-bar { background: #FEF2F2; border: 1px solid #FECACA; border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; font-size: 13px; color: #991B1B; display: flex; justify-content: space-between; align-items: center; animation: fadeIn 0.3s; }
    .error-bar button { background: none; border: none; cursor: pointer; font-weight: 700; color: #991B1B; font-size: 16px; }
    .step { animation: fadeIn 0.3s ease; }
    .flex-col { display: flex; flex-direction: column; }
    .icon-circle { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .icon-sm { width: 44px; height: 44px; }
    .gold-bg { background: rgba(184,150,90,0.08); }
    .check-box { width: 22px; height: 22px; border-radius: 6px; border: 2px solid #E7E5E4; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
    .check-box.checked { border-color: #B8965A; background: #B8965A; }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; text-align: center; }
    .cal-day { padding: 6px 0; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.15s; user-select: none; }
    .cal-day:hover:not(.disabled):not(.sel) { background: rgba(184,150,90,0.08); }
    .cal-day.disabled { color: #D6D3D1; cursor: default; }
    .cal-day.sel { background: #B8965A; color: #FFF; font-weight: 700; }
    .cal-header { font-size: 10px; font-weight: 600; color: #78716C; padding: 4px 0; text-transform: uppercase; letter-spacing: 0.05em; }
    .slots-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
    .slots-grid .btn-outline { width: 100%; text-align: center; padding: 8px 0; font-size: 13px; }
    .period-label { font-size: 11px; color: #A8A29E; font-weight: 500; margin: 8px 0 4px; letter-spacing: 0.03em; display: flex; align-items: center; gap: 5px; }
    .period-label:first-child { margin-top: 0; }
    .recap-card { background: #FFF; border-radius: 12px; border: 1px solid #E7E5E4; overflow: hidden; }
    .recap-section { padding: 20px; border-bottom: 1px solid #E7E5E4; }
    .recap-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .footer { text-align: center; margin-top: 32px; padding-top: 20px; border-top: 1px solid #E7E5E4; }
    .footer-brand { font-family: 'Cormorant Garamond', serif; font-size: 14px; font-weight: 600; letter-spacing: 0.15em; color: #78716C; text-transform: uppercase; }
    .footer-addr { font-size: 12px; color: #78716C; margin-top: 4px; }
    .success-icon { width: 72px; height: 72px; border-radius: 50%; background: rgba(184,150,90,0.08); display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; font-size: 32px; color: #B8965A; }
    .scroll-list { max-height: calc(100vh - 280px); overflow-y: auto; padding: 2px; margin: -2px; }
    .spec-count { display: inline-block; background: rgba(184,150,90,0.12); color: #B8965A; font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 12px; margin-left: 8px; }
    .pop-badge { display: inline-block; background: rgba(184,150,90,0.10); color: #B8965A; font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 4px; margin-left: 6px; text-transform: uppercase; letter-spacing: 0.04em; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.3.1/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.3.1/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.24.4/babel.min.js"></script>
  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    const FIREBASE_BASE = "https://salon-maniatis-default-rtdb.europe-west1.firebasedatabase.app";
    const FIREBASE_AUTH = "fqvk01y60VO7iuj1MkFGkrofwXTa1BJuIa62R4If";
    const N8N_WEBHOOK = "https://champain.app.n8n.cloud/webhook/agent-salon-coiffure-v4";

    // Calendrier lundi-first
    const JOURS_H = ["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"];
    const MOIS = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
    const CLOSED = [0,1]; // dimanche, lundi
    const pad = n => String(n).padStart(2,"0");
    const toDS = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

    const STEPS = ["categorie","specialisation","prestation","coiffeur","date","info","confirmation","success"];

    const SPEC_CONFIG = {
      femme: [
        { id: "femme", label: "Coupe & Coiffage", desc: "Coupe, brushing, chignon, lissage…", icon: "✂" },
        { id: "coloriste", label: "Couleur & Technique", desc: "Coloration, balayage, mèches, diacolor…", icon: "✦" },
        { id: "_all", label: "Voir toutes les prestations", desc: "", icon: "☰" },
      ],
      homme: [
        { id: "homme", label: "Coupe & Coiffage", desc: "Coupe classique, coupe couture, défrisage…", icon: "✂" },
        { id: "barbier", label: "Barbe", desc: "Taille et entretien de barbe", icon: "◆" },
        { id: "coloriste", label: "Couleur", desc: "Coloration, cover…", icon: "✦" },
        { id: "_all", label: "Voir toutes les prestations", desc: "", icon: "☰" },
      ],
      enfant: []
    };

    function Dots({ current }) {
      const idx = STEPS.indexOf(current);
      return <div className="dots">{STEPS.slice(0,7).map((s,i) => <div key={s} className={`dot ${i===idx?'active':i<idx?'done':''}`}/>)}</div>;
    }

    function App() {
      const [step, setStep] = useState("categorie");
      const [prests, setPrests] = useState([]);
      const [coifs, setCoifs] = useState([]);
      const [popCount, setPopCount] = useState({}); // { PREST002: 15, PREST001: 8, ... }
      const [initLoading, setInitLoading] = useState(true);
      const [slotsLoading, setSlotsLoading] = useState(false);
      const [bookLoading, setBookLoading] = useState(false);
      const [error, setError] = useState(null);
      const [cat, setCat] = useState("");
      const [spec, setSpec] = useState("");
      const [selPrests, setSelPrests] = useState([]);
      const [selCoif, setSelCoif] = useState(null);
      const [selDate, setSelDate] = useState("");
      const [selSlot, setSelSlot] = useState(null);
      const [slots, setSlots] = useState([]);
      const [form, setForm] = useState({prenom:"",nom:"",telephone:""});
      const [booking, setBooking] = useState(null);
      const [mo, setMo] = useState(0);

      useEffect(() => {
        (async () => {
          try {
            const [pR, cR, rR] = await Promise.all([
              fetch(`${FIREBASE_BASE}/prestations.json?auth=${FIREBASE_AUTH}`),
              fetch(`${FIREBASE_BASE}/coiffeurs.json?auth=${FIREBASE_AUTH}`),
              fetch(`${FIREBASE_BASE}/rdv.json?auth=${FIREBASE_AUTH}`)
            ]);
            const pD = await pR.json(), cD = await cR.json(), rD = await rR.json();
            if (pD) setPrests(Object.entries(pD).map(([id,p])=>({id,...p})));
            if (cD) setCoifs(Object.entries(cD).map(([id,c])=>({id,...c})));

            // Comptage popularité des prestations
            if (rD && typeof rD === 'object') {
              const counts = {};
              Object.values(rD).forEach(rdv => {
                try {
                  const ids = JSON.parse(rdv.prestations_ids || '[]');
                  ids.forEach(id => { counts[id] = (counts[id] || 0) + 1; });
                } catch(e) {}
              });
              setPopCount(counts);
            }
          } catch(e) { setError("Impossible de charger les données du salon."); }
          setInitLoading(false);
        })();
      }, []);

      const loadSlots = useCallback(async (date) => {
        setSlotsLoading(true); setSlots([]);
        try {
          const r = await fetch(N8N_WEBHOOK, {method:"POST",headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
              args:{action:"get_available_slots",prestation_ids:selPrests,date_souhaitee:date,coiffeur_id:selCoif||""},
              call:{call_id:`web-${Date.now()}`}
            })});
          const d = await r.json();
          if (d.success) setSlots(d.all_creneaux || d.top_creneaux || []);
        } catch(e) { setError("Erreur lors du chargement des créneaux."); }
        setSlotsLoading(false);
      }, [selPrests, selCoif]);

      const confirmBooking = useCallback(async () => {
        setBookLoading(true);
        try {
          let phone = form.telephone.replace(/\s/g,"");
          if (phone.startsWith("0")) phone = "+33"+phone.substring(1);
          else if (!phone.startsWith("+")) phone = "+33"+phone;
          const r = await fetch(N8N_WEBHOOK, {method:"POST",headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
              args:{action:"create_booking",coiffeur_id:selSlot.coiffeur_id,prestation_ids:selPrests,date_heure:selSlot.date_heure_iso,nom:form.nom.toUpperCase(),prenom:form.prenom},
              call:{call_id:`web-${Date.now()}`,from_number:phone}
            })});
          const d = await r.json();
          if (d.success) { setBooking(d); setStep("success"); }
          else setError(d.message || "Erreur lors de la réservation.");
        } catch(e) { setError("Erreur réseau lors de la réservation."); }
        setBookLoading(false);
      }, [selSlot, selPrests, form]);

      const reset = () => { setStep("categorie"); setCat(""); setSpec(""); setSelPrests([]); setSelCoif(null); setSelDate(""); setSelSlot(null); setSlots([]); setForm({prenom:"",nom:"",telephone:""}); setBooking(null); setError(null); setMo(0); };

      const countPrestsForSpec = (specId) => {
        return prests.filter(p => p.categorie === cat && p.actif !== false && (specId === "_all" || p.specialisation_requise === specId)).length;
      };

      // Tri par popularité (nb de bookings) puis ordre_affichage en fallback
      const getFilteredPrests = () => {
        return prests
          .filter(p => p.categorie === cat && p.actif !== false && (spec === "_all" || p.specialisation_requise === spec))
          .sort((a, b) => {
            const popA = popCount[a.id] || 0;
            const popB = popCount[b.id] || 0;
            if (popB !== popA) return popB - popA; // plus booké en premier
            return (a.ordre_affichage || 99) - (b.ordre_affichage || 99);
          });
      };

      if (initLoading) return <div className="spinner"/>;

      // ═══ CATÉGORIE ═══
      const renderCategorie = () => {
        const cats = [
          {id:"femme",label:"Femme",desc:"Coupe, couleur, brushing…",icon:"✦"},
          {id:"homme",label:"Homme",desc:"Coupe, barbe, couleur…",icon:"◆"},
          {id:"enfant",label:"Enfant",desc:"Coupe enfant",icon:"○"}
        ];
        return <div className="step">
          <h1 className="heading">Réserver un rendez-vous</h1>
          <p className="sub">Salon Maniatis — rue de Sèvres, Paris 6e</p>
          <div className="flex-col" style={{gap:12}}>
            {cats.map(c => <div key={c.id} className="card" onClick={()=>{
              setCat(c.id); setSpec(""); setSelPrests([]);
              if (SPEC_CONFIG[c.id].length === 0) { setSpec("_all"); setStep("prestation"); }
              else setStep("specialisation");
            }} style={{display:"flex",alignItems:"center",gap:16}}>
              <div className="icon-circle gold-bg" style={{fontSize:18,color:"#B8965A"}}>{c.icon}</div>
              <div><div style={{fontWeight:600,fontSize:16}}>{c.label}</div><div style={{fontSize:13,color:"#78716C",marginTop:2}}>{c.desc}</div></div>
            </div>)}
          </div>
          <div className="footer"><div className="footer-brand">Maniatis Paris</div><div className="footer-addr">18 rue de Sèvres — 75007 Paris</div></div>
        </div>;
      };

      // ═══ SPÉCIALISATION ═══
      const renderSpecialisation = () => {
        const specs = SPEC_CONFIG[cat] || [];
        const catLabel = cat === "femme" ? "Femme" : cat === "homme" ? "Homme" : "Enfant";
        return <div className="step">
          <button className="btn-back" onClick={()=>{setStep("categorie");setCat("");setSpec("")}}>← Retour</button>
          <h1 className="heading heading-sm">Quel type de soin ?</h1>
          <p className="sub">Choisissez le type de prestation {catLabel.toLowerCase()}</p>
          <div className="flex-col" style={{gap:10}}>
            {specs.map(s => {
              const count = countPrestsForSpec(s.id);
              if (s.id !== "_all" && count === 0) return null;
              const totalCount = s.id === "_all" ? prests.filter(p=>p.categorie===cat&&p.actif!==false).length : count;
              return <div key={s.id} className="card" onClick={()=>{setSpec(s.id);setSelPrests([]);setStep("prestation")}} style={{display:"flex",alignItems:"center",gap:14}}>
                <div className="icon-circle icon-sm gold-bg" style={{fontSize:18,color:"#B8965A"}}>{s.icon}</div>
                <div style={{flex:1}}>
                  <div style={{fontWeight:600,fontSize:15}}>
                    {s.label}
                    <span className="spec-count">{totalCount}</span>
                  </div>
                  {s.desc && <div style={{fontSize:12,color:"#78716C",marginTop:2}}>{s.desc}</div>}
                </div>
              </div>;
            })}
          </div>
        </div>;
      };

      // ═══ PRESTATION (triées par popularité) ═══
      const renderPrestation = () => {
        const filtered = getFilteredPrests();
        const total = prests.filter(p=>selPrests.includes(p.id)).reduce((s,p)=>s+p.prix,0);
        const maxPop = Math.max(...filtered.map(p => popCount[p.id] || 0), 0);
        return <div className="step">
          <button className="btn-back" onClick={()=>{
            if (SPEC_CONFIG[cat].length === 0) { setStep("categorie"); setCat(""); }
            else { setStep("specialisation"); setSpec(""); }
            setSelPrests([]);
          }}>← Retour</button>
          <h1 className="heading heading-sm">Quelle prestation ?</h1>
          <p className="sub">Sélectionnez une ou plusieurs prestations</p>
          <div className="flex-col scroll-list" style={{gap:8}}>
            {filtered.map(p => {
              const sel = selPrests.includes(p.id);
              const pop = popCount[p.id] || 0;
              const isPopular = pop > 0 && pop >= maxPop * 0.6;
              return <div key={p.id} className={`card ${sel?'selected':''}`} onClick={()=>setSelPrests(prev=>prev.includes(p.id)?prev.filter(x=>x!==p.id):[...prev,p.id])} style={{padding:"14px 16px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                <div style={{flex:1}}>
                  <div style={{fontWeight:500,fontSize:14}}>
                    {p.nom_court}
                    {isPopular && <span className="pop-badge">Populaire</span>}
                  </div>
                  <div style={{fontSize:12,color:"#78716C",marginTop:2}}>{p.duree_minutes} min</div>
                </div>
                <div style={{display:"flex",alignItems:"center",gap:12}}>
                  {p.prix>0 && <div style={{fontWeight:600,fontSize:14,color:"#B8965A"}}>{p.prix}€</div>}
                  <div className={`check-box ${sel?'checked':''}`}>{sel && <span style={{color:"#FFF",fontSize:13,fontWeight:700}}>✓</span>}</div>
                </div>
              </div>;
            })}
          </div>
          {selPrests.length>0 && <div style={{position:"fixed",bottom:0,left:0,right:0,padding:"12px 20px",background:"linear-gradient(transparent, #FAF8F5 30%)",paddingTop:24,display:"flex",justifyContent:"center"}}><div style={{width:"100%",maxWidth:480}}><button className="btn" onClick={()=>setStep("coiffeur")}>Continuer — {total}€</button></div></div>}
          {selPrests.length>0 && <div style={{height:70}}/>}
        </div>;
      };

      // ═══ COIFFEUR ═══
      const renderCoiffeur = () => {
        const specs = new Set();
        selPrests.forEach(id=>{const p=prests.find(x=>x.id===id);if(p?.specialisation_requise)specs.add(p.specialisation_requise)});
        const filtered = coifs.filter(c=>c.prenom&&c.actif!==false&&(specs.size===0||[...specs].every(s=>(c.specialisations||[]).includes(s))));
        const colors = ["#B8965A","#8B7355","#6B8E8E","#9B7CB8","#CB8E6B"];
        return <div className="step">
          <button className="btn-back" onClick={()=>setStep("prestation")}>← Retour</button>
          <h1 className="heading heading-sm">Avec qui ?</h1>
          <p className="sub">Choisissez votre coiffeur ou laissez-nous choisir</p>
          <div className="flex-col" style={{gap:10}}>
            <div className="card" onClick={()=>{setSelCoif("");setSelDate("");setSlots([]);setStep("date");setMo(0)}} style={{display:"flex",alignItems:"center",gap:14}}>
              <div className="icon-circle icon-sm gold-bg" style={{fontSize:18}}>★</div>
              <div><div style={{fontWeight:600,fontSize:15}}>Sans préférence</div><div style={{fontSize:12,color:"#78716C"}}>Premier créneau disponible</div></div>
            </div>
            {filtered.map((c,i) => <div key={c.id} className="card" onClick={()=>{setSelCoif(c.id);setSelDate("");setSlots([]);setStep("date");setMo(0)}} style={{display:"flex",alignItems:"center",gap:14}}>
              <div className="icon-circle icon-sm" style={{background:colors[i%colors.length],color:"#FFF",fontWeight:700,fontSize:16,fontFamily:"'Cormorant Garamond', serif"}}>{(c.prenom||"?")[0]}</div>
              <div><div style={{fontWeight:600,fontSize:15}}>{c.prenom}</div><div style={{fontSize:12,color:"#78716C"}}>{(c.specialisations||[]).join(", ")}</div></div>
            </div>)}
          </div>
        </div>;
      };

      // ═══ DATE & CRÉNEAUX ═══
      const renderDate = () => {
        const today = new Date();
        const vd = new Date(today.getFullYear(), today.getMonth()+mo, 1);
        const yr=vd.getFullYear(), mn=vd.getMonth();
        const firstDayJS = new Date(yr,mn,1).getDay();
        const fd = (firstDayJS + 6) % 7; // lundi = 0
        const dim = new Date(yr,mn+1,0).getDate();
        const todayStr = toDS(today);
        const cells = []; for(let i=0;i<fd;i++) cells.push(null); for(let d=1;d<=dim;d++) cells.push(d);

        const slotsForDate = slots.filter(s=>s.date===selDate);
        const grouped = {};
        slotsForDate.forEach(s => { if(!grouped[s.coiffeur_prenom]) grouped[s.coiffeur_prenom]=[]; grouped[s.coiffeur_prenom].push(s); });

        return <div className="step">
          <button className="btn-back" style={{marginBottom:12}} onClick={()=>{setStep("coiffeur");setSlots([]);setSelDate("")}}>← Retour</button>
          <h1 className="heading heading-sm">Quand ?</h1>
          <p className="sub" style={{marginBottom:12}}>Sélectionnez une date puis un créneau</p>
          <div style={{background:"#FFF",borderRadius:12,border:"1px solid #E7E5E4",padding:"12px 14px",marginBottom:12}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
              <button className="btn-back" style={{margin:0}} onClick={()=>setMo(p=>Math.max(p-1,0))} disabled={mo===0}>←</button>
              <div className="serif" style={{fontWeight:600,fontSize:17}}>{MOIS[mn]} {yr}</div>
              <button className="btn-back" style={{margin:0}} onClick={()=>setMo(p=>Math.min(p+1,2))}>→</button>
            </div>
            <div className="cal-grid">
              {JOURS_H.map(j=><div key={j} className="cal-header">{j}</div>)}
              {cells.map((day,i)=>{
                if(!day) return <div key={`e${i}`}/>;
                const ds=`${yr}-${pad(mn+1)}-${pad(day)}`;
                const dayOfWeek = new Date(yr,mn,day).getDay();
                const dis = ds<todayStr || CLOSED.includes(dayOfWeek);
                const isSel = ds===selDate;
                return <div key={i} className={`cal-day ${dis?'disabled':''} ${isSel?'sel':''}`} onClick={()=>{if(!dis){setSelDate(ds);loadSlots(ds)}}}>{day}</div>;
              })}
            </div>
          </div>
          {selDate && slotsLoading && <div className="spinner"/>}
          {selDate && !slotsLoading && slotsForDate.length===0 && <div style={{textAlign:"center",padding:"32px 16px",color:"#78716C",fontSize:14}}>Aucun créneau disponible ce jour. Essayez une autre date.</div>}
          {selDate && !slotsLoading && Object.keys(grouped).length>0 && <div className="flex-col" style={{gap:20}}>
            {Object.entries(grouped).map(([coif,crs])=>{
              const matin = crs.filter(s => s.heure_debut < "13:00");
              const aprem = crs.filter(s => s.heure_debut >= "13:00");
              return <div key={coif}>
                <div style={{fontSize:13,fontWeight:600,color:"#78716C",marginBottom:4,textTransform:"uppercase",letterSpacing:"0.05em"}}>{coif}</div>
                {matin.length > 0 && <>
                  <div className="period-label">Matinée</div>
                  <div className="slots-grid">{matin.map(s=><button key={`${s.coiffeur_id}-${s.heure_debut}`} className="btn-outline" onClick={()=>{setSelSlot(s);setStep("info")}}>{s.heure_debut}</button>)}</div>
                </>}
                {aprem.length > 0 && <>
                  <div className="period-label">Après-midi</div>
                  <div className="slots-grid">{aprem.map(s=><button key={`${s.coiffeur_id}-${s.heure_debut}`} className="btn-outline" onClick={()=>{setSelSlot(s);setStep("info")}}>{s.heure_debut}</button>)}</div>
                </>}
              </div>;
            })}
          </div>}
        </div>;
      };

      // ═══ INFO ═══
      const renderInfo = () => {
        const valid = form.prenom.trim() && form.nom.trim() && /^(\+?33|0)[67]\d{8}$/.test(form.telephone.replace(/\s/g,""));
        return <div className="step">
          <button className="btn-back" onClick={()=>setStep("date")}>← Retour</button>
          <h1 className="heading heading-sm">Vos coordonnées</h1>
          <p className="sub">Pour confirmer votre rendez-vous</p>
          <div className="flex-col" style={{gap:14}}>
            <div><label className="label">Prénom</label><input className="input-field" value={form.prenom} onChange={e=>setForm(p=>({...p,prenom:e.target.value}))} placeholder="Votre prénom"/></div>
            <div><label className="label">Nom</label><input className="input-field" value={form.nom} onChange={e=>setForm(p=>({...p,nom:e.target.value}))} placeholder="Votre nom"/></div>
            <div><label className="label">Téléphone</label><input className="input-field" type="tel" value={form.telephone} onChange={e=>setForm(p=>({...p,telephone:e.target.value}))} placeholder="06 12 34 56 78"/></div>
          </div>
          <div style={{marginTop:24}}><button className="btn" disabled={!valid} onClick={()=>setStep("confirmation")}>Voir le récapitulatif</button></div>
        </div>;
      };

      // ═══ CONFIRMATION ═══
      const renderConfirmation = () => {
        const ps = prests.filter(p=>selPrests.includes(p.id));
        const total = ps.reduce((s,p)=>s+p.prix,0);
        const duree = ps.reduce((s,p)=>s+p.duree_minutes,0);
        return <div className="step">
          <button className="btn-back" onClick={()=>setStep("info")}>← Retour</button>
          <h1 className="heading heading-sm">Récapitulatif</h1>
          <p className="sub">Vérifiez les détails de votre rendez-vous</p>
          <div className="recap-card">
            <div className="recap-section">
              <div className="label-up">Prestations</div>
              {ps.map(p=><div key={p.id} style={{display:"flex",justifyContent:"space-between",fontSize:14,padding:"4px 0"}}><span>{p.nom_court}</span><span style={{fontWeight:600}}>{p.prix}€</span></div>)}
            </div>
            <div className="recap-section recap-grid">
              <div><div className="label-up">Date</div><div style={{fontSize:15,fontWeight:500}}>{selSlot?.date ? (()=>{const d=new Date(selSlot.date+'T12:00:00');const jj=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];return jj[d.getDay()]+'. '+selSlot.date.split('-').slice(1).reverse().join('/')})() : ''}</div></div>
              <div><div className="label-up">Heure</div><div style={{fontSize:15,fontWeight:500}}>{selSlot?.heure_debut}</div></div>
              <div><div className="label-up">Coiffeur</div><div style={{fontSize:15,fontWeight:500}}>{selSlot?.coiffeur_prenom}</div></div>
              <div><div className="label-up">Durée</div><div style={{fontSize:15,fontWeight:500}}>{duree} min</div></div>
            </div>
            <div style={{padding:20,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
              <div style={{fontSize:14,color:"#78716C"}}>{form.prenom} {form.nom}</div>
              <div className="serif" style={{fontSize:24,fontWeight:700,color:"#B8965A"}}>{total}€</div>
            </div>
          </div>
          <div style={{marginTop:24}}><button className="btn btn-gold" disabled={bookLoading} onClick={confirmBooking}>{bookLoading?"Confirmation en cours…":"Confirmer le rendez-vous"}</button></div>
          <div style={{textAlign:"center",marginTop:12,fontSize:12,color:"#78716C"}}>Paiement sur place au salon</div>
        </div>;
      };

      // ═══ SUCCESS ═══
      const renderSuccess = () => {
        // Formater date/heure depuis selSlot (plus fiable que la réponse workflow)
        const JOURS_FULL = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
        const MOIS_FULL = ['janvier','février','mars','avril','mai','juin','juillet','août','septembre','octobre','novembre','décembre'];
        let dateAffichee = booking?.rdv?.date || '';
        let heureAffichee = booking?.rdv?.heure || '';
        if (selSlot?.date) {
          const d = new Date(selSlot.date + 'T12:00:00');
          dateAffichee = JOURS_FULL[d.getDay()] + ' ' + d.getDate() + ' ' + MOIS_FULL[d.getMonth()];
        }
        if (selSlot?.heure_debut) {
          heureAffichee = selSlot.heure_debut.replace(':', 'h');
        }
        return <div className="step" style={{textAlign:"center",padding:"32px 0"}}>
          <div className="success-icon">✓</div>
          <h1 className="heading" style={{fontSize:26,marginBottom:12}}>Rendez-vous confirmé</h1>
          <p className="sub" style={{marginBottom:32,maxWidth:320,marginLeft:"auto",marginRight:"auto"}}>{booking?.message || "Votre rendez-vous a bien été enregistré. À bientôt au salon Maniatis !"}</p>
          <div style={{background:"#FFF",borderRadius:12,border:"1px solid #E7E5E4",padding:20,textAlign:"left",marginBottom:24}}>
            <div className="recap-grid" style={{fontSize:14}}>
              <div><span style={{color:"#78716C"}}>Date</span><br/><strong>{dateAffichee}</strong></div>
              <div><span style={{color:"#78716C"}}>Heure</span><br/><strong>{heureAffichee}</strong></div>
              <div><span style={{color:"#78716C"}}>Coiffeur</span><br/><strong>{selSlot?.coiffeur_prenom || booking?.rdv?.coiffeur || ''}</strong></div>
              <div><span style={{color:"#78716C"}}>Prestations</span><br/><strong>{prests.filter(p=>selPrests.includes(p.id)).map(p=>p.nom_court).join(', ') || booking?.rdv?.prestations || ''}</strong></div>
            </div>
          </div>
          <button className="btn-outline" onClick={reset} style={{display:"inline-block",width:"auto"}}>Prendre un autre rendez-vous</button>
        </div>;
      };

      return <>
        {error && <div className="error-bar"><span>{error}</span><button onClick={()=>setError(null)}>✕</button></div>}
        {step!=="categorie"&&step!=="success"&&<Dots current={step}/>}
        {step==="categorie"&&renderCategorie()}
        {step==="specialisation"&&renderSpecialisation()}
        {step==="prestation"&&renderPrestation()}
        {step==="coiffeur"&&renderCoiffeur()}
        {step==="date"&&renderDate()}
        {step==="info"&&renderInfo()}
        {step==="confirmation"&&renderConfirmation()}
        {step==="success"&&renderSuccess()}
      </>;
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>
